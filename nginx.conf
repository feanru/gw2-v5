http {
    types {
        include mime.types;
        application/javascript js mjs;
    }

    server {
        listen 80;
        server_name example.com;
        root /var/www/gw2/current;

        # Política de íconos: los íconos se descargan desde la CDN de ArenaNet
        # o pueden servirse desde este servidor ajustando las URLs.

        # Serve web workers without SPA fallback
        location ^~ /dist/js/workers/ {
            try_files $uri =404;
            default_type application/javascript;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # Return 404 for missing files under /dist/js
        location ^~ /dist/js/ {
            try_files $uri =404;
            default_type application/javascript;
            error_page 404 = @js404;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        location @js404 {
            add_header Content-Type application/javascript;
            return 404 "";
        }

        # Serve service worker directly without SPA fallback
        location = /service-worker.min.js {
            try_files $uri =404;
            default_type application/javascript;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # Bundled assets are versioned; allow long-term caching
        location ~* \.(js|css|png|mp4)$ {
            add_header Cache-Control "public, max-age=31536000, immutable";
            expires 1y;
        }

        # Route recipe tree API through Node service
        location /recipe-tree/ {
            proxy_pass http://localhost:<puerto>/backend/api/recipeTree.js;
        }

        # SPA fallback for other routes
        location / {
            add_header Cache-Control "no-cache";
            try_files $uri $uri/ /index.html;
        }
    }
}
