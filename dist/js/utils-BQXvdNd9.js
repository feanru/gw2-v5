import{c as e}from"./services-Bc-4z6yK.js";const t=[];function n(){const e=Date.now()-6e4;for(;t.length&&t[0]<e;)t.shift()}function o(){n();const e=t.length;return e>5?"down":e>0?"slow":"ok"}let r;function s(){if("undefined"==typeof document)return;const e=o();r||(r=document.createElement("div"),r.id="api-status-indicator",r.style.position="fixed",r.style.bottom="10px",r.style.right="10px",r.style.padding="4px 8px",r.style.background="rgba(0,0,0,0.7)",r.style.color="#fff",r.style.borderRadius="4px",r.style.zIndex="10000",r.style.display="none",document.body.appendChild(r)),"ok"===e?r.style.display="none":(r.textContent="slow"===e?"API lenta":"API ca√≠da",r.style.display="block")}var i={recordFailure:function(){t.push(Date.now()),n(),s()},recordSuccess:function(){n(),s()},getState:o,getBackoff:function(){const e=o();return"down"===e?5e3:"slow"===e?1e3:0}};async function a(e,t={}){const{timeout:n=8e3,retries:o=3,backoff:r=300,signal:s,...a}=t;for(let t=0;t<=o;t++){const c=new AbortController,l=setTimeout(()=>c.abort(),n);s&&(s.aborted?c.abort():s.addEventListener("abort",()=>c.abort(),{once:!0}));try{const t=await fetch(e,{...a,signal:c.signal});return clearTimeout(l),i.recordSuccess(),t}catch(e){if(clearTimeout(l),i.recordFailure(),s?.aborted||t===o)throw e;const n=r*Math.pow(2,t);await new Promise(e=>setTimeout(e,n))}}}const c={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},l="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let u=null;function f(e){l&&l.postMessage({type:"delete",key:e})}const d=new Map;!function(e){u=e,l&&l.addEventListener("message",({data:e})=>{const{type:t,key:n,entry:o}=e||{};if("request-bundles"!==t)t&&n&&("set"===t&&o?u.set(n,o):"delete"===t&&u.delete(n));else{if(!u)return;u.forEach((e,t)=>{t.startsWith("bundle_")&&l.postMessage({type:"set",key:t,entry:e})})}})}(d),l&&l.postMessage({type:"request-bundles"});const g="undefined"!=typeof localStorage,p=new Map;function h(e){try{return JSON.parse(e)}catch{return null}}function y(e,t){if(g)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:n,lastModified:o}){return JSON.stringify({value:e,expiresAt:t,etag:n,lastModified:o})}(t))}catch{}}function m(e,t,n=void 0,o={}){if(void 0===n){const t=e.split("_")[0];n=c[t]}const r=null==n?null:Date.now()+n,{etag:s=null,lastModified:i=null}=o,a={value:t,expiresAt:r,updatedAt:(new Date).toISOString(),etag:s,lastModified:i};d.set(e,a),y(e,{value:t,expiresAt:r,etag:s,lastModified:i}),function(e,t){l&&l.postMessage({type:"set",key:e,entry:t})}(e,a)}function w(e,t=!1){let n=d.get(e);if(!n){const t=function(e){if(!g)return null;const t=localStorage.getItem(e);if(!t)return null;const n=h(t);return n||(localStorage.removeItem(e),null)}(e);if(t){const{value:o,expiresAt:r=null,etag:s=null,lastModified:i=null}=t;n={value:o,expiresAt:r,updatedAt:(new Date).toISOString(),etag:s,lastModified:i},d.set(e,n)}}return n?n.expiresAt&&Date.now()>n.expiresAt?(d.delete(e),g&&localStorage.removeItem(e),f(e),null):t?n:n.value:null}function S(e,t={}){const n=function(e,{method:t="GET",headers:n={}}={}){return`${e}|${t.toUpperCase()}|${JSON.stringify(n)}`}(e,t);if(p.has(n))return p.get(n);const o=a(e,t).finally(()=>p.delete(n));return p.set(n,o),o}!function(){if(!g)return;const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t),o=h(localStorage.getItem(n));if(!o)continue;const{expiresAt:r}=o;r&&Date.now()>r&&e.push(n)}e.forEach(e=>{localStorage.removeItem(e),f(e)})}();const b=new Map;function v(){return"sessionStorage"===e?.priceCacheStrategy}function M(e){return`price_${e}`}function _(e){if(!v()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(M(e));if(!t)return null;try{const{value:n,expires:o}=JSON.parse(t);return o&&Date.now()>o?(sessionStorage.removeItem(M(e)),null):n}catch{return sessionStorage.removeItem(M(e)),null}}async function I(t=[]){const n=new Map,o=[];if(t.forEach(e=>{if(e=Number(e),b.has(e))return void n.set(e,b.get(e));const t=_(e);t?(b.set(e,t),n.set(e,t)):o.push(e)}),o.length)try{const t=await async function(t){if(!Array.isArray(t)||0===t.length)return new Map;if("redis"===e?.priceCacheStrategy){const e=`/backend/api/itemBundle.php?ids=${t.join(",")}`,n=await fetch(e);if(!n.ok)throw new Error("Price fetch failed");const o=await n.json(),r=new Map;return o.forEach(e=>{const t=e.market||{};r.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),r}{const e=`https://api.datawars2.ie/gw2/v1/items/csv?fields=${["id","buy_price","sell_price"].join(",")}&ids=${t.join(",")}`,n=await fetch(e);if(!n.ok)throw new Error("Price fetch failed");const o=(await n.text()).trim().split("\n"),r=o[0].split(","),s=new Map;for(let e=1;e<o.length;e++){if(!o[e])continue;const t=o[e].split(","),n={};r.forEach((e,o)=>{const r=t[o];n[e]=void 0!==r?isNaN(r)?r:Number(r):null}),null!=n.id&&s.set(n.id,{buy_price:n.buy_price||0,sell_price:n.sell_price||0})}return s}}(o);t.forEach((e,t)=>{b.set(t,e),function(e,t){if(v()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(M(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(t,e),n.set(t,e)})}catch(e){console.error("Error preloading prices",e)}return t.forEach(e=>{e=Number(e),!n.has(e)&&b.has(e)&&n.set(e,b.get(e)),n.has(e)||n.set(e,{buy_price:0,sell_price:0})}),n}async function A(e){if(e=Number(e),b.has(e))return b.get(e);const t=_(e);if(t)return b.set(e,t),t;return(await I([e])).get(e)}function E(){if(b.clear(),v()&&"undefined"!=typeof sessionStorage)for(let e=sessionStorage.length-1;e>=0;e--){const t=sessionStorage.key(e);t&&t.startsWith("price_")&&sessionStorage.removeItem(t)}}var x=Object.freeze({__proto__:null,clearCache:E,getPrice:A,preloadPrices:I});function k(e=[],t,n=6e4){if(!Array.isArray(e)||0===e.length)return()=>{};let o=!1;return async function r(){if(o)return;const s=i.getBackoff();s&&await new Promise(e=>setTimeout(e,s));try{const n=await I(e);"function"==typeof t&&t(n)}catch(e){i.recordFailure()}o||setTimeout(r,n)}(),()=>{o=!0}}const N=`${e.API_BASE_URL}/items?ids=`,$=`&lang=${e.LANG}`,O=new Set,P=new Map;let T=null,C=null;function j(e){if(1!==e.length)return{};const t=w(`item_${e[0]}`,!0);if(!t)return{};const n={};return t.etag&&(n["If-None-Match"]=t.etag),t.lastModified&&(n["If-Modified-Since"]=t.lastModified),n}function D(){T||(T=setTimeout(B,50)),O.size>=200&&(clearTimeout(T),B())}async function B(){if(0===O.size)return void(T=null);T=null;const e=Array.from(O).slice(0,200);e.forEach(e=>O.delete(e));try{const t=i.getBackoff();t&&await new Promise(e=>setTimeout(e,t)),C=new AbortController;const n=await a(N+e.join(",")+$,{headers:j(e),signal:C.signal,backoff:300+t});if(304===n.status)return void e.forEach(e=>{const t=P.get(e),n=w(`item_${e}`);t&&t.resolve(n),P.delete(e)});const o=n.headers.get("ETag"),r=n.headers.get("Last-Modified"),s=await n.json(),c=new Map(s.map(e=>[e.id,e]));e.forEach(e=>{const t=P.get(e),n=c.get(e);n?(m(`item_${e}`,n,void 0,{etag:o,lastModified:r}),t.resolve(n)):t.resolve(null),P.delete(e)})}catch(t){e.forEach(e=>{const n=P.get(e);n&&(t instanceof DOMException&&t.name,n.reject(t)),P.delete(e)})}O.size>0&&D()}function z(e=[],t){C&&(C.abort(),C=null);const n=e.map(e=>{const t=w(`item_${e}`);if(t)return Promise.resolve(t);if(P.has(e))return P.get(e).promise;const n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),P.set(e,n),O.add(e),D(),n.promise});return Promise.all(n)}!function(){if("undefined"!=typeof localStorage)for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t.startsWith("item_")&&w(t)}}();const J=new Map;function L(e,t={},n=null,o=null,r){const s=J.get(e);s&&s.controller?.abort(),n&&!o&&(o=w(n,!0));const i={...t.headers||{}};o?.etag&&(i["If-None-Match"]=o.etag),o?.lastModified&&(i["If-Modified-Since"]=o.lastModified);const c=r?null:new AbortController,l=r??t.signal??c?.signal;return function(e,t,n){return J.set(e,{promise:t,controller:n}),t.finally(()=>J.delete(e)),t}(e,a(e,{...t,headers:i,signal:l}).then(async e=>304===e.status&&o?new Response(JSON.stringify(o.value),{status:200,headers:{"X-Cache":"HIT",ETag:o.etag||"","Last-Modified":o.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),c).then(e=>e.clone())}const q=new Map,F=new Map,R=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.dataset.stateId;if(t&&(F.set(t,e.isIntersecting),e.isIntersecting)){const n=q.get(t),o=e.target._pendingState;n&&o&&(n(o),e.target._pendingState=null)}})});var W=Object.freeze({__proto__:null,register:function(e,t,n){t.dataset.stateId=e,q.set(e,n),R.observe(t)},update:function(e,t){const n=document.querySelector(`[data-state-id="${e}"]`);if(n)if(F.get(String(e))){const n=q.get(String(e));n&&n(t)}else n._pendingState=t}});export{L as a,A as b,E as c,S as d,k as e,a as f,w as g,x as h,W as i,I as p,z as r,m as s};
