async function e(e,t={}){const{timeout:n=8e3,retries:i=3,backoff:r=300,signal:o,...a}=t;for(let t=0;t<=i;t++){const l=new AbortController,s=setTimeout(()=>l.abort(),n);o&&(o.aborted?l.abort():o.addEventListener("abort",()=>l.abort(),{once:!0}));try{const t=await fetch(e,{...a,signal:l.signal});return clearTimeout(s),t}catch(e){if(clearTimeout(s),o?.aborted||t===i)throw e;const n=r*Math.pow(2,t);await new Promise(e=>setTimeout(e,n))}}}const t={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},n="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let i=null;function r(e){n&&n.postMessage({type:"delete",key:e})}const o=new Map;!function(e){i=e,n&&n.addEventListener("message",({data:e})=>{const{type:t,key:r,entry:o}=e||{};if("request-bundles"!==t)t&&r&&("set"===t&&o?i.set(r,o):"delete"===t&&i.delete(r));else{if(!i)return;i.forEach((e,t)=>{t.startsWith("bundle_")&&n.postMessage({type:"set",key:t,entry:e})})}})}(o),n&&n.postMessage({type:"request-bundles"});const a="undefined"!=typeof localStorage,l=new Map;function s(e){try{return JSON.parse(e)}catch{return null}}function d(e,t){if(a)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:n,lastModified:i}){return JSON.stringify({value:e,expiresAt:t,etag:n,lastModified:i})}(t))}catch{}}function c(e,i,r=void 0,a={}){if(void 0===r){const n=e.split("_")[0];r=t[n]}const l=null==r?null:Date.now()+r,{etag:s=null,lastModified:c=null}=a,u={value:i,expiresAt:l,updatedAt:(new Date).toISOString(),etag:s,lastModified:c};o.set(e,u),d(e,{value:i,expiresAt:l,etag:s,lastModified:c}),function(e,t){n&&n.postMessage({type:"set",key:e,entry:t})}(e,u)}function u(e,t=!1){let n=o.get(e);if(!n){const t=function(e){if(!a)return null;const t=localStorage.getItem(e);if(!t)return null;const n=s(t);return n||(localStorage.removeItem(e),null)}(e);if(t){const{value:i,expiresAt:r=null,etag:a=null,lastModified:l=null}=t;n={value:i,expiresAt:r,updatedAt:(new Date).toISOString(),etag:a,lastModified:l},o.set(e,n)}}return n?n.expiresAt&&Date.now()>n.expiresAt?(o.delete(e),a&&localStorage.removeItem(e),r(e),null):t?n:n.value:null}function f(t,n={}){const i=function(e,{method:t="GET",headers:n={}}={}){return`${e}|${t.toUpperCase()}|${JSON.stringify(n)}`}(t,n);if(l.has(i))return l.get(i);const r=e(t,n).finally(()=>l.delete(i));return l.set(i,r),r}!function(){if(!a)return;const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t),i=s(localStorage.getItem(n));if(!i)continue;const{expiresAt:r}=i;r&&Date.now()>r&&e.push(n)}e.forEach(e=>{localStorage.removeItem(e),r(e)})}();const w=new Set,p=new Map;let g=null,h=null;function m(e){if(1!==e.length)return{};const t=u(`item_${e[0]}`,!0);if(!t)return{};const n={};return t.etag&&(n["If-None-Match"]=t.etag),t.lastModified&&(n["If-Modified-Since"]=t.lastModified),n}function y(){g||(g=setTimeout(_,50)),w.size>=200&&(clearTimeout(g),_())}async function _(){if(0===w.size)return void(g=null);g=null;const t=Array.from(w).slice(0,200);t.forEach(e=>w.delete(e));try{h=new AbortController;const n=await e("https://api.guildwars2.com/v2/items?ids="+t.join(",")+"&lang=es",{headers:m(t),signal:h.signal});if(304===n.status)return void t.forEach(e=>{const t=p.get(e),n=u(`item_${e}`);t&&t.resolve(n),p.delete(e)});const i=n.headers.get("ETag"),r=n.headers.get("Last-Modified"),o=await n.json(),a=new Map(o.map(e=>[e.id,e]));t.forEach(e=>{const t=p.get(e),n=a.get(e);n?(c(`item_${e}`,n,void 0,{etag:i,lastModified:r}),t.resolve(n)):t.resolve(null),p.delete(e)})}catch(e){t.forEach(t=>{const n=p.get(t);n&&(e instanceof DOMException&&e.name,n.reject(e)),p.delete(t)})}w.size>0&&y()}function b(e=[],t){h&&(h.abort(),h=null);const n=e.map(e=>{const t=u(`item_${e}`);if(t)return Promise.resolve(t);if(p.has(e))return p.get(e).promise;const n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),p.set(e,n),w.add(e),y(),n.promise});return Promise.all(n)}!function(){if("undefined"!=typeof localStorage)for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t.startsWith("item_")&&u(t)}}();const v=new Map;function S(t,n={},i=null,r=null,o){const a=v.get(t);a&&a.controller?.abort(),i&&!r&&(r=u(i,!0));const l={...n.headers||{}};r?.etag&&(l["If-None-Match"]=r.etag),r?.lastModified&&(l["If-Modified-Since"]=r.lastModified);const s=o?null:new AbortController,d=o??n.signal??s?.signal;return function(e,t,n){return v.set(e,{promise:t,controller:n}),t.finally(()=>v.delete(e)),t}(t,e(t,{...n,headers:l,signal:d}).then(async e=>304===e.status&&r?new Response(JSON.stringify(r.value),{status:200,headers:{"X-Cache":"HIT",ETag:r.etag||"","Last-Modified":r.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),s).then(e=>e.clone())}function I(e=[],{interval:t=6e4,concurrency:n=5,maxRetries:i=3,onUpdate:r=()=>{}}={}){let o=Array.from(new Set(e)),a=null;function l(){a&&(clearInterval(a),a=null)}function s(){o.length>0&&("undefined"==typeof document||!document.hidden)?(a||(a=setInterval(u,t)),u()):l()}async function d(e,t,n=500){try{return await F(e)}catch(i){if(t<=0)throw i;return await new Promise(e=>setTimeout(e,n)),d(e,t-1,2*n)}}async function c(e){for(;e.length;){const t=e.shift();try{const e=await d(t,i);r(t,e)}catch(e){console.error("Price update failed for",t,e)}}}function u(){const e=o.slice(),t=Math.min(n,e.length);for(let n=0;n<t;n++)c(e)}return document.addEventListener("visibilitychange",s),s(),{updateIds(e=[]){o=Array.from(new Set(e)),s()},stop(){l(),document.removeEventListener("visibilitychange",s)}}}var M=Object.freeze({__proto__:null,startPriceUpdater:I});function E(e){window.ingredientObjs=e}"undefined"!=typeof window&&(window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1,window._mainBuyPrice=window._mainBuyPrice||0,window._mainSellPrice=window._mainSellPrice||0,window._mainRecipeOutputCount=window._mainRecipeOutputCount||1);class O{constructor({id:e,name:t,icon:n,rarity:i,count:r,parentMultiplier:o=1,buy_price:a,sell_price:l,is_craftable:s,recipe:d,children:c=[],_parentId:u=null}){this._uid=O.nextUid++,this.id=e,this.name=t,this.icon=n,this.rarity=i,this.count=r,this.parentMultiplier=o||1,this.buy_price=a,this.sell_price=l,this.is_craftable=s,this.recipe=d||null,this.children=c,this.mode="buy",this.modeForParentCrafted="buy",this.expanded=!1,this._parentId=u,this._parent=null,this.countTotal=0,this.crafted_price=null,this.total_buy=0,this.total_sell=0,this.total_crafted=0}findRoot(){let e=this;for(;e._parent;)e=e._parent;return e}setMode(e){if(["buy","sell","crafted"].includes(e)){this.modeForParentCrafted=e;this.findRoot().recalc(window.globalQty||1,null),"function"==typeof window.safeRenderTable&&window.safeRenderTable()}}recalc(e=1,t=null){const n=null==t;this.countTotal=n?this.count*e:t.countTotal*this.count,this.children&&this.children.length>0&&this.children.forEach(t=>t.recalc(e,this)),n?(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0)):(this.total_buy=(this.buy_price||0)*this.countTotal,this.total_sell=(this.sell_price||0)*this.countTotal),this.is_craftable&&this.children.length>0?(this.total_crafted=this.children.reduce((e,t)=>{switch(t.modeForParentCrafted){case"buy":default:return e+(t.total_buy||0);case"sell":return e+(t.total_sell||0);case"crafted":return e+(t.total_crafted||0)}},0),this.crafted_price=this.total_crafted/(this.recipe?.output_item_count||1),n||this.buy_price||this.sell_price||(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0))):(this.total_crafted=null,this.crafted_price=null)}getBestPrice(){return"number"==typeof this.buy_price&&this.buy_price>0?this.buy_price:"number"==typeof this.crafted_price&&this.crafted_price>0?this.crafted_price:0}}function T(e){window.globalQty=e}function j(e){return e?e.map(e=>({id:e.id,expanded:e.expanded,children:j(e.children||[])})):[]}function P(e,t){if(e&&t)for(let n=0;n<e.length;n++)t[n]&&(e[n].expanded=t[n].expanded,P(e[n].children,t[n].children))}function A(e,t){e&&e.forEach(e=>{e.recalc(t,null)})}function C(e){let t=0,n=0,i=0;for(const r of e)switch(t+=r.total_buy||0,n+=r.total_sell||0,r.modeForParentCrafted){case"sell":i+=r.total_sell||0;break;case"crafted":i+=r.total_crafted||0;break;default:i+=r.total_buy||0}return{totalBuy:t,totalSell:n,totalCrafted:i}}function x(e,t,n){for(const i of e){if(String(i.id)===String(t)&&String(i._parentId)===String(n))return i;if(Array.isArray(i.children)&&i.children.length){const e=x(i.children,t,n);if(e)return e}}return null}function k(e,t){let n=e,i=null;for(let e=0;e<t.length;e++){const r=t[e];if(i=(n||[]).find(e=>String(e._uid)===String(r)||String(e.id)===String(r)),!i)return null;n=i.children}return i}function R(e,t){for(const n of e){if(String(n._uid)===String(t))return n;if(n.children&&n.children.length){const e=R(n.children,t);if(e)return e}}return null}function U(e,t){for(const n of e){if(String(n.id)===String(t))return n;if(n.children&&n.children.length){const e=U(n.children,t);if(e)return e}}return null}O.nextUid=0;const $=new Set;function N(e){return $.add(e),e}async function B(e){const t=N(new AbortController),n=`item_${e}`,i=u(n,!0),r={};i?.etag&&(r["If-None-Match"]=i.etag),i?.lastModified&&(r["If-Modified-Since"]=i.lastModified);try{const o=await S(`https://api.guildwars2.com/v2/items/${e}?lang=es`,{headers:r,signal:t.signal});if(304===o.status&&i)return i.value;if(!o.ok)throw new Error(`Error ${o.status} obteniendo datos del ítem ${e}`);const a=await o.json();a.lastUpdated=(new Date).toISOString();const l=o.headers.get("ETag"),s=o.headers.get("Last-Modified");return c(n,a,l||s?null:void 0,{etag:l,lastModified:s}),a}finally{$.delete(t)}}let L=null;async function D(e,t){return t&&t.ingredients&&0!==t.ingredients.length?(L&&L.terminate(),L=new Worker(new URL("./workers/ingredientTreeWorker.js",import.meta.url),{type:"module"}),new Promise((n,i)=>{const r=t=>{L.removeEventListener("message",r),L.removeEventListener("error",o);const i=t.data||[];L=null;const a=i.map(t=>q(t,t.parentMultiplier,e));function l(e,t){e._parent=t,e.children&&e.children.forEach(t=>l(t,e))}a.forEach(e=>{l(e,null),e.recalc(window.globalQty,null)}),n(a)},o=e=>{L.removeEventListener("message",r),L.removeEventListener("error",o),L=null,console.error("Error en ingredientTreeWorker:",e?.message||e,e);const t="Error procesando ingredientes"+(e?.message?`: ${e.message}`:"");window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(t,"error"):"function"==typeof alert&&alert(t),i(e)};L.addEventListener("message",r),L.addEventListener("error",o),L.postMessage({mainItemId:e,mainRecipeData:t})})):(window.ingredientObjs=[],window._mainRecipeOutputCount=t&&t.output_item_count||1,[])}async function Q(e){const t=N(new AbortController),n=`recipe_${e}`,i=u(n);if(i)return $.delete(t),i;try{const i=await S(`https://api.guildwars2.com/v2/recipes/search?output=${e}`,{signal:t.signal});if(!i.ok)return null;const r=await i.json();if(!r||0===r.length)return null;const o=r[0],a=await S(`https://api.guildwars2.com/v2/recipes/${o}?lang=es`,{signal:t.signal});if(!a.ok)throw new Error(`Error ${a.status} obteniendo datos de la receta ${o}`);const l=await a.json();return l.lastUpdated=(new Date).toISOString(),c(n,l),l}finally{$.delete(t)}}async function F(e){const t=N(new AbortController),n=`price_${e}`,i=u(n,!0),r={};i?.etag&&(r["If-None-Match"]=i.etag),i?.lastModified&&(r["If-Modified-Since"]=i.lastModified);try{const o=`https://api.datawars2.ie/gw2/v1/items/csv?fields=${["id","buy_price","sell_price","buy_quantity","sell_quantity","last_updated","1d_buy_sold","1d_sell_sold","2d_buy_sold","2d_sell_sold","7d_buy_sold","7d_sell_sold","1m_buy_sold","1m_sell_sold"].join(",")}&ids=${e}`,a=await S(o,{signal:t.signal,headers:r});if(304===a.status&&i){const e=a.headers.get("etag")||i.etag,t=a.headers.get("last-modified")||i.lastModified;return c(n,i.value,void 0,{etag:e,lastModified:t}),i.value}if(!a.ok)throw new Error(`Error ${a.status} obteniendo datos de mercado para el ítem ${e}`);const l=(await a.text()).trim().split("\n");if(l.length<2)return{};const s=l[0].split(","),d=l[1].split(","),u={};return s.forEach((e,t)=>{u[e]=void 0!==d[t]?isNaN(d[t])?d[t]:Number(d[t]):null}),c(n,u,void 0,{etag:a.headers.get("etag"),lastModified:a.headers.get("last-modified")}),u}finally{$.delete(t)}}function q(e,t=1,n=null){const i=new O({id:e.id,name:e.name,icon:e.icon,rarity:e.rarity,count:e.count||1,recipe:e.recipe||null,buy_price:e.buy_price||0,sell_price:e.sell_price||0,is_craftable:e.is_craftable||!1,children:[],_parentId:n});return e.children&&e.children.length>0&&(i.children=e.children.map(e=>q(structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e)),e.count*t,i.id))),i}if("undefined"!=typeof window){void 0===window.comparativa&&(window.comparativa={});let K=null;function V(){const e=window.ingredientObjs?window.ingredientObjs.map(e=>e.id):[];K?K.updateIds(e):K=I(e,{onUpdate:(e,t)=>{const n=U(window.ingredientObjs,e);n&&(n.buy_price=t.buy_price||0,n.sell_price=t.sell_price||0,"function"==typeof n.recalc&&n.recalc(window.globalQty||1,null),"function"==typeof window.safeRenderTable&&window.safeRenderTable())}})}window.comparativa.agregarItemPorId=async function(e){if(window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1,window.ingredientObjs.some(t=>t.id==e))return;const t=document.getElementById("item-skeleton");try{"function"==typeof window.showSkeleton&&window.showSkeleton(t);const n=await B(e),i=await Q(e);let r,o;if(i){let t=await D(e,i);Array.isArray(t)||(t=[]),r=await F(e),window._mainBuyPrice=r.buy_price||0,window._mainSellPrice=r.sell_price||0,window._mainRecipeOutputCount=i&&i.output_item_count||1,o=new O({id:n.id,name:n.name,icon:n.icon,rarity:n.rarity,count:1,buy_price:r.buy_price,sell_price:r.sell_price,is_craftable:!0,recipe:i,children:t}),o.recalc(window.globalQty||1,null)}else r=await F(e),window._mainBuyPrice=r.buy_price||0,window._mainSellPrice=r.sell_price||0,window._mainRecipeOutputCount=1,o=new O({id:n.id,name:n.name,icon:n.icon,rarity:n.rarity,count:1,buy_price:r.buy_price,sell_price:r.sell_price,is_craftable:!1,recipe:null,children:[]});window.ingredientObjs.push(o),V(),"function"==typeof window.safeRenderTable&&("number"==typeof r.buy_price&&"number"==typeof r.sell_price?window.safeRenderTable(r.buy_price,r.sell_price):window.safeRenderTable()),"function"==typeof window.hideSkeleton&&window.hideSkeleton(t)}catch(e){"function"==typeof window.hideSkeleton&&window.hideSkeleton(t),alert("Error al agregar el ítem: "+(e?.message||e)),console.error("Error al agregar el ítem",e)}},window.comparativa.handleSaveComparativa=async function(){if(!window.ingredientObjs||0===window.ingredientObjs.length)return void window.StorageUtils?.showToast("Agrega al menos un ítem a la comparativa","error");const e={ids:window.ingredientObjs.map(e=>e.id),nombres:window.ingredientObjs.map(e=>e.name),timestamp:Date.now()};window.StorageUtils&&"function"==typeof window.StorageUtils.saveComparativa?(await window.StorageUtils.saveComparativa(e),window.StorageUtils.showToast("Comparativa guardada")):alert("StorageUtils no está disponible.")},window.comparativa.loadComparativaFromURL=function(){const e=new URLSearchParams(window.location.search).get("ids");if(!e)return;const t=e.split(",").map(e=>parseInt(e,10)).filter(e=>!isNaN(e));if(0===t.length)return;window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1;const n=()=>{window.comparativa&&"function"==typeof window.comparativa.agregarItemPorId?(async()=>{for(const e of t)try{await window.comparativa.agregarItemPorId(e)}catch(t){console.error("Error cargando ítem de la URL",e,t)}})():setTimeout(n,50)};n()}}function z(e,t){return!e||!t||isNaN(e)||isNaN(t)||0===t?"-":(e/t*100).toFixed(1)+"%"}"undefined"!=typeof window&&(window.setIngredientObjs=E,window.setGlobalQty=T,window.snapshotExpandState=j,window.restoreExpandState=P,window.recalcAll=A,window.getTotals=C,window.findIngredientByIdAndParent=x,window.findIngredientByPath=k,window.findIngredientByUid=R,window.findIngredientById=U,window.calcPercent=z);var J=Object.freeze({__proto__:null,CraftIngredient:O,calcPercent:z,cancelItemRequests:function(){$.forEach(e=>e.abort()),$.clear(),L&&(L.terminate(),L=null)},createCraftIngredientFromRecipe:q,fetchItemData:B,fetchMarketDataForItem:F,fetchRecipeData:Q,findIngredientById:U,findIngredientByIdAndParent:x,findIngredientByPath:k,findIngredientByUid:R,getTotals:C,prepareIngredientTreeData:D,recalcAll:A,restoreExpandState:P,setGlobalQty:T,setIngredientObjs:E,snapshotExpandState:j});const W=new Map,G=new Map,H=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.dataset.stateId;if(t&&(G.set(t,e.isIntersecting),e.isIntersecting)){const n=W.get(t),i=e.target._pendingState;n&&i&&(n(i),e.target._pendingState=null)}})});var X=Object.freeze({__proto__:null,register:function(e,t,n){t.dataset.stateId=e,W.set(e,n),H.observe(t)},update:function(e,t){const n=document.querySelector(`[data-state-id="${e}"]`);if(n)if(G.get(String(e))){const n=W.get(String(e));n&&n(t)}else n._pendingState=t}});export{S as a,f as b,C as c,X as d,e as f,u as g,J as i,M as p,b as r,c as s};
