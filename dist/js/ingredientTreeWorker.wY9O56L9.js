import{a as e}from"./utils-bc8VNvJR.js";import"./services-Cd2sNgr4.js";self.onmessage=async t=>{const{mainItemId:i}=t.data;try{const t=await async function(t){const i=await e(`/recipe-tree/${t}`).then(e=>e.json());if(!i||!i.components||0===i.components.length)return null;const n=new Set;!function e(t){t&&(n.add(t.id),t.components&&t.components.forEach(t=>{"Recipe"===t.type?e(t):"Item"===t.type&&n.add(t.id)}))}(i);const r=new Map,c=Array.from(n);for(let t=0;t<c.length;t+=200){const i=c.slice(t,t+200);(await e(`https://api.guildwars2.com/v2/items?ids=${i.join(",")}&lang=es`).then(e=>e.json())).forEach(e=>r.set(e.id,e))}const s=new Map;try{const t=`https://api.datawars2.ie/gw2/v1/items/csv?fields=id,buy_price,sell_price&ids=${Array.from(n).join(",")}`,i=await e(t).then(e=>e.text()),[r,...c]=i.trim().split("\n").map(e=>e.split(","));if(r&&r.length>0)for(const e of c){const t={};r.forEach((i,n)=>{const r=e[n];t[i]="id"===i?parseInt(r,10):"buy_price"===i||"sell_price"===i?""!==r&&void 0!==r?parseInt(r,10):null:r}),t.id&&s.set(t.id,t)}}catch(e){}const l=Array.from(n).filter(e=>!s.has(e));for(let t=0;t<l.length;t+=200){const i=l.slice(t,t+200);try{(await e(`https://api.guildwars2.com/v2/commerce/prices?ids=${i.join(",")}`).then(e=>e.json())).forEach(e=>{s.set(e.id,{id:e.id,buy_price:e.buys?.unit_price??null,sell_price:e.sells?.unit_price??null})})}catch(e){}}function o(e,t,i=null){const n=r.get(e.id);if(!n)return null;const c=s.get(e.id)||{},l=Array.isArray(e.components)&&e.components.length>0;let a=[];return l&&(a=e.components.map(t=>{if("Recipe"===t.type)return o(t,e.output||1,n.id);if("Item"===t.type){const i=r.get(t.id);if(!i)return null;const c=s.get(t.id)||{};return{id:i.id,name:i.name,icon:i.icon,rarity:i.rarity,count:t.quantity,parentMultiplier:e.output||1,buy_price:c.buy_price??null,sell_price:c.sell_price??null,crafted_price:null,is_craftable:!1,recipe:null,children:[],_parentId:n.id}}return null}).filter(Boolean)),{id:n.id,name:n.name,icon:n.icon,rarity:n.rarity,count:e.quantity,parentMultiplier:t,buy_price:c.buy_price??null,sell_price:c.sell_price??null,crafted_price:null,is_craftable:l,recipe:e.recipe||null,children:a,_parentId:i}}return o(i,i.recipe?.output_item_count||1,null)}(i);self.postMessage({tree:t})}catch(e){self.postMessage({error:e.message})}};
