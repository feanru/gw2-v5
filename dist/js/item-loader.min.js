import{f as e,e as r}from"./utils-BH_A_QOU.js";import"./services-BkFipzNj.js";let n,t,i,o,a,s,l,c,d,w;async function u(){return w||(w=Promise.all([import("./items-core.CqtpJL3C.min.js"),import("./utils-BH_A_QOU.js").then(function(e){return e.h}),import("./services-BkFipzNj.js").then(function(e){return e.r}).catch(()=>import("./services/recipeService.min.js")),import("./utils-BH_A_QOU.js").then(function(e){return e.i})]).then(([e,r,w,u])=>{({prepareIngredientTreeData:n,CraftIngredient:t,setIngredientObjs:i,findIngredientsById:o,cancelItemRequests:a,recalcAll:s}=e),({preloadPrices:d}=r),({getItemBundles:l}=w),({update:c}=u)})),w}let m=0,p=null,h=null;async function f(e){if(!Array.isArray(e)||0===e.length)return[];await u();try{return await l(e)}catch(e){return console.error("Error cargando ítems",e),[]}}async function y(s){await u();const l=++m;if(h&&(h.abort(),h=null),a(),!s)return window.hideSkeleton?.(document.getElementById("item-skeleton")),void window.showError?.("ID de ítem no válido");let d=null,w=null;const f=document.getElementById("item-skeleton");try{window.showSkeleton?.(f),h=new AbortController;const a=await e(`/backend/api/itemDetails.php?itemId=${s}`,{signal:h.signal});if(404===a.status)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(f);if(!a.ok)throw new Error(`Error ${a.status} obteniendo detalles del ítem`);const u=a.headers.get("content-type")||"";if(!u.includes("application/json"))throw new Error(`Respuesta no válida: ${u}`);const{item:y,recipe:g,market:E,nested_recipe:_}=await a.json();if(!y)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(f);if(l!==m)return;if(w=E||{},window._mainBuyPrice=w.buy_price||0,window._mainSellPrice=w.sell_price||0,!g)return i([]),void window.initItemUI(y,w);_&&(g.nested_recipe=_),window._mainRecipeOutputCount=g.output_item_count||1,setTimeout(async()=>{if(l!==m)return;let e;try{e=await n(s,g)}catch(e){return console.error("Error preparando ingredientes",e),window.showError?.("Error al preparar los ingredientes"),i([]),void window.initItemUI(y,w)}Array.isArray(e)||(e=[]),d=new t({id:y.id,name:y.name,icon:y.icon,rarity:y.rarity,count:1,buy_price:w?.buy_price||0,sell_price:w?.sell_price||0,is_craftable:!0,recipe:g,children:e}),d.recalc(window.globalQty||1,null),i([d]),await window.initItemUI(y,w),await(window.safeRenderTable?.());const a=new Set;!function e(r,n){n.add(r.id),r.children&&r.children.forEach(r=>e(r,n))}(d,a),p&&p();const u=Array.from(a),h=async e=>{if(!document.getElementById("seccion-crafting"))return void requestAnimationFrame(()=>h(e));const r=[];e.forEach((e,n)=>{const t=o(window.ingredientObjs,Number(n));t.length&&t.forEach(n=>{n.buy_price=e.buy_price||0,n.sell_price=e.sell_price||0,n===window.ingredientObjs[0]&&(window._mainBuyPrice=n.buy_price,window._mainSellPrice=n.sell_price),r.push(n)})}),await(window.safeRenderTable?.());const n=window.getTotals?.();n&&(c("totales-crafting-global",n),c("totales-crafting-unit",n)),r.forEach(e=>c(e._uid,e))};p=r(u,h)},0)}catch(e){if("AbortError"===e.name)return;console.error("Error cargando ítem",e),window.showError?.("Error al cargar los datos del ítem"),window.hideSkeleton?.(f)}finally{h=null}}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new URLSearchParams(window.location.search),r=parseInt(e.get("id"),10);r?y(r):window.showError?.("ID de ítem no válido")};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0)});export{y as loadItem,f as loadItems};
