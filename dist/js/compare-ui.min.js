const t={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},e="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let n=null;function i(t){e&&e.postMessage({type:"delete",key:t})}const o=new Map;!function(t){n=t,e&&e.addEventListener("message",({data:t})=>{const{type:i,key:o,entry:a}=t||{};if("request-bundles"!==i)i&&o&&("set"===i&&a?n.set(o,a):"delete"===i&&n.delete(o));else{if(!n)return;n.forEach((t,n)=>{n.startsWith("bundle_")&&e.postMessage({type:"set",key:n,entry:t})})}})}(o),e&&e.postMessage({type:"request-bundles"});const a="undefined"!=typeof localStorage;function r(t){try{return JSON.parse(t)}catch{return null}}function l(t,e){if(a)try{localStorage.setItem(t,function({value:t,expiresAt:e,etag:n,lastModified:i}){return JSON.stringify({value:t,expiresAt:e,etag:n,lastModified:i})}(e))}catch{}}function d(n,i,a=void 0,r={}){if(void 0===a){const e=n.split("_")[0];a=t[e]}const d=null==a?null:Date.now()+a,{etag:s=null,lastModified:c=null}=r,u={value:i,expiresAt:d,updatedAt:(new Date).toISOString(),etag:s,lastModified:c};o.set(n,u),l(n,{value:i,expiresAt:d,etag:s,lastModified:c}),function(t,n){e&&e.postMessage({type:"set",key:t,entry:n})}(n,u)}function s(t,e=!1){let n=o.get(t);if(!n){const e=function(t){if(!a)return null;const e=localStorage.getItem(t);if(!e)return null;const n=r(e);return n||(localStorage.removeItem(t),null)}(t);if(e){const{value:i,expiresAt:a=null,etag:r=null,lastModified:l=null}=e;n={value:i,expiresAt:a,updatedAt:(new Date).toISOString(),etag:r,lastModified:l},o.set(t,n)}}return n?n.expiresAt&&Date.now()>n.expiresAt?(o.delete(t),a&&localStorage.removeItem(t),i(t),null):e?n:n.value:null}function c(t=[],{interval:e=6e4,concurrency:n=5,maxRetries:i=3,onUpdate:o=()=>{}}={}){let a=Array.from(new Set(t)),r=null;const l="undefined"!=typeof window?window:null,d="undefined"!=typeof BroadcastChannel?new BroadcastChannel("price-updater"):null,s=Math.random().toString(36).slice(2),c=new Set;function u(){r&&(clearInterval(r),r=null)}function w(){0===a.length||"undefined"!=typeof document&&document.hidden||"undefined"!=typeof navigator&&!1===navigator.onLine||a.some(t=>c.has(t))?u():(r||(r=setInterval(m,e)),m())}async function p(t,e,n=500){try{return await C(t)}catch(i){if(e<=0)throw i;return await new Promise(t=>setTimeout(t,n)),p(t,e-1,2*n)}}async function f(t){for(;t.length;){const e=t.shift();try{const t=await p(e,i);o(e,t),d?.postMessage({type:"result",id:e,data:t,sender:s})}catch(t){console.error("Price update failed for",e,t)}}}async function m(){const t=a.filter(t=>!c.has(t));if(0===t.length)return;d?.postMessage({type:"start",ids:t,sender:s});const e=Math.min(n,t.length),i=[];for(let n=0;n<e;n++)i.push(f(t));await Promise.all(i),d?.postMessage({type:"done",ids:t,sender:s})}return document.addEventListener("visibilitychange",w),l?.addEventListener("online",w),l?.addEventListener("offline",w),d&&(d.onmessage=t=>{const e=t.data||{};e.sender!==s&&("start"===e.type?((e.ids||[]).forEach(t=>c.add(t)),w()):"done"===e.type?((e.ids||[]).forEach(t=>c.delete(t)),w()):"result"===e.type&&a.includes(e.id)&&o(e.id,e.data))}),w(),{updateIds(t=[]){a=Array.from(new Set(t)),w()},stop(){u(),document.removeEventListener("visibilitychange",w),l?.removeEventListener("online",w),l?.removeEventListener("offline",w),d?.close()}}}!function(){if(!a)return;const t=[];for(let e=0;e<localStorage.length;e++){const n=localStorage.key(e),i=r(localStorage.getItem(n));if(!i)continue;const{expiresAt:o}=i;o&&Date.now()>o&&t.push(n)}t.forEach(t=>{localStorage.removeItem(t),i(t)})}();const u=new Map;function w(t,e={},n=null,i=null,o){const a=u.get(t);a&&a.controller?.abort(),n&&!i&&(i=s(n,!0));const r={...e.headers||{}};i?.etag&&(r["If-None-Match"]=i.etag),i?.lastModified&&(r["If-Modified-Since"]=i.lastModified);const l=o?null:new AbortController,d=o??e.signal??l?.signal,c=async function(t,e={}){const{timeout:n=8e3,retries:i=3,backoff:o=300,signal:a,...r}=e;for(let e=0;e<=i;e++){const l=new AbortController,d=setTimeout(()=>l.abort(),n);a&&(a.aborted?l.abort():a.addEventListener("abort",()=>l.abort(),{once:!0}));try{const e=await fetch(t,{...r,signal:l.signal});return clearTimeout(d),e}catch(t){if(clearTimeout(d),a?.aborted||e===i)throw t;const n=o*Math.pow(2,e);await new Promise(t=>setTimeout(t,n))}}}(t,{...e,headers:r,signal:d}).then(async t=>304===t.status&&i?new Response(JSON.stringify(i.value),{status:200,headers:{"X-Cache":"HIT",ETag:i.etag||"","Last-Modified":i.lastModified||""}}):t).catch(t=>{if(t instanceof DOMException&&"AbortError"===t.name)throw t;throw t});return function(t,e,n){return u.set(t,{promise:e,controller:n}),e.finally(()=>u.delete(t)),e}(t,c,l).then(t=>t.clone())}"undefined"!=typeof window&&(window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1,window._mainBuyPrice=window._mainBuyPrice||0,window._mainSellPrice=window._mainSellPrice||0,window._mainRecipeOutputCount=window._mainRecipeOutputCount||1);class p{constructor({id:t,name:e,icon:n,rarity:i,count:o,parentMultiplier:a=1,buy_price:r,sell_price:l,is_craftable:d,recipe:s,children:c=[],_parentId:u=null}){this._uid=p.nextUid++,this.id=t,this.name=e,this.icon=n,this.rarity=i,this.count=o,this.parentMultiplier=a||1,this.buy_price=r,this.sell_price=l,this.is_craftable=d,this.recipe=s||null,this.children=c,this.mode="buy",this.modeForParentCrafted="buy",this.expanded=!1,this._parentId=u,this._parent=null,this.countTotal=0,this.crafted_price=null,this.total_buy=0,this.total_sell=0,this.total_crafted=0}findRoot(){let t=this;for(;t._parent;)t=t._parent;return t}setMode(t){if(["buy","sell","crafted"].includes(t)){this.modeForParentCrafted=t;this.findRoot().recalc(window.globalQty||1,null),"function"==typeof window.safeRenderTable&&window.safeRenderTable()}}recalc(t=1,e=null){const n=null==e;this.countTotal=n?this.count*t:e.countTotal*this.count,this.children&&this.children.length>0&&this.children.forEach(e=>e.recalc(t,this)),n?(this.total_buy=this.children.reduce((t,e)=>t+(e.total_buy||0),0),this.total_sell=this.children.reduce((t,e)=>t+(e.total_sell||0),0)):(this.total_buy=(this.buy_price||0)*this.countTotal,this.total_sell=(this.sell_price||0)*this.countTotal),this.is_craftable&&this.children.length>0?(this.total_crafted=this.children.reduce((t,e)=>{switch(e.modeForParentCrafted){case"buy":default:return t+(e.total_buy||0);case"sell":return t+(e.total_sell||0);case"crafted":return t+(e.total_crafted||0)}},0),this.crafted_price=this.total_crafted/(this.recipe?.output_item_count||1),n||this.buy_price||this.sell_price||(this.total_buy=this.children.reduce((t,e)=>t+(e.total_buy||0),0),this.total_sell=this.children.reduce((t,e)=>t+(e.total_sell||0),0))):(this.total_crafted=null,this.crafted_price=null)}getBestPrice(){return"number"==typeof this.buy_price&&this.buy_price>0?this.buy_price:"number"==typeof this.crafted_price&&this.crafted_price>0?this.crafted_price:0}}function f(t){window.globalQty=t}function m(t){return t?t.map(t=>({id:t.id,expanded:t.expanded,children:m(t.children||[])})):[]}function h(t,e){if(t&&e)for(let n=0;n<t.length;n++)e[n]&&(t[n].expanded=e[n].expanded,h(t[n].children,e[n].children))}function g(t){let e=0,n=0,i=0;for(const o of t)switch(e+=o.total_buy||0,n+=o.total_sell||0,o.modeForParentCrafted){case"sell":i+=o.total_sell||0;break;case"crafted":i+=o.total_crafted||0;break;default:i+=o.total_buy||0}return{totalBuy:e,totalSell:n,totalCrafted:i}}function y(t,e){let n=t,i=null;for(let t=0;t<e.length;t++){const o=e[t];if(i=(n||[]).find(t=>String(t._uid)===String(o)||String(t.id)===String(o)),!i)return null;n=i.children}return i}function b(t,e){for(const n of t){if(String(n.id)===String(e))return n;if(n.children&&n.children.length){const t=b(n.children,e);if(t)return t}}return null}p.nextUid=0;const _=new Set;function v(t){return _.add(t),t}let S=null;async function I(t,e){return e&&e.ingredients&&0!==e.ingredients.length?(S&&S.terminate(),S=new Worker(new URL("./workers/ingredientTreeWorker.js",import.meta.url),{type:"module"}),new Promise((n,i)=>{const o=e=>{S.removeEventListener("message",o),S.removeEventListener("error",a);const i=e.data||[];S=null;const r=i.map(e=>$(e,e.parentMultiplier,t));function l(t,e){t._parent=e,t.children&&t.children.forEach(e=>l(e,t))}r.forEach(t=>{l(t,null),t.recalc(window.globalQty,null)}),n(r)},a=t=>{S.removeEventListener("message",o),S.removeEventListener("error",a),S=null,console.error("Error en ingredientTreeWorker:",t?.message||t,t);const e="Error procesando ingredientes"+(t?.message?`: ${t.message}`:"");window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(e,"error"):"function"==typeof alert&&alert(e),i(t)};S.addEventListener("message",o),S.addEventListener("error",a),S.postMessage({mainItemId:t,mainRecipeData:e})})):(window.ingredientObjs=[],window._mainRecipeOutputCount=e&&e.output_item_count||1,[])}async function C(t){const e=v(new AbortController),n=`price_${t}`,i=s(n,!0),o={};i?.etag&&(o["If-None-Match"]=i.etag),i?.lastModified&&(o["If-Modified-Since"]=i.lastModified);try{const a=`https://api.datawars2.ie/gw2/v1/items/csv?fields=${["id","buy_price","sell_price","buy_quantity","sell_quantity","last_updated","1d_buy_sold","1d_sell_sold","2d_buy_sold","2d_sell_sold","7d_buy_sold","7d_sell_sold","1m_buy_sold","1m_sell_sold"].join(",")}&ids=${t}`,r=await w(a,{signal:e.signal,headers:o});if(304===r.status&&i){const t=r.headers.get("etag")||i.etag,e=r.headers.get("last-modified")||i.lastModified;return d(n,i.value,void 0,{etag:t,lastModified:e}),i.value}if(!r.ok)throw new Error(`Error ${r.status} obteniendo datos de mercado para el ítem ${t}`);const l=(await r.text()).trim().split("\n");if(l.length<2)return{};const s=l[0].split(","),c=l[1].split(","),u={};return s.forEach((t,e)=>{u[t]=void 0!==c[e]?isNaN(c[e])?c[e]:Number(c[e]):null}),d(n,u,void 0,{etag:r.headers.get("etag"),lastModified:r.headers.get("last-modified")}),u}finally{_.delete(e)}}function $(t,e=1,n=null){const i=new p({id:t.id,name:t.name,icon:t.icon,rarity:t.rarity,count:t.count||1,recipe:t.recipe||null,buy_price:t.buy_price||0,sell_price:t.sell_price||0,is_craftable:t.is_craftable||!1,children:[],_parentId:n});return t.children&&t.children.length>0&&(i.children=t.children.map(t=>$(structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t)),t.count*e,i.id))),i}if("undefined"!=typeof window){void 0===window.comparativa&&(window.comparativa={});let B=null;function R(){const t=window.ingredientObjs?window.ingredientObjs.map(t=>t.id):[];B?B.updateIds(t):B=c(t,{onUpdate:(t,e)=>{const n=b(window.ingredientObjs,t);n&&(n.buy_price=e.buy_price||0,n.sell_price=e.sell_price||0,"function"==typeof n.recalc&&n.recalc(window.globalQty||1,null),"function"==typeof window.safeRenderTable&&window.safeRenderTable())}})}window.comparativa.agregarItemPorId=async function(t){if(window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1,window.ingredientObjs.some(e=>e.id==t))return;const e=document.getElementById("item-skeleton");try{"function"==typeof window.showSkeleton&&window.showSkeleton(e);const n=await async function(t){const e=v(new AbortController),n=`item_${t}`,i=s(n,!0),o={};i?.etag&&(o["If-None-Match"]=i.etag),i?.lastModified&&(o["If-Modified-Since"]=i.lastModified);try{const a=await w(`https://api.guildwars2.com/v2/items/${t}?lang=es`,{headers:o,signal:e.signal});if(304===a.status&&i)return i.value;if(!a.ok)throw new Error(`Error ${a.status} obteniendo datos del ítem ${t}`);const r=await a.json();r.lastUpdated=(new Date).toISOString();const l=a.headers.get("ETag"),s=a.headers.get("Last-Modified");return d(n,r,l||s?null:void 0,{etag:l,lastModified:s}),r}finally{_.delete(e)}}(t),i=await async function(t){const e=v(new AbortController),n=`recipe_${t}`,i=s(n);if(i)return _.delete(e),i;try{const i=await w(`https://api.guildwars2.com/v2/recipes/search?output=${t}`,{signal:e.signal});if(!i.ok)return null;const o=await i.json();if(!o||0===o.length)return null;const a=o[0],r=await w(`https://api.guildwars2.com/v2/recipes/${a}?lang=es`,{signal:e.signal});if(!r.ok)throw new Error(`Error ${r.status} obteniendo datos de la receta ${a}`);const l=await r.json();return l.lastUpdated=(new Date).toISOString(),d(n,l),l}finally{_.delete(e)}}(t);let o,a;if(i){let e=await I(t,i);Array.isArray(e)||(e=[]),o=await C(t),window._mainBuyPrice=o.buy_price||0,window._mainSellPrice=o.sell_price||0,window._mainRecipeOutputCount=i&&i.output_item_count||1,a=new p({id:n.id,name:n.name,icon:n.icon,rarity:n.rarity,count:1,buy_price:o.buy_price,sell_price:o.sell_price,is_craftable:!0,recipe:i,children:e}),a.recalc(window.globalQty||1,null)}else o=await C(t),window._mainBuyPrice=o.buy_price||0,window._mainSellPrice=o.sell_price||0,window._mainRecipeOutputCount=1,a=new p({id:n.id,name:n.name,icon:n.icon,rarity:n.rarity,count:1,buy_price:o.buy_price,sell_price:o.sell_price,is_craftable:!1,recipe:null,children:[]});window.ingredientObjs.push(a),R(),"function"==typeof window.safeRenderTable&&("number"==typeof o.buy_price&&"number"==typeof o.sell_price?window.safeRenderTable(o.buy_price,o.sell_price):window.safeRenderTable()),"function"==typeof window.hideSkeleton&&window.hideSkeleton(e)}catch(t){"function"==typeof window.hideSkeleton&&window.hideSkeleton(e),alert("Error al agregar el ítem: "+(t?.message||t)),console.error("Error al agregar el ítem",t)}},window.comparativa.handleSaveComparativa=async function(){if(!window.ingredientObjs||0===window.ingredientObjs.length)return void window.StorageUtils?.showToast("Agrega al menos un ítem a la comparativa","error");const t={ids:window.ingredientObjs.map(t=>t.id),nombres:window.ingredientObjs.map(t=>t.name),timestamp:Date.now()};window.StorageUtils&&"function"==typeof window.StorageUtils.saveComparativa?(await window.StorageUtils.saveComparativa(t),window.StorageUtils.showToast("Comparativa guardada")):alert("StorageUtils no está disponible.")},window.comparativa.loadComparativaFromURL=function(){const t=new URLSearchParams(window.location.search).get("ids");if(!t)return;const e=t.split(",").map(t=>parseInt(t,10)).filter(t=>!isNaN(t));if(0===e.length)return;window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1;const n=()=>{window.comparativa&&"function"==typeof window.comparativa.agregarItemPorId?(async()=>{for(const t of e)try{await window.comparativa.agregarItemPorId(t)}catch(e){console.error("Error cargando ítem de la URL",t,e)}})():setTimeout(n,50)};n()}}function E(t){t&&t.classList.add("hidden")}function x(){const t=document.getElementById("error-message");t&&(t.style.display="none")}function M(t){const e=document.getElementById("qty-global");e&&(void 0!==window._qtyInputValue?e.value=window._qtyInputValue:e.value=window.globalQty)}function O(){const t=document.getElementById("qty-global");return t?parseInt(t.value,10):1}"undefined"!=typeof window&&(window.setIngredientObjs=function(t){window.ingredientObjs=t},window.setGlobalQty=f,window.snapshotExpandState=m,window.restoreExpandState=h,window.recalcAll=function(t,e){t&&t.forEach(t=>{t.recalc(e,null)})},window.getTotals=g,window.findIngredientByIdAndParent=function t(e,n,i){for(const o of e){if(String(o.id)===String(n)&&String(o._parentId)===String(i))return o;if(Array.isArray(o.children)&&o.children.length){const e=t(o.children,n,i);if(e)return e}}return null},window.findIngredientByPath=y,window.findIngredientByUid=function t(e,n){for(const i of e){if(String(i._uid)===String(n))return i;if(i.children&&i.children.length){const e=t(i.children,n);if(e)return e}}return null},window.findIngredientById=b,window.calcPercent=function(t,e){return!t||!e||isNaN(t)||isNaN(e)||0===e?"-":(t/e*100).toFixed(1)+"%"});let k=null;function j(t,e=0,n=null,i=0,o=!0,a=[]){return t&&Array.isArray(t)?t.map((t,r)=>{if(!t||void 0===t.id)return console.warn("Ingrediente inválido en renderRows:",t),"";const l=0===e?r:i,d=l%2==0?"row-bg-a":"row-bg-b",s=e>0?`style="padding-left:${30*e}px"`:"",c="function"==typeof getRarityClass?getRarityClass(t.rarity):"",u=[...a,t.id].join("-"),w=t.children&&t.children.length?`<button class="btn-expand" data-path="${u}">${t.expanded?"▴":"▾"}</button>`:"",p=e>0,f=p&&!o?'style="display:none"':"",m=`mode-${u}`,h=p?`\n      <input type="radio" name="${m}" class="chk-mode-buy" data-path="${u}" ${"buy"===t.modeForParentCrafted?"checked":""} title="Usar precio de compra para el padre">\n    `:"",g=p?`\n      <input type="radio" name="${m}" class="chk-mode-sell" data-path="${u}" ${"sell"===t.modeForParentCrafted?"checked":""} title="Usar precio de venta para el padre">\n    `:"",y=p&&t.is_craftable&&t.children&&t.children.length>0?`\n      <input type="radio" name="${m}" class="chk-mode-crafted" data-path="${u}" ${"crafted"===t.modeForParentCrafted?"checked":""} title="Usar precio de crafteo para el padre">\n    `:"",b=(()=>{if(!(t.children&&t.children.length>0&&Number(t.sell_price)>0))return"";const e=Number(t.sell_price)*t.countTotal,n=e-.15*e-Math.min(t.total_buy,t.total_sell,t.total_crafted);return`<span style='font-weight:bold;color:${n>0?"#4fc178":"#e84d4d"}'>${formatGoldColored(n)}</span>`})();return!t.buy_price&&t.sell_price,t.is_craftable&&t.children&&t.children.length,`\n      <tr data-path="${u}" class="${p?`subrow subrow-${e} child-of-${n}`:""} ${d}" ${f}>\n        <td class="th-border-left-items" ${s}><img src="${t.icon}" width="32"></td>\n        <td><a href="/item?id=${t.id}" class="item-link ${c}" target="_blank">${t.name}</a></td>\n        <td>${t.countTotal?Number.isInteger(t.countTotal)?t.countTotal:t.countTotal.toFixed(2):t.count}</td>\n        <td class="item-unit-sell">${formatGoldColored(t.sell_price)} <span style="color: #c99b5b">c/u</span></td>\n        \n        <td class="item-solo-buy">\n          <div>${formatGoldColored(t.total_buy)}</div>\n          <div class="item-solo-precio">${formatGoldColored(t.buy_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${h}\n        </td>\n        \n        <td class="item-solo-sell">\n          <div>${formatGoldColored(t.total_sell)}</div>\n          <div class="item-solo-precio">${formatGoldColored(t.sell_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${g}\n        </td>\n        \n        <td class="item-solo-crafted">\n          ${t.is_craftable&&t.children&&t.children.length>0&&null!==t.total_crafted?`\n            <div>${formatGoldColored(t.total_crafted)}</div>\n            <div class="item-solo-precio">${formatGoldColored(0)} <span style="color: #c99b5b">c/u</span></div>\n            ${y}`:""}\n        </td>\n        \n        <td class="item-profit">${b}</td>\n        \n        <td class="th-border-right-items">${w}</td>\n      </tr>\n      ${t.children&&t.children.length&&o&&t.expanded?j(t.children,e+1,t.id,l,t.expanded,[...a,t.id]):""}\n    `}).join(""):""}function T(t,e=window._mainBuyPrice,n=window._mainSellPrice){null==e&&(e=window._mainBuyPrice),null==n&&(n=window._mainSellPrice),void 0===window._mainItemExpanded&&(window._mainItemExpanded=!1);!function(t){const e=document.querySelector(".qty-global-container");e&&(t?e.classList.add("visible"):e.classList.remove("visible"))}(window.ingredientObjs&&window.ingredientObjs.length>0);const i=window._mainRecipeOutputCount&&!isNaN(window._mainRecipeOutputCount)?window._mainRecipeOutputCount:1;void 0!==O()?O():window.globalQty;const o=null!=e?e*window.globalQty:0,a=window.ingredientObjs.reduce((t,e)=>t+(Number(e.sell_price)||0),0)*window.globalQty,r=Math.min(t.totalBuy,t.totalSell,t.totalCrafted),l=[o,a,r],d=Math.min(...l.filter(t=>t>0));let s="";s=d===o?"Mejor comprar (Buy)":d===a?"Mejor vender (Sell)":"Mejor craftear (Crafted)";let c="";t.totalBuy,t.totalSell,t.totalCrafted;t.totalBuy,t.totalSell,t.totalCrafted,1===i&&(c="");let u=`<div class="table-modern-totales">\n    <h3>Precio total materiales - Crafting</h3>\n    <div id="totales-crafting">      \n      <table class="table-totales" style="margin-top:12px;">\n        <tr>\n          <th><div class="tooltip-modern">Total Compra\n            <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-buy">${formatGoldColored(t.totalBuy)}</td>\n          <th><div class="tooltip-modern">Total Venta\n            <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-sell">${formatGoldColored(t.totalSell)}</td>\n          <th><div class="tooltip-modern">Total Crafted\n            <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n          </div></th>\n          <td class="item-solo-crafted">${formatGoldColored(t.totalCrafted)}</td>\n        </tr>\n      </table>\n    </div>\n    </div>`,w="";if(i>1&&(w=`<div class="table-modern-totales">\n    <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${i}</b> unidades por crafteo. Los siguientes costos son por unidad.</div>\n      <div id="totales-crafting">\n        <table class="table-totales" style="margin-top:12px;">\n          <tr>\n            <th><div class="tooltip-modern">Total Compra\n              <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-buy">${formatGoldColored(t.totalBuy/i)}</td>\n            <th><div class="tooltip-modern">Total Venta\n              <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-sell">${formatGoldColored(t.totalSell/i)}</td>\n            <th><div class="tooltip-modern">Total Crafted\n              <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n            </div></th>\n              <td class="item-solo-crafted">${formatGoldColored(t.totalCrafted/i)}</td>\n          </tr>\n        </table>\n      </div>\n    </div>`),1===i&&(formatGoldColored(o),formatGoldColored(a),formatGoldColored(r)),i>1){const t=null!=e?e:0,o=null!=n?n:0,a=i>0?r/i:r,l=[t,o,a],d=Math.min(...l.filter(t=>t>0));l.indexOf(d);formatGoldColored(t),formatGoldColored(o),formatGoldColored(a)}return`\n    <h3>Comparativa de items</h3>\n\n    <table class="table-modern tabla-tarjetas">\n      <thead class="header-items table-comparison-row">\n        <tr>\n          <th class="th-border-left">Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio de venta</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n          <th>Total Crafted</th>\n          <th>Mejor Profit</th>\n          <th class="th-border-right"></th>\n        </tr>\n      </thead>\n      <tbody>\n        ${window.ingredientObjs.map(t=>`\n          ${function(t,e){const n={totalBuy:t.total_buy,totalSell:t.total_sell,totalCrafted:void 0!==t.total_crafted&&null!==t.total_crafted?t.total_crafted:g(t.children||[]).totalCrafted};if(!t)return"";const i=!!window._mainItemExpandedMap[t.id],o=`<button class="btn-expand btn-expand-main" id="btn-expand-main-${t.id}" data-id="${t.id}">${i?"▴":"▾"}</button> <button class="btn-delete-main" data-id="${t.id}" title="Eliminar">-</button>`,a="function"==typeof getRarityClass?getRarityClass(t.rarity):"";return`\n    <tr class="row-bg-main">\n      <td class="th-border-left-items"><img src="${t.icon}" width="32"></td>\n      <td><a href="/item?id=${t.id}" class="item-link ${a}" target="_blank">${t.recipe&&t.recipe.output_item_count&&t.recipe.output_item_count>1?`<span style='color:#a1a1aa;font-size:0.95em;display:block;margin-bottom:2px;'>Receta produce <b>${t.recipe.output_item_count}</b> unidades<br>Profit mostrado es por unidad</span>`:""}${t.name}</a></td>\n      <td>${e}</td>\n      <td class="item-unit-sell">${formatGoldColored(Number(t.sell_price))} <span style="color: #c99b5b">c/u</span></td>\n      <td class="item-solo-buy"><div>${formatGoldColored(n.totalBuy)}</div></td>\n      <td class="item-solo-sell"><div>${formatGoldColored(n.totalSell)}</div></td>\n      <td class="item-solo-crafted"><div>${formatGoldColored(n.totalCrafted)}</div></td>\n      <td class="item-profit">${(()=>{const i=Number(t.sell_price)*e,o=i-.15*i-Math.min(n.totalBuy,n.totalSell,n.totalCrafted);return`<span style='font-weight:bold;color:${o>0?"#4fc178":"#e84d4d"}'>${formatGoldColored(o)}</span>`})()}</td>\n      <td class="th-border-right-items"><div style="display:flex;gap:6px;align-items:center;">${o}</div></td>\n    </tr>\n  `}(t,window.globalQty,t.total_buy,t.total_sell,t.total_crafted)}\n          ${window._mainItemExpandedMap[t.id]?j(t.children,1,t.id,0,!0,[t.id]):""}\n`).join("")}\n      </tbody>\n    </table>\n    \x3c!-- ${i>1?w:u} --\x3e\n    \x3c!-- Comparativa de precios oculta --\x3e\n    ${c}\n  `}async function P(t,e){const n=m(window.ingredientObjs),i=document.getElementById("item-header");i&&(i.style.display="none");const o=e||{};formatGoldColored(null!=o.buy_price?o.buy_price:0),formatGoldColored(null!=o.sell_price?o.sell_price:0),null!=o.buy_quantity&&o.buy_quantity,null!=o.sell_quantity&&o.sell_quantity,h(window.ingredientObjs,n),await L(e?.buy_price,e?.sell_price)}async function A(t,e){window._lastItemData=t,window._lastMarketData=e;E(document.getElementById("item-skeleton")),x(),await P(0,e)}async function L(t=window._mainBuyPrice,e=window._mainSellPrice){null==t&&(t=window._mainBuyPrice),null==e&&(e=window._mainSellPrice);const{updatedTree:n,totals:i}=await(o=window.ingredientObjs,a=window.globalQty,new Promise((t,e)=>{k||(k=new Worker("/dist/js/workers/costsWorker.js",{type:"module"})),k.onmessage=e=>t(e.data),k.onerror=t=>e(t),k.postMessage({ingredientTree:o,globalQty:a})}));var o,a;window.ingredientObjs=n;const r=document.getElementById("seccion-crafting");if(r){const n=T(i,t,e);l=[()=>{r.innerHTML=n},()=>M()],requestIdleCallback(function t(e){for(;e.timeRemaining()>0&&l.length;){const t=l.shift();"function"==typeof t&&t()}l.length&&requestIdleCallback(t)})}else M();var l}window.checkTreeForInvalidIds=function t(e,n=""){if(Array.isArray(e))for(const i of e)i&&void 0!==i.id&&null!==i.id||console.warn("Ingrediente sin id válido en ruta:",n,i),Array.isArray(i.children)&&t(i.children,n+" > "+(i.name||i.id))},void 0===window._mainItemExpandedMap&&(window._mainItemExpandedMap={}),window._mainExpandBtnHandlerInstalled||(window._mainExpandBtnHandlerInstalled=!0,document.addEventListener("click",function(t){if(t.target&&t.target.classList.contains("btn-expand-main")){const e=t.target.getAttribute("data-id");if(!e)return;window._mainItemExpandedMap[e]=!window._mainItemExpandedMap[e],L(),t.stopPropagation()}}),document.addEventListener("click",function(t){if(t.target&&(t.target.classList.contains("btn-delete-main")||"function"==typeof t.target.closest&&t.target.closest(".btn-delete-main"))){let e=t.target;if(e.classList.contains("btn-delete-main")||"function"!=typeof e.closest||(e=e.closest(".btn-delete-main")),!e)return;const n=e.getAttribute("data-id");if(!n)return;window.ingredientObjs&&Array.isArray(window.ingredientObjs)&&(window.ingredientObjs=window.ingredientObjs.filter(t=>String(t.id)!==String(n)),window._mainItemExpandedMap&&delete window._mainItemExpandedMap[n]),L(),t.stopPropagation()}})),window._modeChangeHandlerInstalled||(window._modeChangeHandlerInstalled=!0,document.addEventListener("click",function(t){const e=t.target;if(e.matches(".chk-mode-buy, .chk-mode-sell, .chk-mode-crafted")){const t=e.getAttribute("data-path");if(!t)return;const n=t.split("-"),i=n[0],o=window.ingredientObjs.find(t=>String(t.id)===String(i));if(!o)return;const a=y([o],n);if(a){let t="buy";e.classList.contains("chk-mode-sell")&&(t="sell"),e.classList.contains("chk-mode-crafted")&&(t="crafted"),a.setMode(t)}}})),window._expandBtnHandlerInstalled||(window._expandBtnHandlerInstalled=!0),window.ingredientObjs&&function t(e,n=""){e.forEach(e=>{e._parentId=null!==n?String(n):"",Array.isArray(e.children)&&t(e.children,e.id)})}(window.ingredientObjs),document.addEventListener("click",function(t){if(t.target&&t.target.classList.contains("btn-expand")){const e=t.target.getAttribute("data-path");if(!e)return;const n=e.split("-").map(t=>t.trim()),i=y(window.ingredientObjs,n);i&&(i.expanded=!i.expanded,L())}}),window._qtyGlobalHandlerInstalled||(window._qtyGlobalHandlerInstalled=!0,document.addEventListener("input",function(t){t.target&&"qty-global"===t.target.id&&(window._qtyInputValue=t.target.value)}),document.addEventListener("blur",function(t){if(t.target&&"qty-global"===t.target.id){const e=t.target;let n=parseInt(e.value,10);isNaN(n)||n<1?(f(1),window._qtyInputValue="1"):(f(n),window._qtyInputValue=e.value),void 0!==window._qtyInputValue&&String(window._qtyInputValue)===String(window.globalQty)&&delete window._qtyInputValue,L()}},!0),document.addEventListener("keydown",function(t){if(t.target&&"qty-global"===t.target.id&&"Enter"===t.key){t.preventDefault();const e=t.target;let n=parseInt(e.value,10);isNaN(n)||n<1?(f(1),window._qtyInputValue="1"):(f(n),window._qtyInputValue=e.value),void 0!==window._qtyInputValue&&String(window._qtyInputValue)===String(window.globalQty)&&delete window._qtyInputValue,L()}})),"undefined"!=typeof window&&(window.showSkeleton=function(t){t&&t.classList.remove("hidden")},window.hideSkeleton=E,window.showError=function(t){const e=document.getElementById("error-message");e&&(e.textContent=t,e.style.display="block")},window.hideError=x,window.safeRenderTable=L,window.renderItemUI=P,window.installUIEvents=function(){});export{A as initItemUI,P as renderItemUI,L as safeRenderTable};
