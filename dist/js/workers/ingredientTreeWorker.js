import{requestItems as i}from"../utils/requestManager.min.js";import{fetchWithCache as t}from"../utils/requestCache.min.js";import"../utils/cache.min.js";import"../utils/cachePolicies.min.js";import"../utils/cacheSync.min.js";self.onmessage=async e=>{const{mainItemId:n,mainRecipeData:s}=e.data;try{const e=await async function(e,n){if(!n||!n.ingredients||0===n.ingredients.length)return[];const s=new Set,a=new Set;async function r(e){if(!e||0===e.length)return;const n=e.map(i=>i.item_id);n.forEach(i=>s.add(i));const c=n.length>0?await i(n):[];for(const i of c){if(!i||a.has(i.id))continue;a.add(i.id);const e=await t(`https://api.guildwars2.com/v2/recipes/search?output=${i.id}`).then(i=>i.json());if(e&&e.length>0){const i=e[0],n=await t(`https://api.guildwars2.com/v2/recipes/${i}?lang=es`).then(i=>i.json());n&&n.ingredients&&await r(n.ingredients)}}}await r(n.ingredients);const c=new Map;if(s.size>0){const i=Array.from(s);for(let e=0;e<i.length;e+=200){const n=i.slice(e,e+200);(await t(`https://api.guildwars2.com/v2/items?ids=${n.join(",")}&lang=es`).then(i=>i.json())).forEach(i=>c.set(i.id,i))}}const l=new Map;if(s.size>0)try{const i=`https://api.datawars2.ie/gw2/v1/items/csv?fields=id,buy_price,sell_price&ids=${Array.from(s).join(",")}`,e=await t(i).then(i=>i.text()),[n,...a]=e.trim().split("\n").map(i=>i.split(","));if(n&&n.length>0&&a.length>0&&a[0].length===n.length)for(const i of a){const t={};n.forEach((e,n)=>{const s=i[n];t[e]="id"===e?parseInt(s,10):"buy_price"===e||"sell_price"===e?""!==s&&void 0!==s?parseInt(s,10):null:s}),t.id&&l.set(t.id,t)}}catch(i){}async function o(i,e,n=null){const s=c.get(i.item_id);if(!s)return null;let a=l.get(i.item_id);if(!a)try{const e=await t(`https://api.guildwars2.com/v2/commerce/prices/${i.item_id}`).then(i=>i.json());a={id:i.item_id,buy_price:e?.buys?.unit_price??null,sell_price:e?.sells?.unit_price??null},l.set(i.item_id,a)}catch(i){a={}}let r=[],p=null,u=!1;const d=await t(`https://api.guildwars2.com/v2/recipes/search?output=${i.item_id}`).then(i=>i.json());if(d&&d.length>0){const i=d[0];p=await t(`https://api.guildwars2.com/v2/recipes/${i}?lang=es`).then(i=>i.json()),p&&p.ingredients&&(u=!0,r=await Promise.all(p.ingredients.map(i=>o(i,p.output_item_count||1,s.id))),r=r.filter(i=>null!==i))}return{id:s.id,name:s.name,icon:s.icon,rarity:s.rarity,count:i.count,parentMultiplier:e,buy_price:void 0!==a.buy_price?a.buy_price:null,sell_price:void 0!==a.sell_price?a.sell_price:null,crafted_price:null,is_craftable:u,recipe:p,children:r,_parentId:n}}let p=[];n&&n.ingredients&&(p=await Promise.all(n.ingredients.map(i=>o(i,n.output_item_count||1,e))),p=p.filter(i=>null!==i));return p}(n,s);self.postMessage(e)}catch(i){self.postMessage({error:i.message})}};
