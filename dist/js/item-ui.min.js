import{setQtyInputValue as t,hideError as e,hideSkeleton as a,showSkeleton as o,showError as n,getQtyInputValue as d}from"./ui-helpers.min.js";import{register as l}from"./utils/stateManager.min.js";import{initLazyImages as i,observeSection as s}from"./utils/lazyLoader.min.js";let r=null,c=null;function m(t,e=1,a=null,o=0,n=!0,d=[]){return t.map((t,l)=>{const i=0===e?l:o,s=i%2==0?"row-bg-a":"row-bg-b",r=e>0?`style="padding-left:${30*e}px"`:"";t.id;const c=[...d,t._uid].join("-"),p=t.is_craftable&&t.children&&t.children.length?`<button class="btn-expand-path" data-path="${c}">${t.expanded?"-":"+"}</button>`:"",u=e>0,f=u?`child-of-${a}`:"",v=u&&!n?'style="display:none"':"",y=!t.buy_price&&!t.sell_price,b=t.is_craftable&&t.children&&t.children.length>0,h=0===e||b&&(y||null!=t.total_crafted)||!b&&null!=t.total_crafted,g="function"==typeof getRarityClass?getRarityClass(t.rarity):"";return`\n      <tr data-state-id="${t.id}" data-path="${c}" class="${u?`subrow subrow-${e} ${f}`:""} ${s}" ${v}>\n        <td class="th-border-left-items" ${r}><img data-src="${t.icon}" width="32" class="lazy-img" alt=""></td>\n        <td><a href="/item?id=${t.id}" class="item-link ${g}" target="_blank">${t.name}</a></td>\n        <td>${t.countTotal||t.count}</td>\n        <td class="item-solo-buy">\n          <div>${formatGoldColored(t.total_buy)}</div>\n          <div class="item-solo-precio">${formatGoldColored(t.buy_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${u?`<input type="radio" name="mode-${t._uid}" class="chk-mode-buy" data-uid="${t._uid}" ${"buy"===t.modeForParentCrafted?"checked":""} title="Usar precio de compra para el padre">`:""}\n        </td>\n        <td class="item-solo-sell">\n          <div>${formatGoldColored(t.total_sell)}</div>\n          <div class="item-solo-precio">${formatGoldColored(t.sell_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${u?`<input type="radio" name="mode-${t._uid}" class="chk-mode-sell" data-uid="${t._uid}" ${"sell"===t.modeForParentCrafted?"checked":""} title="Usar precio de venta para el padre">`:""}\n        </td>\n        <td class="item-solo-crafted">\n          ${h?`<div>${formatGoldColored(t.total_crafted||0)}</div><div class="item-solo-precio">${formatGoldColored(0)} <span style="color:#c99b5b">c/u</span></div>`+(u?`<input type="radio" name="mode-${t._uid}" class="chk-mode-crafted" data-uid="${t._uid}" ${"crafted"===t.modeForParentCrafted?"checked":""} title="Usar precio de crafteo para el padre">`:""):""}\n        </td>\n        <td class="th-border-right-items">${p}</td>\n      </tr>\n      ${t.is_craftable&&t.children&&t.children.length&&n&&t.expanded?m(t.children,e+1,t.id,i,t.expanded,[...d,t._uid]):""}\n    `}).join("")}function p(){const t=window.ingredientObjs||[];let e=1;const a=t.length>0?t[0]:null;a&&a.recipe&&a.recipe.output_item_count&&!isNaN(a.recipe.output_item_count)?e=a.recipe.output_item_count:window._mainRecipeOutputCount&&!isNaN(window._mainRecipeOutputCount)&&(e=window._mainRecipeOutputCount);let o={totalBuy:0,totalSell:0,totalCrafted:0},n=null;a&&a.children&&a.children.length>0&&(n=getTotals(),o.totalBuy=n.totalBuy,o.totalSell=n.totalSell),a&&(o.totalCrafted=null!=a.total_crafted?a.total_crafted:n?n.totalCrafted:0);const l=void 0!==d()?d():window.globalQty,i=a&&"number"==typeof a.buy_price?a.buy_price*l:0,s=a&&"number"==typeof a.sell_price?a.sell_price*l:0,r=Math.min(o.totalBuy,o.totalSell,o.totalCrafted),c=[i,s,r],p=Math.min(...c.filter(t=>t>0)),u=c.indexOf(p);let f="";f=0===u?"Mejor comprar (Buy)":1===u?"Mejor vender (Sell)":"Mejor craftear (Crafteo)";let v="";a&&(v+=function(t){if(!t)return"";let e={totalBuy:0,totalSell:0},a=0;if(t.children&&t.children.length>0){const o=getTotals();e.totalBuy=o.totalBuy,e.totalSell=o.totalSell,a=o.totalCrafted}const o={totalBuy:e.totalBuy,totalSell:e.totalSell,totalCrafted:null!=t.total_crafted?t.total_crafted:a},n=t.buy_price||0,d=t.sell_price||0,l="function"==typeof getRarityClass?getRarityClass(t.rarity):"",i=`<button class="btn-expand-path" data-path="${t._uid}">${t.expanded?"-":"+"}</button>`;return`\n    <tr data-state-id="${t.id}" class="ingred-row ${t.expanded?"expanded":""}" data-item-id="${t.id}">\n      \x3c!-- Col 1: Ícono (SIN colspan) --\x3e\n      <td class="th-border-left-items">\n        <img src="${t.icon}" width="32">\n      </td>\n\n      \x3c!-- Col 2: Nombre --\x3e\n      <td>\n        <span class="item-link ${l}">${t.name}</span>\n      </td>\n\n      \x3c!-- Col 3: Cantidad --\x3e\n      <td>${t.countTotal||t.count}</td>\n\n      \x3c!-- Col 4: Total Compra --\x3e\n      <td class="item-solo-buy">\n        <div>${formatGoldColored(o.totalBuy)}</div>\n        <div class="item-solo-precio">${formatGoldColored(n)} <span style="color:#c99b5b">c/u</span></div>\n      </td>\n\n      \x3c!-- Col 5: Total Venta --\x3e\n      <td class="item-solo-sell">\n        <div>${formatGoldColored(o.totalSell)}</div>\n        <div class="item-solo-precio">${formatGoldColored(d)} <span style="color:#c99b5b">c/u</span></div>\n      </td>\n\n      \x3c!-- Col 6: Total Crafteo --\x3e\n      <td class="item-solo-crafted">\n        <div>${formatGoldColored(o.totalCrafted)}</div>\n        <div class="item-solo-precio">${formatGoldColored(0)} <span style="color:#c99b5b">c/u</span></div>\n      </td>\n\n      \x3c!-- Col 7: Botón (alineado con hijos) --\x3e\n      <td class="th-border-right-items">${i}</td>\n    </tr>\n  `}(a),v+=m(a.children,1,null,0,!!a.expanded,[a._uid]));let y="",b="";if(s>0){const t=s-.15*s,a=t-o.totalBuy,n=t-o.totalSell,d=t-o.totalCrafted;if(1===e&&(y=`<section id='profit-section'><br>\n        <div class="table-modern-totales">\n        <div class="titulo-con-ayuda">\n          <div class="ayuda-tooltip">?\n            <span class="tooltiptext-modern"> Esta sección muestra la ganancia estimada al vender el ítem después de craftearlo. Se calcula como: (Precio venta - 15% comisión) - costo total de crafteo. También muestra 3 posibles resultados dependiendo de la forma de craftear.</span>\n          </div>\n          <h3>Profit si se craftea y se vende (ganancia estimada)</h3>\n        </div>\n        <table class='table-totales totales-crafting-comparativa' style='margin-bottom: 8px;'>\n          <tr style='text-align:center;'>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(a))} <br><span style='font-size:0.93em;'>Profit "Comprar"</span></div></td>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(n))} <br><span style='font-size:0.93em;'>Profit "Vender"</span></div></td>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(d))} <br><span style='font-size:0.93em;'>Profit "Craftear"</span></div></td>\n          </tr>\n          <tr><td colspan='3' style='text-align:center;font-size:0.98em;color:#a1a1aa;'>La ganancia se calcula como: (Precio venta - 15% comisión) - costo total</td></tr>\n        </table>\n      </div>\n      </section>`),e>1){const t=null!=_mainSellPrice?_mainSellPrice:0,a=t-.15*t,n=a-o.totalBuy/e,d=a-o.totalSell/e,l=a-o.totalCrafted/e;b=`<section id='profit-section-unidad'><br>\n        <div class="table-modern-totales">          \n        <h3>Profit si se craftea y se vende por UNIDAD (ganancia estimada)</h3>\n        <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${e}</b> unidades por crafteo. Los siguientes cálculos son por unidad.</div>\n        <table class='table-totales totales-crafting-comparativa' style='margin-bottom: 8px;'>\n          <tr style='text-align:center;'>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(n))} <br><span style='font-size:0.93em;'>Profit "Comprar"</span></div></td>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(d))} <br><span style='font-size:0.93em;'>Profit "Vender"</span></div></td>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(l))} <br><span style='font-size:0.93em;'>Profit "Craftear"</span></div></td>\n          </tr>\n          <tr><td colspan='3' style='text-align:center;font-size:0.98em;color:#a1a1aa;'>La ganancia por unidad se calcula como: (Precio venta unitario - 15% comisión) - costo unitario</td></tr>\n        </table>\n      </div>\n      </section>`}}let h=`<div id="qty-global-container" style="margin:18px 0 18px 0;display:flex;align-items:center;gap:12px;">\n    <label for="qty-global" style="font-weight:500;">Cantidad global:</label>\n    <input id="qty-global" type="number" min="1" value="${l}" style="width:60px;height:36px;" autocomplete="off">\n  </div>`,g=`<div class="table-modern-totales">\n    <div class="titulo-con-ayuda">\n      <div class="ayuda-tooltip">?\n        <span class="tooltiptext-modern">Esta sección muestra el costo total de los materiales necesarios para craftear el ítem. Con costo de materiales en venta directa, pedido y crafteo de sus propio materiales.</span>\n      </div>\n      <h3>Precio total materiales - Crafting</h3>\n    </div>\n    <div id="totales-crafting">      \n      <table class="table-totales" style="margin-top:12px;">\n        <tr>\n          <th><div class="tooltip-modern">Total Compra\n            <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-buy">${formatGoldColored(o.totalBuy)} </td>\n          <th><div class="tooltip-modern">Total Venta\n            <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-sell">${formatGoldColored(o.totalSell)}</td>\n          <th><div class="tooltip-modern">Total Crafteo\n            <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n          </div></th>\n          <td class="item-solo-crafted">${formatGoldColored(o.totalCrafted)}</td>\n        </tr>\n      </table>\n    </div>\n    </div>`,$="";e>1&&($=`<div class="table-modern-totales">\n    <div class="titulo-con-ayuda">\n      <div class="ayuda-tooltip">?\n        <span class="tooltiptext-modern">Muestra el costo por unidad ya que esta receta produce múltiples ítems</span>\n      </div>\n      <h3>Costos por unidad (${e} unidades por crafteo)</h3>\n    </div>\n    <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${e}</b> unidades por crafteo.</div>\n      <div id="totales-crafting">\n        <table class="table-totales" style="margin-top:12px;">\n          <tr>\n            <th><div class="tooltip-modern">Total Compra\n              <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-buy">${formatGoldColored(o.totalBuy/e)}</td>\n            <th><div class="tooltip-modern">Total Venta\n              <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-sell">${formatGoldColored(o.totalSell/e)}</td>\n            <th><div class="tooltip-modern">Total Crafteo\n              <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n            </div></th>\n            <td class="item-solo-crafted">${formatGoldColored(o.totalCrafted/e)}</td>\n          </tr>\n        </table>\n      </div>\n    </div>`);let _="",w="";if(1===e&&(_=`<section id='comparativa-section'>\n      <div class="table-modern-totales">\n        <div class="titulo-con-ayuda">\n          <div class="ayuda-tooltip">?\n            <span class="tooltiptext-modern"> Esta sección compara el precio de compra directa y pedido en el mercado con el costo de crafteo más bajo.</span>\n          </div>\n          <h3>Comparativa de precios de Bazar vs Crafting</h3>\n        </div>\n        <br>\n        <table class='table-totales totales-crafting-comparativa'>\n          <tr style='text-align:center;'>\n            <td><div class='base-comparativa' style='${0===u?"background:#e84d4d33;":""}'>${formatGoldColored(i)} <br><span style='font-size:0.93em;'>Precio compra</span></div></td>\n            <td><div class='base-comparativa' style='${1===u?"background:#4db1e833;":""}'>${formatGoldColored(s)} <br><span style='font-size:0.93em;'>Precio venta</span></div></td>\n            <td><div class='base-comparativa' style='${2===u?"background:#4fc17833;":""}'>${formatGoldColored(r)} <br><span style='font-size:0.93em;'>Precio crafting más bajo</span></div></td>\n          </tr>\n          <tr><td colspan='3' style='text-align:center;font-size:1.07em;'>${f}</td></tr>\n        </table>\n      </div>\n      </section>`),e>1){const t=window.globalQty||1,a=null!=_mainBuyPrice?_mainBuyPrice*t:0,o=null!=_mainSellPrice?_mainSellPrice*t:0,n=e>0?r/e:r,d=[a,o,n],l=Math.min(...d.filter(t=>t>0)),i=d.indexOf(l);w=`<section id='comparativa-section-unidad'>\n      <div class="table-modern-totales"><br>\n        <h3>Comparativa de precios de Bazar vs Crafting por UNIDAD</h3>\n        <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${e}</b> unidades por crafteo. Los siguientes precios son por unidad.</div>\n        <table class='table-totales totales-crafting-comparativa'>\n          <tr style='text-align:center;'>\n            <td><div style='${0===i?"background:#e84d4d33;font-weight:bold;border-radius:6px;padding:10px;":""}'>${formatGoldColored(a)} <br><span style='font-size:0.93em;'>Precio compra</span></div></td>\n            <td><div style='${1===i?"background:#4db1e833;font-weight:bold;border-radius:6px;padding:10px;":""}'>${formatGoldColored(o)} <br><span style='font-size:0.93em;'>Precio venta</span></div></td>\n            <td><div style='${2===i?"background:#4fc17833;font-weight:bold;border-radius:6px;padding:10px;":""}'>${formatGoldColored(n)} <br><span style='font-size:0.93em;'>Precio crafting más bajo</span></div></td>\n          </tr>\n          <tr><td colspan='3' style='text-align:center;font-size:1.07em;'>${f}</td></tr>\n        </table>\n      </div>\n      </section>`}return`\n    ${h}\n    <table class="table-modern tabla-tarjetas">\n      <thead class="header-items">\n        <tr>\n          <th class="th-border-left">Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n          <th>Total Crafteo</th>\n          <th class="th-border-right"></th>\n        </tr>\n      </thead>\n      \x3c!-- 👇 Aquí va la tabla correcta: root + hijos --\x3e\n      <tbody>${v}</tbody>\n    </table>\n    ${g}\n    ${e>1?$:""}\n    ${_}\n    ${e>1?w:""}\n    ${y}\n    ${e>1?b:""}\n  `}async function u(t,e){const o=document.getElementById("item-header");let n="";if(t.details?.disciplines?.length>0||t.details?.min_rating>0){const e={Artificer:"Artesano",Armorsmith:"Armero",Chef:"Cocinero",Huntsman:"Cazador",Jeweler:"Joyero",Leatherworker:"Peletero",Tailor:"Sastre",Weaponsmith:"Armero de armas",Scribe:"Escriba"},a=(t.details.disciplines||[]).map(t=>e[t]||t);n=`\n      <div style="margin-top: 4px; color: #a1a1aa; font-size: 0.95rem;">\n        ${t.details.min_rating?`<span style="color: #16c198; font-weight: 500;">Nivel:</span> ${t.details.min_rating} `:""}\n        ${a.length>0?`<span style="color: #16c198; font-weight: 500;">${t.details.min_rating?"• ":""}Disciplinas:</span> ${a.join(", ")}`:""}\n      </div>\n    `}const d="function"==typeof getRarityClass?getRarityClass(t.rarity):"";o.innerHTML=`\n    <img src="${t.icon}" alt=""/>\n    <div>\n      <h2 class="${d}">${t.name}</h2>\n      <div style="color:#a1a1aa;font-size:1.05rem;">\n        ID: ${t.id} &nbsp;|&nbsp; ${t.type} ${t.rarity?" - "+t.rarity:""}\n      </div>\n      ${n}\n    </div>\n  `,formatGoldColored(e.buy_price),formatGoldColored(e.sell_price),e.sell_quantity,e.buy_quantity;const r=document.getElementById("resumen-mercado");if(r){const t=document.createElement("div");t.classList.add("skeleton","skeleton-market-summary"),r.appendChild(t),s(r,()=>{a(t),r.insertAdjacentHTML("beforeend",function(t){return`\n      <table class="table-modern">\n        <tr>\n          <th><div class="dato-item tooltip-modern">Precio de compra\n            <span class="tooltiptext-modern">Precio al que los compradores están dispuestos a adquirir el ítem (mejor oferta de compra).</span>\n          </div></th>\n          <td><div class="dato-item-info">${formatGoldColored(t.buy_price)}</div></td>\n        </tr>\n        <tr>\n          <th><div class="dato-item tooltip-modern">Precio de venta\n            <span class="tooltiptext-modern">Precio al que los vendedores ofrecen el ítem (mejor oferta de venta).</span>\n          </div></th>\n          <td><div class="dato-item-info">${formatGoldColored(t.sell_price)}</div></td>\n        </tr>\n        <tr>\n          <th><div class="dato-item tooltip-modern">Disponibles para vender\n            <span class="tooltiptext-modern">Cantidad total de ítems listados actualmente para vender en el mercado.</span>\n          </div></th>\n          <td><div class="dato-item-info">${t.sell_quantity??"-"}</div></td>\n        </tr>\n        <tr>\n          <th><div class="dato-item tooltip-modern">Disponibles para comprar\n            <span class="tooltiptext-modern">Cantidad total de ítems que los compradores buscan adquirir en el mercado.</span>\n          </div></th>\n          <td><div class="dato-item-info">${t.buy_quantity??"-"}</div></td>\n        </tr>\n      </table>\n      <section id="ventas-compras" class="bloque-section">\n        <h3>Ventas y Compras Recientes</h3>\n        <table class="table-modern">\n          <tr><th></th><th style="text-align:center;">1 día</th><th style="text-align:center;">2 días</th><th style="text-align:center;">7 días</th><th style="text-align:center;">1 mes</th></tr>\n          <tr>\n            <th><div class="dato-item tooltip-modern">Ventas\n                <span class="tooltiptext-modern">Cantidad de ítems comprados directamente en el periodo (actividad de salida del mercado).</span>\n                </div>\n            </th>\n            <td><div class="dato-item-info">${t["1d_sell_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${t["2d_sell_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${t["7d_sell_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${t["1m_sell_sold"]??"-"}</div></td>\n          </tr>\n          <tr>\n            <th><div class="dato-item tooltip-modern">Compras\n                <span class="tooltiptext-modern">Cantidad de ítems vendidos directamente en el periodo (actividad de entrada al mercado).</span>\n                </div></th>\n            <td><div class="dato-item-info">${t["1d_buy_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${t["2d_buy_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${t["7d_buy_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${t["1m_buy_sold"]??"-"}</div></td>\n          </tr>\n          <tr><td colspan="5" style="color:#888;font-size:0.95em;">* Basado en actividad reciente.</td></tr>\n        </table>\n      </section>\n      <section id="porcentajes-rotacion" class="bloque-section">\n        <h3>Porcentajes de Rotación</h3>\n        <table class="table-modern">\n          <tr><th></th><th style="text-align:center;">1 día</th><th style="text-align:center;">2 días</th><th style="text-align:center;">7 días</th><th style="text-align:center;">1 mes</th></tr>\n          <tr>\n            <th><div class="dato-item tooltip-modern">Ventas/Supply\n                <span class="tooltiptext-modern">Porcentaje de ítems comprados directamente respecto al total disponible (rotación de inventario en el mercado).</span>\n                </div></th>\n            <td><div class="dato-item-info">${calcPercent(t["1d_sell_sold"],t.sell_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(t["2d_sell_sold"],t.sell_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(t["7d_sell_sold"],t.sell_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(t["1m_sell_sold"],t.sell_quantity)}</div></td>\n          </tr>\n          <tr>\n            <th><div class="dato-item tooltip-modern">Compras/Demand\n                <span class="tooltiptext-modern">Porcentaje de ítems vendidos directamente respecto a la demanda total (flujo de entrada al mercado).</span>\n                </div></th>\n            <td><div class="dato-item-info">${calcPercent(t["1d_buy_sold"],t.buy_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(t["2d_buy_sold"],t.buy_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(t["7d_buy_sold"],t.buy_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(t["1m_buy_sold"],t.buy_quantity)}</div></td>\n          </tr>\n          <tr><td colspan="5" style="color:#888;font-size:0.95em;">* Basado en actividad reciente comparada con la cantidad disponible.</td></tr>\n        </table>\n      </section>\n  `}(e))})}const c=document.getElementById("info-item");c&&(window.ingredientObjs&&window.ingredientObjs.length>0&&recalcAll(window.ingredientObjs,window.globalQty),c.innerHTML='\n      <div id="seccion-totales"></div>\n      <div id="seccion-comparativa"></div>\n      <div id="seccion-crafting"></div>\n    ',document.getElementById("seccion-totales").innerHTML="",document.getElementById("seccion-comparativa").innerHTML="",document.getElementById("seccion-crafting").innerHTML=p(),document.querySelectorAll("#seccion-crafting tr[data-state-id]").forEach(t=>{const e=t.getAttribute("data-state-id");l(e,t,e=>{const a=t.querySelector(".item-solo-buy");a&&(a.innerHTML=`<div>${formatGoldColored(e.total_buy)}</div><div class="item-solo-precio">${formatGoldColored(e.buy_price)} <span style="color: #c99b5b">c/u</span></div>`);const o=t.querySelector(".item-solo-sell");o&&(o.innerHTML=`<div>${formatGoldColored(e.total_sell)}</div><div class="item-solo-precio">${formatGoldColored(e.sell_price)} <span style="color: #c99b5b">c/u</span></div>`);const n=t.querySelector(".item-solo-crafted");n&&(n.innerHTML=`<div>${formatGoldColored(e.total_crafted||0)}</div><div class="item-solo-precio">${formatGoldColored(0)} <span style="color:#c99b5b">c/u</span></div>`)})}),requestAnimationFrame(()=>{i(),setTimeout(i,0)})),function(t){if(!t)return;const e=encodeURIComponent(t.replaceAll(" ","_")),a=`https://wiki.guildwars2.com/wiki/es:${e}`,o=`https://wiki.guildwars2.com/wiki/${e}`,n=document.getElementById("wiki-links");n&&(n.innerHTML=`\n    <div class="wiki-links">\n      <a href="${a}" target="_blank">Wiki en Español</a>\n      <a href="${o}" target="_blank">Wiki en Inglés</a>\n    </div>\n  `)}(t.name),f()}function f(){window._uiEventsInstalled||(window._uiEventsInstalled=!0,window._qtyGlobalHandlerInstalled||(window._qtyGlobalHandlerInstalled=!0,document.addEventListener("input",function(t){t.target&&"qty-global"===t.target.id&&(window._qtyInputValue=t.target.value)}),document.addEventListener("blur",function(t){if(t.target&&"qty-global"===t.target.id){const e=t.target;let a=parseInt(e.value,10);isNaN(a)||a<1?(setGlobalQty(1),window._qtyInputValue="1"):(setGlobalQty(a),window._qtyInputValue=e.value),void 0!==window._qtyInputValue&&String(window._qtyInputValue)===String(window.globalQty)&&delete window._qtyInputValue,v()}},!0),document.addEventListener("keydown",function(t){if(t.target&&"qty-global"===t.target.id&&"Enter"===t.key){t.preventDefault();const e=t.target;let a=parseInt(e.value,10);isNaN(a)||a<1?(setGlobalQty(1),window._qtyInputValue="1"):(setGlobalQty(a),window._qtyInputValue=e.value),void 0!==window._qtyInputValue&&String(window._qtyInputValue)===String(window.globalQty)&&delete window._qtyInputValue,v()}})),document.addEventListener("change",function(t){const e=t.target;if(!e.matches(".chk-mode-buy, .chk-mode-sell, .chk-mode-crafted"))return;const a=e.dataset.uid;if(!a)return;const o=findIngredientByUid(window.ingredientObjs||[],a);o&&(e.classList.contains("chk-mode-buy")?o.modeForParentCrafted="buy":e.classList.contains("chk-mode-sell")?o.modeForParentCrafted="sell":e.classList.contains("chk-mode-crafted")&&(o.modeForParentCrafted="crafted"),recalcAll(window.ingredientObjs,window.globalQty),v())}),document.addEventListener("click",function(t){const e=t.target.closest(".btn-expand-path");if(!e)return;const a=e.getAttribute("data-path");if(!a)return;const o=a.split("-").map(t=>t.trim()),n=findIngredientByPath(window.ingredientObjs||[],o);n&&(n.expanded=!n.expanded,v())}))}function v(){recalcAll(window.ingredientObjs||[],window.globalQty);const t=document.getElementById("seccion-crafting");if(t){const e=document.getElementById("qty-global"),a=e?e.value:window.globalQty,o=snapshotExpandState(window.ingredientObjs||[]);t.innerHTML=p(),document.querySelectorAll("#seccion-crafting tr[data-state-id]").forEach(t=>{const e=t.getAttribute("data-state-id");l(e,t,e=>{const a=t.querySelector(".item-solo-buy");if(a){const t=a.querySelector("div:first-child"),o=a.querySelector(".item-solo-precio");t&&(t.innerHTML=formatGoldColored(e.total_buy)),o&&(o.innerHTML=`${formatGoldColored(e.buy_price)} <span style="color: #c99b5b">c/u</span>`)}const o=t.querySelector(".item-solo-sell");if(o){const t=o.querySelector("div:first-child"),a=o.querySelector(".item-solo-precio");t&&(t.innerHTML=formatGoldColored(e.total_sell)),a&&(a.innerHTML=`${formatGoldColored(e.sell_price)} <span style="color: #c99b5b">c/u</span>`)}const n=t.querySelector(".item-solo-crafted");if(n){const t=n.querySelector("div:first-child"),a=n.querySelector(".item-solo-precio");t&&(t.innerHTML=formatGoldColored(e.total_crafted||0)),a&&(a.innerHTML=`${formatGoldColored(0)} <span style="color:#c99b5b">c/u</span>`)}})});const n=document.getElementById("qty-global");n&&(n.value=a),restoreExpandState(window.ingredientObjs||[],o),requestAnimationFrame(()=>{i(),setTimeout(i,0)})}}async function y(t,o){window._lastItemData=t,window._lastMarketData=o;const n=document.getElementById("item-skeleton");e();try{await u(t,o)}finally{a(n)}}document.addEventListener("item-basic",t=>{r=t.detail}),document.addEventListener("item-market",t=>{c=t.detail}),document.addEventListener("item-ingredients",()=>{r&&c&&(y(r,c),v())}),window.safeRenderTable=v,setTimeout(()=>{t(),document.getElementById("qty-global")},0),setTimeout(()=>{f()},0),window.showSkeleton=o,window.hideSkeleton=a,window.showError=n,window.hideError=e,window.renderItemUI=u,window.installUIEvents=f,window.initItemUI=y;
