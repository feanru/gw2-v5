async function r(){try{const r=await fetch("backend/api/favorites.php");if(!r.ok)return[];const e=await r.json();return Array.isArray(e)?e.map(r=>({id:parseInt(r,10)})):[]}catch(r){return console.error("Error obteniendo favoritos",r),[]}}async function e(){try{const r=await fetch("backend/api/comparisons.php");if(!r.ok)return[];const e=await r.json(),t=r=>{if(!r)return[];try{return Array.isArray(r)?r:JSON.parse(r)}catch{return[]}},a=(r,e,t)=>{if(r)try{return(Array.isArray(r)?r:JSON.parse(r)).map(r=>Number(r))}catch{}return[Number(e),Number(t)].filter(r=>!isNaN(r))};return Array.isArray(e)?e.map(r=>({id:r.id,ids:a(r.item_ids,r.item_left,r.item_right),nombres:t(r.item_names)})):[]}catch(r){return console.error("Error obteniendo comparativas",r),[]}}window.StorageUtils={saveFavorito:async function(e){if(!e||!e.id)return[];try{await fetch("backend/api/favorites.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id:e.id})})}catch(r){console.error("Error guardando favorito",r)}return navigator.serviceWorker?.controller?.postMessage({type:"invalidate",url:"backend/api/favorites.php"}),r()},getFavoritos:r,removeFavorito:async function(e){try{await fetch(`backend/api/favorites.php?item_id=${e}`,{method:"DELETE"})}catch(r){console.error("Error eliminando favorito",r)}return navigator.serviceWorker?.controller?.postMessage({type:"invalidate",url:"backend/api/favorites.php"}),r()},saveComparativa:async function(r){if(!r||!Array.isArray(r.ids)||r.ids.length<2)return[];try{await fetch("backend/api/comparisons.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_ids:r.ids,item_names:r.nombres})})}catch(r){console.error("Error guardando comparativa",r)}return navigator.serviceWorker?.controller?.postMessage({type:"invalidate",url:"backend/api/comparisons.php"}),e()},getComparativas:e,removeComparativa:async function(r){try{await fetch(`backend/api/comparisons.php?id=${r}`,{method:"DELETE"})}catch(r){console.error("Error eliminando comparativa",r)}return navigator.serviceWorker?.controller?.postMessage({type:"invalidate",url:"backend/api/comparisons.php"}),e()},showToast:function(r,e="success"){let t=document.getElementById("toast-container");t||(t=document.createElement("div"),t.id="toast-container",t.className="toast-container",document.body.appendChild(t));const a=document.createElement("div");a.className=`toast toast-${e}`,a.style.opacity="0",a.textContent=r,t.appendChild(a),setTimeout(()=>{a.style.opacity="1"},10),setTimeout(()=>{a.style.opacity="0",setTimeout(()=>{a.remove(),0===t.children.length&&t.remove()},300)},3e3)}};
