window.transformRecipeToIngredient=async function(e,i=1,t=1){try{if(!e||!e.output_item_id)return console.error("[ERROR] Receta inválida o sin output_item_id:",e),null;const r=[e.output_item_id,...(e.ingredients||[]).map(e=>e.item_id)],n=await getItemBundles(r),o=new Map;n.forEach(e=>{e&&o.set(e.id,e)});const c=o.get(e.output_item_id);if(!c||!c.item)return console.warn(`[WARN] No se pudo obtener detalles para el ítem ${e.output_item_id}`),null;const a=c.market||{},l={id:e.output_item_id,name:c.item.name||"Ítem desconocido",icon:c.item.icon||"",rarity:c.item.rarity,count:i,parentMultiplier:t,buy_price:a.buy_price||0,sell_price:a.sell_price||0,is_craftable:"GuildConsumable"!==e.type,recipe:{id:e.id,type:e.type,output_item_count:e.output_item_count||1,min_rating:e.min_rating,disciplines:e.disciplines||[]},children:[]};return l.id&&l.name?(e.ingredients&&e.ingredients.length>0&&(l.children=e.ingredients.map(e=>{const i=o.get(e.item_id)||{},t=i.item||{},r=i.market||{};return{id:e.item_id,name:t.name||"Ítem desconocido",icon:t.icon||"",rarity:t.rarity,count:e.count,parentMultiplier:1,buy_price:r.buy_price||0,sell_price:r.sell_price||0,is_craftable:!!i.recipe,children:[]}})),l):(console.error("[ERROR] Estructura de ingrediente inválida:",l),null)}catch(e){return console.error("Error en transformRecipeToIngredient:",e),null}},window.getAndTransformRecipes=async function(e){try{const i=await getRecipesForItem(e);if(!i||0===i.length)return[];return(await Promise.all(i.map(e=>window.transformRecipeToIngredient(e)))).filter(Boolean)}catch(e){return console.error("Error en getAndTransformRecipes:",e),[]}},window.loadIngredientTree=async function(e,i=0,t=3){if(i>=t||!e.is_craftable)return e;try{const r=await getRecipesForItem(e.id);if(0===r.length)return e;const n=r[0];return n?(e.children=await Promise.all(n.ingredients.map(async e=>{const r=await getRecipesForItem(e.item_id);let n=null;if(r.length>0){const i=r[0];i&&(n=await transformRecipeToIngredient(i,e.count,1))}if(!n){const i=(await getItemBundles([e.item_id]))[0]||{},t=i.item||{},r=i.market||{};n={id:e.item_id,name:t.name||"",icon:t.icon||"",rarity:t.rarity,count:e.count,parentMultiplier:1,buy_price:r.buy_price||0,sell_price:r.sell_price||0,is_craftable:!1,children:[]}}return n.is_craftable?await loadIngredientTree(n,i+1,t):n})),e):e}catch(i){return console.error(`Error cargando ingrediente ${e.id}:`,i),e}};
