{"version":3,"file":"search-modal-core.min.js","sources":["../../src/js/search-modal-core.js"],"sourcesContent":["// search-modal-core.js\n// Funciones base reutilizables para el modal de búsqueda\n\n// Endpoints para obtener la lista de ítems\nconst API_URL_JSON = 'https://api.datawars2.ie/gw2/v1/items/json?fields=id,name_es';\nconst API_URL_CSV = 'https://api.datawars2.ie/gw2/v1/items/csv?fields=buy_price,sell_price,buy_quantity,sell_quantity,last_updated,1d_buy_sold,1d_sell_sold,2d_buy_sold,2d_sell_sold,7d_buy_sold,7d_sell_sold,1m_buy_sold,1m_sell_sold';\nimport { requestItems } from './utils/requestManager.js';\nimport fetchWithRetry from './utils/fetchWithRetry.js';\n\nfunction initSearchModal(options = {}) {\n  const {\n    onSelect = function(id) {},\n    formatPrice = null,\n    useSuggestions = false\n  } = options;\n\n  const searchInput = document.getElementById('modal-search-input');\n  const suggestionsEl = document.getElementById('modal-suggestions');\n    const resultsEl = document.getElementById('modal-results');\n    const modalSkeleton = document.getElementById('modal-skeleton');\n  const errorMessage = document.getElementById('modal-error-message');\n\n  let allItems = [];\n  const iconCache = {};\n  const rarityCache = {};\n\n  function toggleModalSkeleton(show) {\n    if (modalSkeleton) modalSkeleton.classList.toggle('hidden', !show);\n  }\n  function showError(msg) {\n    if (!errorMessage) return;\n    errorMessage.textContent = msg;\n    errorMessage.style.display = 'block';\n  }\n  function hideError() {\n    if (errorMessage) errorMessage.style.display = 'none';\n  }\n\n  async function fetchAllItems() {\n    const cached = sessionStorage.getItem('itemList');\n    if (cached) {\n      allItems = JSON.parse(cached);\n      return;\n    }\n    hideError();\n    try {\n      const [resJson, resCsv] = await Promise.all([\n        fetchWithRetry(API_URL_JSON),\n        fetchWithRetry(API_URL_CSV)\n      ]);\n      const [itemsJson, csvText] = await Promise.all([\n        resJson.json(),\n        resCsv.text()\n      ]);\n      const lines = csvText.trim().split('\\n');\n      const headers = lines[0].split(',');\n      const itemsCsv = lines.slice(1).map(line => {\n        const values = line.split(',');\n        const obj = {};\n        headers.forEach((h, i) => {\n          if (h === 'last_updated') {\n            obj[h] = values[i] || '-';\n          } else if (h === 'buy_price' || h === 'sell_price') {\n            obj[h] = values[i] !== '' ? parseInt(values[i], 10) : null;\n          } else {\n            obj[h] = values[i] !== '' ? parseInt(values[i], 10) : null;\n          }\n        });\n        return obj;\n      });\n      const csvById = {};\n      itemsCsv.forEach(item => { csvById[Number(item.id)] = item; });\n      allItems = itemsJson.map(item => ({\n        ...item,\n        ...(csvById[Number(item.id)] || {})\n      }));\n      sessionStorage.setItem('itemList', JSON.stringify(allItems));\n    } catch (e) {\n      showError('No se pudieron cargar los ítems.');\n    }\n  }\n\n  function renderSuggestions(matches) {\n    if (!useSuggestions) {\n      if (suggestionsEl) {\n        suggestionsEl.innerHTML = '';\n        suggestionsEl.style.display = 'none';\n      }\n      return;\n    }\n    if (!suggestionsEl) return;\n    suggestionsEl.innerHTML = '';\n    if (!matches.length) {\n      suggestionsEl.style.display = 'none';\n      return;\n    }\n    const frag = document.createDocumentFragment();\n    matches.forEach(item => {\n      const li = document.createElement('li');\n      li.textContent = item.name_es;\n      li.onclick = () => onSelect(item.id);\n      frag.appendChild(li);\n    });\n    suggestionsEl.appendChild(frag);\n    suggestionsEl.style.display = 'block';\n  }\n\n  function renderResults(items, showNoResults = false) {\n    if (!resultsEl) return;\n    resultsEl.innerHTML = '';\n    if (!items.length && showNoResults) {\n      resultsEl.innerHTML = '<div class=\"error-message\">No se encontraron ítems.</div>';\n      return;\n    }\n    const fragment = document.createDocumentFragment();\n    items.forEach(item => {\n      const card = document.createElement('div');\n      card.className = 'item-card';\n      card.onclick = (e) => onSelect(item.id, e);\n      const rarityClass = typeof getRarityClass === 'function'\n          ? getRarityClass(rarityCache[item.id])\n          : '';\n      const buy = formatPrice ? formatPrice(item.buy_price) : (item.buy_price || 0);\n      const sell = formatPrice ? formatPrice(item.sell_price) : (item.sell_price || 0);\n      card.innerHTML = `\n      <img src=\"${iconCache[item.id] || ''}\" alt=\"\"/>\n      <div class=\"item-name ${rarityClass}\">${item.name_es}</div>\n      <div class=\"item-price\" style=\"display:none;\">Compra: ${buy} | Venta: ${sell}</div>\n    `;\n      fragment.appendChild(card);\n    });\n    resultsEl.appendChild(fragment);\n  }\n\n  function debounce(fn, ms) {\n    let timer;\n    return function(...args) {\n      clearTimeout(timer);\n      timer = setTimeout(() => fn.apply(this, args), ms);\n    };\n  }\n\n  async function fetchIconsFor(ids) {\n    if (!ids.length) return;\n    try {\n      const data = await requestItems(ids);\n      data.forEach(item => {\n        if (!item) return;\n        iconCache[item.id] = item.icon;\n        rarityCache[item.id] = item.rarity;\n      });\n    } catch {}\n  }\n\n  function normalizeStr(str) {\n    return str.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').toLowerCase();\n  }\n\n  if (searchInput) {\n    searchInput.addEventListener('input', debounce(async function() {\n      const value = this.value.trim().toLowerCase();\n      if (value.length < 3) {\n        if (useSuggestions && suggestionsEl) suggestionsEl.style.display = 'none';\n        if (resultsEl) resultsEl.innerHTML = '';\n        toggleModalSkeleton(false);\n        return;\n      }\n      toggleModalSkeleton(true);\n      const normalValue = normalizeStr(value);\n      let matches = allItems.filter(item => item.name_es && normalizeStr(item.name_es).includes(normalValue));\n      matches = matches.slice(0, 30);\n      const missingIcons = matches.filter(i => !iconCache[i.id]).map(i => i.id);\n      if (missingIcons.length) await fetchIconsFor(missingIcons);\n      toggleModalSkeleton(false);\n      renderSuggestions(matches);\n      renderResults(matches, true);\n    }, 250));\n  }\n\n  (async function init() {\n    toggleModalSkeleton(true);\n    await fetchAllItems();\n    renderResults([]);\n    toggleModalSkeleton(false);\n  })();\n}\n\nif (typeof window !== 'undefined') {\n  window.initSearchModal = initSearchModal;\n}\n\nif (typeof module !== 'undefined' && module.exports) {\n  module.exports.initSearchModal = initSearchModal;\n}\n\n"],"names":["initSearchModal","options","onSelect","id","formatPrice","useSuggestions","searchInput","document","getElementById","suggestionsEl","resultsEl","modalSkeleton","errorMessage","allItems","iconCache","rarityCache","toggleModalSkeleton","show","classList","toggle","async","fetchAllItems","cached","sessionStorage","getItem","JSON","parse","style","display","resJson","resCsv","Promise","all","fetchWithRetry","itemsJson","csvText","json","text","lines","trim","split","headers","itemsCsv","slice","map","line","values","obj","forEach","h","i","parseInt","csvById","item","Number","setItem","stringify","e","msg","textContent","renderResults","items","showNoResults","innerHTML","length","fragment","createDocumentFragment","card","createElement","className","onclick","rarityClass","getRarityClass","buy","buy_price","sell","sell_price","name_es","appendChild","normalizeStr","str","normalize","replace","toLowerCase","addEventListener","fn","ms","timer","args","clearTimeout","setTimeout","apply","this","debounce","value","normalValue","matches","filter","includes","missingIcons","ids","requestItems","icon","rarity","fetchIconsFor","frag","li","renderSuggestions","window","module","exports"],"mappings":"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"}