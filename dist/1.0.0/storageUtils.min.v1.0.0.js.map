{"version":3,"file":"storageUtils.min.js","sources":["../../src/js/storageUtils.js"],"sourcesContent":["// storageUtils.js - async helpers using backend API\nimport fetchWithRetry from './utils/fetchWithRetry.js';\n\n/** Obtiene los favoritos del usuario desde el backend */\nasync function getFavoritos() {\n    try {\n        const r = await fetchWithRetry('backend/api/favorites.php');\n        if (!r.ok) return [];\n        const data = await r.json();\n        return Array.isArray(data) ? data.map(id => ({ id: parseInt(id, 10) })) : [];\n    } catch (e) {\n        console.error('Error obteniendo favoritos', e);\n        return [];\n    }\n}\n\n/** Guarda un Ã­tem como favorito en el backend */\nasync function saveFavorito(item) {\n    if (!item || !item.id) return [];\n    try {\n        await fetchWithRetry('backend/api/favorites.php', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({ item_id: item.id })\n        });\n    } catch (e) {\n        console.error('Error guardando favorito', e);\n    }\n    navigator.serviceWorker?.controller?.postMessage({\n        type: 'invalidate',\n        url: 'backend/api/favorites.php'\n    });\n    return getFavoritos();\n}\n\n/** Elimina un favorito en el backend */\nasync function removeFavorito(itemId) {\n    try {\n        await fetchWithRetry(`backend/api/favorites.php?item_id=${itemId}`, { method: 'DELETE' });\n    } catch (e) {\n        console.error('Error eliminando favorito', e);\n    }\n    navigator.serviceWorker?.controller?.postMessage({\n        type: 'invalidate',\n        url: 'backend/api/favorites.php'\n    });\n    return getFavoritos();\n}\n\n/** Obtiene las comparativas guardadas desde el backend */\nasync function getComparativas() {\n    try {\n        const r = await fetchWithRetry('backend/api/comparisons.php');\n        if (!r.ok) return [];\n        const data = await r.json();\n        const parseNames = (names) => {\n            if (!names) return [];\n            try {\n                return Array.isArray(names) ? names : JSON.parse(names);\n            } catch {\n                return [];\n            }\n        };\n        const parseIds = (ids, left, right) => {\n            if (ids) {\n                try {\n                    const arr = Array.isArray(ids) ? ids : JSON.parse(ids);\n                    return arr.map(n => Number(n));\n                } catch { /* ignore */ }\n            }\n            return [Number(left), Number(right)].filter(n => !isNaN(n));\n        };\n        return Array.isArray(data)\n            ? data.map(c => ({\n                id: c.id,\n                ids: parseIds(c.item_ids, c.item_left, c.item_right),\n                nombres: parseNames(c.item_names)\n            }))\n            : [];\n    } catch (e) {\n        console.error('Error obteniendo comparativas', e);\n        return [];\n    }\n}\n\n/** Guarda una comparativa (usa los dos primeros IDs) */\nasync function saveComparativa(comparativa) {\n    if (!comparativa || !Array.isArray(comparativa.ids) || comparativa.ids.length < 2) return [];\n    try {\n        await fetchWithRetry('backend/api/comparisons.php', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n                item_ids: comparativa.ids,\n                item_names: comparativa.nombres\n            })\n        });\n    } catch (e) {\n        console.error('Error guardando comparativa', e);\n    }\n    navigator.serviceWorker?.controller?.postMessage({\n        type: 'invalidate',\n        url: 'backend/api/comparisons.php'\n    });\n    return getComparativas();\n}\n\n/** Elimina una comparativa por id */\nasync function removeComparativa(id) {\n    try {\n        await fetchWithRetry(`backend/api/comparisons.php?id=${id}`, { method: 'DELETE' });\n    } catch (e) {\n        console.error('Error eliminando comparativa', e);\n    }\n    navigator.serviceWorker?.controller?.postMessage({\n        type: 'invalidate',\n        url: 'backend/api/comparisons.php'\n    });\n    return getComparativas();\n}\n\n/** Muestra un toast sencillo */\nfunction showToast(message, type = 'success') {\n    let container = document.getElementById('toast-container');\n    if (!container) {\n        container = document.createElement('div');\n        container.id = 'toast-container';\n        container.className = 'toast-container';\n        document.body.appendChild(container);\n    }\n\n    const toast = document.createElement('div');\n    toast.className = `toast toast-${type}`;\n    toast.style.opacity = '0';\n    toast.textContent = message;\n    container.appendChild(toast);\n    setTimeout(() => { toast.style.opacity = '1'; }, 10);\n    setTimeout(() => {\n        toast.style.opacity = '0';\n        setTimeout(() => {\n            toast.remove();\n            if (container.children.length === 0) container.remove();\n        }, 300);\n    }, 3000);\n}\n\nwindow.StorageUtils = {\n    saveFavorito,\n    getFavoritos,\n    removeFavorito,\n    saveComparativa,\n    getComparativas,\n    removeComparativa,\n    showToast\n};\n"],"names":["async","getFavoritos","r","fetchWithRetry","ok","data","json","Array","isArray","map","id","parseInt","e","console","error","getComparativas","parseNames","names","JSON","parse","parseIds","ids","left","right","n","Number","filter","isNaN","c","item_ids","item_left","item_right","nombres","item_names","window","StorageUtils","saveFavorito","item","method","headers","body","stringify","item_id","navigator","serviceWorker","controller","postMessage","type","url","removeFavorito","itemId","saveComparativa","comparativa","length","removeComparativa","showToast","message","container","document","getElementById","createElement","className","appendChild","toast","style","opacity","textContent","setTimeout","remove","children"],"mappings":"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"}