import{findIngredientByUid as t,setGlobalQty as e,recalcAll as n,snapshotExpandState as o,restoreExpandState as a,getTotals as l}from"./items-core.DNaUW135.min.js";import{setQtyInputValue as d,showSkeleton as i,hideSkeleton as r,showError as s,hideError as c,getQtyInputValue as m}from"./ui-helpers.min.js";import"./utils-oHRiiC_T.js";import"./services-BpgNmOWZ.js";function u(t,e=0,n=null,o=0,a=!0,l=[]){return t&&Array.isArray(t)?t.map((t,d)=>{if(!t||void 0===t.id)return console.warn("Ingrediente inválido en renderRows:",t),"";const i=0===e?d:o,r=i%2==0?"row-bg-a":"row-bg-b",s=e>0?`style="padding-left:${30*e}px"`:"",c="function"==typeof getRarityClass?getRarityClass(t.rarity):"",m=[...l,t._uid].join("-"),p=t.children&&t.children.length?`<button class="btn-expand" data-path="${m}">${t.expanded?"▴":"▾"}</button>`:"",w=e>0,f=w&&!a?'style="display:none"':"",b=`mode-${m}`,h=w?`\n      <input type="radio" name="${b}" class="chk-mode-buy" data-path="${m}" ${"buy"===t.modeForParentCrafted?"checked":""} title="Usar precio de compra para el padre">\n    `:"",y=w?`\n      <input type="radio" name="${b}" class="chk-mode-sell" data-path="${m}" ${"sell"===t.modeForParentCrafted?"checked":""} title="Usar precio de venta para el padre">\n    `:"",g=w&&t.is_craftable&&t.children&&t.children.length>0?`\n      <input type="radio" name="${b}" class="chk-mode-crafted" data-path="${m}" ${"crafted"===t.modeForParentCrafted?"checked":""} title="Usar precio de crafteo para el padre">\n    `:"",_=(()=>{if(!(t.children&&t.children.length>0&&Number(t.sell_price)>0))return"";const e=Number(t.sell_price)*t.countTotal,n=e-.15*e-Math.min(t.total_buy,t.total_sell,t.total_crafted);return`<span style='font-weight:bold;color:${n>0?"#4fc178":"#e84d4d"}'>${formatGoldColored(n)}</span>`})();return!t.buy_price&&t.sell_price,t.is_craftable&&t.children&&t.children.length,`\n      <tr data-path="${m}" class="${w?`subrow subrow-${e} child-of-${n}`:""} ${r}" ${f}>\n        <td class="th-border-left-items" ${s}><img src="${t.icon}" width="32"></td>\n        <td><a href="/item?id=${t.id}" class="item-link ${c}" target="_blank">${t.name}</a></td>\n        <td>${null!=t.countTotal?Number.isInteger(t.countTotal)?t.countTotal:t.countTotal.toFixed(2):t.count}</td>\n        <td class="item-unit-sell">${formatGoldColored(t.sell_price)} <span style="color: #c99b5b">c/u</span></td>\n        \n        <td class="item-solo-buy">\n          <div>${formatGoldColored(t.total_buy)}</div>\n          <div class="item-solo-precio">${formatGoldColored(t.buy_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${h}\n        </td>\n        \n        <td class="item-solo-sell">\n          <div>${formatGoldColored(t.total_sell)}</div>\n          <div class="item-solo-precio">${formatGoldColored(t.sell_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${y}\n        </td>\n        \n        <td class="item-solo-crafted">\n          ${t.is_craftable&&t.children&&t.children.length>0&&null!==t.total_crafted?`\n            <div>${formatGoldColored(t.total_crafted)}</div>\n            <div class="item-solo-precio">${formatGoldColored(0)} <span style="color: #c99b5b">c/u</span></div>\n            ${g}`:""}\n        </td>\n        \n        <td class="item-profit">${_}</td>\n        \n        <td class="th-border-right-items">${p}</td>\n      </tr>\n      ${t.children&&t.children.length&&a&&t.expanded?u(t.children,e+1,t._uid,i,t.expanded,[...l,t._uid]):""}\n    `}).join(""):""}function p(t,e=window._mainBuyPrice,n=window._mainSellPrice){null==e&&(e=window._mainBuyPrice),null==n&&(n=window._mainSellPrice),void 0===window._mainItemExpanded&&(window._mainItemExpanded=!1);!function(t){const e=document.querySelector(".qty-global-container");e&&(t?e.classList.add("visible"):e.classList.remove("visible"))}(window.ingredientObjs&&window.ingredientObjs.length>0);const o=window._mainRecipeOutputCount&&!isNaN(window._mainRecipeOutputCount)?window._mainRecipeOutputCount:1;void 0!==m()?m():window.globalQty;const a=null!=e?e*window.globalQty:0,d=window.ingredientObjs.reduce((t,e)=>t+(Number(e.sell_price)||0),0)*window.globalQty,i=Math.min(t.totalBuy,t.totalSell,t.totalCrafted),r=[a,d,i],s=Math.min(...r.filter(t=>t>0));let c="";c=s===a?"Mejor comprar (Buy)":s===d?"Mejor vender (Sell)":"Mejor craftear (Crafted)";let p="";t.totalBuy,t.totalSell,t.totalCrafted;t.totalBuy,t.totalSell,t.totalCrafted,1===o&&(p="");let w=`<div class="table-modern-totales">\n    <h3>Precio total materiales - Crafting</h3>\n    <div id="totales-crafting">      \n      <table class="table-totales" style="margin-top:12px;">\n        <tr>\n          <th><div class="tooltip-modern">Total Compra\n            <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-buy">${formatGoldColored(t.totalBuy)}</td>\n          <th><div class="tooltip-modern">Total Venta\n            <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-sell">${formatGoldColored(t.totalSell)}</td>\n          <th><div class="tooltip-modern">Total Crafted\n            <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n          </div></th>\n          <td class="item-solo-crafted">${formatGoldColored(t.totalCrafted)}</td>\n        </tr>\n      </table>\n    </div>\n    </div>`,f="";if(o>1&&(f=`<div class="table-modern-totales">\n    <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${o}</b> unidades por crafteo. Los siguientes costos son por unidad.</div>\n      <div id="totales-crafting">\n        <table class="table-totales" style="margin-top:12px;">\n          <tr>\n            <th><div class="tooltip-modern">Total Compra\n              <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-buy">${formatGoldColored(t.totalBuy/o)}</td>\n            <th><div class="tooltip-modern">Total Venta\n              <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-sell">${formatGoldColored(t.totalSell/o)}</td>\n            <th><div class="tooltip-modern">Total Crafted\n              <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n            </div></th>\n              <td class="item-solo-crafted">${formatGoldColored(t.totalCrafted/o)}</td>\n          </tr>\n        </table>\n      </div>\n    </div>`),1===o&&(formatGoldColored(a),formatGoldColored(d),formatGoldColored(i)),o>1){const t=null!=e?e:0,a=null!=n?n:0,l=o>0?i/o:i,d=[t,a,l],r=Math.min(...d.filter(t=>t>0));d.indexOf(r);formatGoldColored(t),formatGoldColored(a),formatGoldColored(l)}return`\n    <h3>Comparativa de items</h3>\n\n    <table class="table-modern tabla-tarjetas">\n      <thead class="header-items table-comparison-row">\n        <tr>\n          <th class="th-border-left">Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio de venta</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n          <th>Total Crafted</th>\n          <th>Mejor Profit</th>\n          <th class="th-border-right"></th>\n        </tr>\n      </thead>\n      <tbody>\n        ${window.ingredientObjs.map(t=>`\n          ${function(t,e){const n={totalBuy:t.total_buy,totalSell:t.total_sell,totalCrafted:void 0!==t.total_crafted&&null!==t.total_crafted?t.total_crafted:l().totalCrafted};if(!t)return"";const o=!!window._mainItemExpandedMap[t.id],a=`<button class="btn-expand btn-expand-main" id="btn-expand-main-${t.id}" data-id="${t.id}">${o?"▴":"▾"}</button> <button class="btn-delete-main" data-id="${t.id}" title="Eliminar">-</button>`,d="function"==typeof getRarityClass?getRarityClass(t.rarity):"";return`\n    <tr class="row-bg-main">\n      <td class="th-border-left-items"><img src="${t.icon}" width="32"></td>\n      <td><a href="/item?id=${t.id}" class="item-link ${d}" target="_blank">${t.recipe&&t.recipe.output_item_count&&t.recipe.output_item_count>1?`<span style='color:#a1a1aa;font-size:0.95em;display:block;margin-bottom:2px;'>Receta produce <b>${t.recipe.output_item_count}</b> unidades<br>Profit mostrado es por unidad</span>`:""}${t.name}</a></td>\n      <td>${e}</td>\n      <td class="item-unit-sell">${formatGoldColored(Number(t.sell_price))} <span style="color: #c99b5b">c/u</span></td>\n      <td class="item-solo-buy"><div>${formatGoldColored(n.totalBuy)}</div></td>\n      <td class="item-solo-sell"><div>${formatGoldColored(n.totalSell)}</div></td>\n      <td class="item-solo-crafted"><div>${formatGoldColored(n.totalCrafted)}</div></td>\n      <td class="item-profit">${(()=>{const o=Number(t.sell_price)*e,a=o-.15*o-Math.min(n.totalBuy,n.totalSell,n.totalCrafted);return`<span style='font-weight:bold;color:${a>0?"#4fc178":"#e84d4d"}'>${formatGoldColored(a)}</span>`})()}</td>\n      <td class="th-border-right-items"><div style="display:flex;gap:6px;align-items:center;">${a}</div></td>\n    </tr>\n  `}(t,window.globalQty,t.total_buy,t.total_sell,t.total_crafted)}\n          ${window._mainItemExpandedMap[t.id]?u(t.children,1,t._uid,0,!0,[t._uid]):""}\n`).join("")}\n      </tbody>\n    </table>\n    \x3c!-- ${o>1?f:w} --\x3e\n    \x3c!-- Comparativa de precios oculta --\x3e\n    ${p}\n  `}async function w(t,e){const n=o(window.ingredientObjs),l=document.getElementById("item-header");l&&(l.style.display="none");const d=e||{};formatGoldColored(null!=d.buy_price?d.buy_price:0),formatGoldColored(null!=d.sell_price?d.sell_price:0),null!=d.buy_quantity&&d.buy_quantity,null!=d.sell_quantity&&d.sell_quantity,a(window.ingredientObjs,n),await b(e?.buy_price,e?.sell_price)}async function f(t,e){window._lastItemData=t,window._lastMarketData=e;const n=document.getElementById("item-skeleton");r(n),c(),await w(0,e)}async function b(t=window._mainBuyPrice,e=window._mainSellPrice){null==t&&(t=window._mainBuyPrice),null==e&&(e=window._mainSellPrice),await n(window.ingredientObjs,window.globalQty);const o=l(),a=document.getElementById("seccion-crafting");if(a){const n=p(o,t,e);i=[()=>{a.innerHTML=n},()=>d()],requestIdleCallback(function t(e){for(;e.timeRemaining()>0&&i.length;){const t=i.shift();"function"==typeof t&&t()}i.length&&requestIdleCallback(t)})}else d();var i}window.checkTreeForInvalidIds=function t(e,n=""){if(Array.isArray(e))for(const o of e)o&&void 0!==o.id&&null!==o.id||console.warn("Ingrediente sin id válido en ruta:",n,o),Array.isArray(o.children)&&t(o.children,n+" > "+(o.name||o.id))},void 0===window._mainItemExpandedMap&&(window._mainItemExpandedMap={}),window._mainExpandBtnHandlerInstalled||(window._mainExpandBtnHandlerInstalled=!0,document.addEventListener("click",function(t){if(t.target&&t.target.classList.contains("btn-expand-main")){const e=t.target.getAttribute("data-id");if(!e)return;window._mainItemExpandedMap[e]=!window._mainItemExpandedMap[e],b(),t.stopPropagation()}}),document.addEventListener("click",function(t){if(t.target&&(t.target.classList.contains("btn-delete-main")||"function"==typeof t.target.closest&&t.target.closest(".btn-delete-main"))){let e=t.target;if(e.classList.contains("btn-delete-main")||"function"!=typeof e.closest||(e=e.closest(".btn-delete-main")),!e)return;const n=e.getAttribute("data-id");if(!n)return;window.ingredientObjs&&Array.isArray(window.ingredientObjs)&&(window.ingredientObjs=window.ingredientObjs.filter(t=>String(t.id)!==String(n)),window._mainItemExpandedMap&&delete window._mainItemExpandedMap[n]),b(),t.stopPropagation()}})),window._modeChangeHandlerInstalled||(window._modeChangeHandlerInstalled=!0,document.addEventListener("click",function(e){const n=e.target;if(n.matches(".chk-mode-buy, .chk-mode-sell, .chk-mode-crafted")){const e=n.getAttribute("data-path");if(!e)return;const o=e.split("-").pop(),a=t(window.ingredientObjs||[],o);if(a){let t="buy";n.classList.contains("chk-mode-sell")&&(t="sell"),n.classList.contains("chk-mode-crafted")&&(t="crafted"),"function"==typeof a.setMode?a.setMode(t):(a.modeForParentCrafted=t,a.findRoot()?.recalc(window.globalQty||1,null),b())}}})),window._expandBtnHandlerInstalled||(window._expandBtnHandlerInstalled=!0),window.ingredientObjs&&function t(e,n=""){e.forEach(e=>{e._parentId=null!==n?String(n):"",Array.isArray(e.children)&&t(e.children,e._uid)})}(window.ingredientObjs),document.addEventListener("click",function(e){if(e.target&&e.target.classList.contains("btn-expand")){const n=e.target.getAttribute("data-path");if(!n)return;const o=n.split("-").pop(),a=t(window.ingredientObjs||[],o);a&&(a.expanded=!a.expanded,b())}}),window._qtyGlobalHandlerInstalled||(window._qtyGlobalHandlerInstalled=!0,document.addEventListener("input",function(t){t.target&&"qty-global"===t.target.id&&(window._qtyInputValue=t.target.value)}),document.addEventListener("blur",function(t){if(t.target&&"qty-global"===t.target.id){const n=t.target;let o=parseInt(n.value,10);isNaN(o)||o<1?(e(1),window._qtyInputValue="1"):(e(o),window._qtyInputValue=n.value),void 0!==window._qtyInputValue&&String(window._qtyInputValue)===String(window.globalQty)&&delete window._qtyInputValue,b()}},!0),document.addEventListener("keydown",function(t){if(t.target&&"qty-global"===t.target.id&&"Enter"===t.key){t.preventDefault();const n=t.target;let o=parseInt(n.value,10);isNaN(o)||o<1?(e(1),window._qtyInputValue="1"):(e(o),window._qtyInputValue=n.value),void 0!==window._qtyInputValue&&String(window._qtyInputValue)===String(window.globalQty)&&delete window._qtyInputValue,b()}})),"undefined"!=typeof window&&(window.showSkeleton=i,window.hideSkeleton=r,window.showError=s,window.hideError=c,window.safeRenderTable=b,window.renderItemUI=w,window.installUIEvents=function(){});export{f as initItemUI,w as renderItemUI,b as safeRenderTable};
//# sourceMappingURL=compare-ui.min.v1.0.0.js.map
