{"version":3,"file":"ingredientTreeWorker.lDCMzisp.js","sources":["../../src/js/workers/ingredientTreeWorker.js"],"sourcesContent":["import { fetchWithCache } from '../utils/requestCache.min.js';\n\nself.onmessage = async (e) => {\n  const { mainItemId } = e.data;\n  try {\n    const tree = await prepareIngredientTreeData(mainItemId);\n    self.postMessage({ tree });\n  } catch (err) {\n    self.postMessage({ error: err.message });\n  }\n};\n\nasync function prepareIngredientTreeData(mainItemId) {\n  const rootNested = await fetchWithCache(`/recipe-tree/${mainItemId}`).then((r) => r.json());\n  if (!rootNested || !rootNested.components || rootNested.components.length === 0) {\n    return [];\n  }\n\n  const allItemIds = new Set();\n  (function gather(node) {\n    if (!node) return;\n    allItemIds.add(node.id);\n    if (node.components) {\n      node.components.forEach((comp) => {\n        if (comp.type === 'Recipe') gather(comp);\n        else if (comp.type === 'Item') allItemIds.add(comp.id);\n      });\n    }\n  })(rootNested);\n\n  const allItemsDetailsMap = new Map();\n  const allIdsArray = Array.from(allItemIds);\n  for (let i = 0; i < allIdsArray.length; i += 200) {\n    const chunk = allIdsArray.slice(i, i + 200);\n    const itemsChunk = await fetchWithCache(\n      `https://api.guildwars2.com/v2/items?ids=${chunk.join(',')}&lang=es`,\n    ).then((r) => r.json());\n    itemsChunk.forEach((item) => allItemsDetailsMap.set(item.id, item));\n  }\n\n  const marketDataMap = new Map();\n  try {\n    const csvUrl = `https://api.datawars2.ie/gw2/v1/items/csv?fields=id,buy_price,sell_price&ids=${Array.from(\n      allItemIds,\n    ).join(',')}`;\n    const csvText = await fetchWithCache(csvUrl).then((r) => r.text());\n    const [headers, ...rows] = csvText.trim().split('\\n').map((line) => line.split(','));\n    if (headers && headers.length > 0) {\n      for (const row of rows) {\n        const obj = {};\n        headers.forEach((h, idx) => {\n          const value = row[idx];\n          if (h === 'id') obj[h] = parseInt(value, 10);\n          else if (h === 'buy_price' || h === 'sell_price')\n            obj[h] = value !== '' && value !== undefined ? parseInt(value, 10) : null;\n          else obj[h] = value;\n        });\n        if (obj.id) marketDataMap.set(obj.id, obj);\n      }\n    }\n  } catch (e) {\n    // ignore CSV fetch errors\n  }\n\n  const missingMarketIds = Array.from(allItemIds).filter((id) => !marketDataMap.has(id));\n  for (let i = 0; i < missingMarketIds.length; i += 200) {\n    const chunk = missingMarketIds.slice(i, i + 200);\n    try {\n      const chunkData = await fetchWithCache(\n        `https://api.guildwars2.com/v2/commerce/prices?ids=${chunk.join(',')}`,\n      ).then((r) => r.json());\n      chunkData.forEach((p) => {\n        marketDataMap.set(p.id, {\n          id: p.id,\n          buy_price: p.buys?.unit_price ?? null,\n          sell_price: p.sells?.unit_price ?? null,\n        });\n      });\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  function convertComponent(node, parentId = null) {\n    const itemDetail = allItemsDetailsMap.get(node.id);\n    if (!itemDetail) return null;\n    const marketInfo = marketDataMap.get(node.id) || {};\n    const isCraftable = Array.isArray(node.components) && node.components.length > 0;\n    let children = [];\n\n    if (isCraftable) {\n      children = node.components\n        .map((comp) => {\n          if (comp.type === 'Recipe') {\n            return convertComponent(comp, itemDetail.id);\n          } else if (comp.type === 'Item') {\n            const detail = allItemsDetailsMap.get(comp.id);\n            if (!detail) return null;\n            const mInfo = marketDataMap.get(comp.id) || {};\n              return {\n                id: detail.id,\n                name: detail.name,\n                icon: detail.icon,\n                rarity: detail.rarity,\n                count: comp.quantity,\n                buy_price: mInfo.buy_price ?? null,\n                sell_price: mInfo.sell_price ?? null,\n                crafted_price: null,\n                is_craftable: false,\n                recipe: null,\n                children: [],\n                _parentId: itemDetail.id,\n              };\n          } else {\n            return null;\n          }\n        })\n        .filter(Boolean);\n    }\n\n    return {\n      id: itemDetail.id,\n      name: itemDetail.name,\n      icon: itemDetail.icon,\n      rarity: itemDetail.rarity,\n      count: node.quantity,\n      buy_price: marketInfo.buy_price ?? null,\n      sell_price: marketInfo.sell_price ?? null,\n      crafted_price: null,\n      is_craftable: isCraftable,\n      recipe: node.recipe || null,\n      children,\n      _parentId: parentId,\n    };\n  }\n\n  const root = convertComponent(rootNested, null);\n  return root ? root.children || [] : [];\n}\n\n"],"names":["self","onmessage","async","e","mainItemId","data","tree","rootNested","fetchWithCache","then","r","json","components","length","allItemIds","Set","gather","node","add","id","forEach","comp","type","allItemsDetailsMap","Map","allIdsArray","Array","from","i","chunk","slice","join","item","set","marketDataMap","csvUrl","csvText","text","headers","rows","trim","split","map","line","row","obj","h","idx","value","parseInt","undefined","missingMarketIds","filter","has","p","buy_price","buys","unit_price","sell_price","sells","convertComponent","parentId","itemDetail","get","marketInfo","isCraftable","isArray","children","detail","mInfo","name","icon","rarity","count","quantity","crafted_price","is_craftable","recipe","_parentId","Boolean","root","prepareIngredientTreeData","postMessage","err","error","message"],"mappings":"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"}