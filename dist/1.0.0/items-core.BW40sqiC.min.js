import{g as e,a as t,e as n,s as i,p as r}from"./utils-BAeLe99y.js";function o(e){Array.isArray(e)&&l(e,null),window.ingredientObjs=e}"undefined"!=typeof window&&(window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1,window._mainBuyPrice=window._mainBuyPrice||0,window._mainSellPrice=window._mainSellPrice||0,window._mainRecipeOutputCount=window._mainRecipeOutputCount||1);class a{constructor({id:e,name:t,icon:n,rarity:i,count:r,buy_price:o,sell_price:l,is_craftable:s,recipe:d,children:c=[],_parentId:u=null}){this._uid=a.nextUid++,this.id=e,this.name=t,this.icon=n,this.rarity=i,this.count=r,this.buy_price=o,this.sell_price=l,this.is_craftable=s,this.recipe=d||null,this.children=c,this.mode="buy",this.modeForParentCrafted="buy",this.expanded=!1,this._parentId=u,this._parent=null,this.countTotal=0,this.crafted_price=null,this.total_buy=0,this.total_sell=0,this.total_crafted=0}findRoot(){let e=this;for(;e._parent;)e=e._parent;return e}setMode(e){if(["buy","sell","crafted"].includes(e)){this.modeForParentCrafted=e;this.findRoot().recalc(window.globalQty||1,null),"function"==typeof window.safeRenderTable&&window.safeRenderTable()}}recalc(e=1,t=null){const n=null==t,i=19675===this.id&&(77===this.count||38===this.count);if(this.countTotal=n?this.count*e:i?this.count:t.countTotal*this.count,this.children&&this.children.length>0)if(i){const e=77===this.count?[250,250,250,1500]:[38,38,38,38];this.children.forEach((t,n)=>{t.countTotal=e[n]||0,t.total_buy=(t.buy_price||0)*t.countTotal,t.total_sell=(t.sell_price||0)*t.countTotal})}else this.children.forEach(t=>t.recalc(e,this));n||i?(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0)):(this.total_buy=(this.buy_price||0)*this.countTotal,this.total_sell=(this.sell_price||0)*this.countTotal),this.is_craftable&&this.children.length>0?(this.total_crafted=this.children.reduce((e,t)=>{switch(t.modeForParentCrafted){case"buy":default:return e+(t.total_buy||0);case"sell":return e+(t.total_sell||0);case"crafted":return e+(t.total_crafted||0)}},0),this.crafted_price=this.total_crafted/(this.recipe?.output_item_count||1),n||this.buy_price||this.sell_price||(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0))):(this.total_crafted=null,this.crafted_price=null)}getBestPrice(){return"number"==typeof this.buy_price&&this.buy_price>0?this.buy_price:"number"==typeof this.crafted_price&&this.crafted_price>0?this.crafted_price:0}}function l(e,t=null){if(Array.isArray(e))for(const n of e)Object.setPrototypeOf(n,a.prototype),"number"==typeof n._uid&&a.nextUid<=n._uid&&(a.nextUid=n._uid+1),n._parent=t,t&&(n._parentId=t._uid),Array.isArray(n.children)&&n.children.length>0?l(n.children,n):n.children=[]}function s(e){window.globalQty=e}function d(e){return e?e.map(e=>({id:e.id,expanded:e.expanded,children:d(e.children||[])})):[]}function c(e,t){if(e&&t)for(let n=0;n<e.length;n++)t[n]&&(e[n].expanded=t[n].expanded,c(e[n].children,t[n].children))}a.nextUid=0;let u=null,w={totalBuy:0,totalSell:0,totalCrafted:0};function f(e,t){return e?(u||(u=new Worker(new URL("./workers/costsWorker.js",import.meta.url),{type:"module"})),new Promise((n,i)=>{const r=t=>{u.removeEventListener("message",r),u.removeEventListener("error",o);const{updatedTree:i,totals:a}=t.data||{};function s(e,t){if(Object.assign(t,e),e.children&&t.children)for(let n=0;n<e.children.length;n++)s(e.children[n],t.children[n])}if(Array.isArray(i)&&l(i,null),Array.isArray(i))for(let t=0;t<i.length;t++)s(i[t],e[t]);w=a||{totalBuy:0,totalSell:0,totalCrafted:0},n()},o=e=>{u.removeEventListener("message",r),u.removeEventListener("error",o),i(e)};u.addEventListener("message",r),u.addEventListener("error",o),u.postMessage({ingredientTree:e,globalQty:t})})):Promise.resolve()}function h(){return w}function p(e,t,n){for(const i of e){if(String(i.id)===String(t)&&String(i._parentId)===String(n))return i;if(Array.isArray(i.children)&&i.children.length){const e=p(i.children,t,n);if(e)return e}}return null}function g(e,t){let n=e,i=null;for(let e=0;e<t.length;e++){const r=t[e];if(i=(n||[]).find(e=>String(e._uid)===String(r)||String(e.id)===String(r)),!i)return null;n=i.children}return i}function y(e,t){for(const n of e){if(String(n._uid)===String(t))return n;if(n.children&&n.children.length){const e=y(n.children,t);if(e)return e}}return null}function m(e,t){for(const n of e){if(String(n.id)===String(t))return n;if(n.children&&n.children.length){const e=m(n.children,t);if(e)return e}}return null}function _(e,t,n=[]){if(!Array.isArray(e))return n;for(const i of e)String(i.id)===String(t)&&n.push(i),i.children&&i.children.length&&_(i.children,t,n);return n}const b=new Set;function S(e){return b.add(e),e}function v(){b.forEach(e=>e.abort()),b.clear(),O&&(O.terminate(),O=null)}async function E(e){const r=S(new AbortController),o=`item_${e}`,a=t(o,!0),l={};a?.etag&&(l["If-None-Match"]=a.etag),a?.lastModified&&(l["If-Modified-Since"]=a.lastModified);try{try{const t=await n(`/backend/api/itemBundle.php?ids=${e}`,{headers:l,signal:r.signal});if(t.ok){const e=await t.json(),n=Array.isArray(e)?e[0]:null;if(n&&n.item){const e=n.item;n.nested_recipe&&(e.nested_recipe=n.nested_recipe);const r=t.headers.get("ETag"),a=t.headers.get("Last-Modified"),l=r||a?null:void 0;return e.lastUpdated=(new Date).toISOString(),i(o,e,l,{etag:r,lastModified:a}),e}}}catch(e){}const t=await n(`https://api.guildwars2.com/v2/items/${e}?lang=es`,{headers:l,signal:r.signal});if(304===t.status&&a)return a.value;if(!t.ok)throw new Error(`Error ${t.status} obteniendo datos del ítem ${e}`);const s=await t.json();s.lastUpdated=(new Date).toISOString();const d=t.headers.get("ETag"),c=t.headers.get("Last-Modified");return i(o,s,d||c?null:void 0,{etag:d,lastModified:c}),s}finally{b.delete(r)}}let O=null;async function T(e,t){if(!t||!t.ingredients||0===t.ingredients.length)return window.ingredientObjs=[],window._mainRecipeOutputCount=t&&t.output_item_count||1,[];if(t.nested_recipe){window._mainRecipeOutputCount=t.output_item_count||1;const e=(t.nested_recipe||[]).map(e=>j(e,null));return l(e,null),e.forEach(e=>e.recalc(window.globalQty,null)),e}return O&&O.terminate(),O=new Worker(new URL("./workers/ingredientTreeWorker.js",import.meta.url),{type:"module"}),new Promise((n,i)=>{const r=e=>{O.removeEventListener("message",r),O.removeEventListener("error",o);const{tree:t,error:a}=e.data||{};if(O=null,a){const e=new Error(a);console.error("Error en ingredientTreeWorker:",e.message,e);const t=`Error procesando ingredientes: ${e.message}`;return window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(t,"error"):"function"==typeof alert&&alert(t),void i(e)}let s=t||[];Array.isArray(s)||(s=s&&"object"==typeof s?Array.isArray(s.children)?s.children:[s]:[]);const d=s.map(e=>j(e,null));l(d,null),d.forEach(e=>e.recalc(window.globalQty,null)),n(d)},o=e=>{O.removeEventListener("message",r),O.removeEventListener("error",o),O=null,console.error("Error en ingredientTreeWorker:",e?.message||e,e);const t="Error procesando ingredientes"+(e?.message?`: ${e.message}`:"");window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(t,"error"):"function"==typeof alert&&alert(t),i(e)};O.addEventListener("message",r),O.addEventListener("error",o),O.postMessage({mainItemId:e,mainRecipeData:t})})}async function I(e){const r=S(new AbortController),o=`recipe_${e}`,a=t(o);if(a)return b.delete(r),a;try{const t=await n(`https://api.guildwars2.com/v2/recipes/search?output=${e}`,{signal:r.signal});if(!t.ok)return null;const a=await t.json();if(!a||0===a.length)return null;const l=a[0],s=await n(`https://api.guildwars2.com/v2/recipes/${l}?lang=es`,{signal:r.signal});if(!s.ok)throw new Error(`Error ${s.status} obteniendo datos de la receta ${l}`);const d=await s.json();return d.lastUpdated=(new Date).toISOString(),i(o,d),d}finally{b.delete(r)}}function j(e,t=null){const n=new a({id:e.id,name:e.name,icon:e.icon,rarity:e.rarity,count:e.count||1,recipe:e.recipe||null,buy_price:e.buy_price||0,sell_price:e.sell_price||0,is_craftable:e.is_craftable||!1,children:[],_parentId:t});return e.children&&e.children.length>0&&(n.children=e.children.map(e=>j(structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e)),n._uid))),n}if("undefined"!=typeof window){void 0===window.comparativa&&(window.comparativa={});let A=null;async function P(e){const t=await r(e);e.forEach(e=>{const n=t.get(e)||{},i=m(window.ingredientObjs,e);i&&(i.buy_price=n.buy_price||0,i.sell_price=n.sell_price||0,"function"==typeof i.recalc&&i.recalc(window.globalQty||1,null))}),"function"==typeof window.safeRenderTable&&window.safeRenderTable()}function R(){const e=window.ingredientObjs?window.ingredientObjs.map(e=>e.id):[];if(A&&(clearInterval(A),A=null),0===e.length)return;const t=()=>P(e);t(),A=setInterval(t,6e4)}window.comparativa.agregarItemPorId=async function(t){if(window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1,window.ingredientObjs.some(e=>e.id==t))return;const n=document.getElementById("item-skeleton");try{"function"==typeof window.showSkeleton&&window.showSkeleton(n);const i=await E(t),r=await I(t);let o,l;if(r){let n=await T(t,r);Array.isArray(n)||(n=[]),o=await e(t),window._mainBuyPrice=o.buy_price||0,window._mainSellPrice=o.sell_price||0,window._mainRecipeOutputCount=r&&r.output_item_count||1,l=new a({id:i.id,name:i.name,icon:i.icon,rarity:i.rarity,count:1,buy_price:o.buy_price,sell_price:o.sell_price,is_craftable:!0,recipe:r,children:n}),l.recalc(window.globalQty||1,null)}else o=await e(t),window._mainBuyPrice=o.buy_price||0,window._mainSellPrice=o.sell_price||0,window._mainRecipeOutputCount=1,l=new a({id:i.id,name:i.name,icon:i.icon,rarity:i.rarity,count:1,buy_price:o.buy_price,sell_price:o.sell_price,is_craftable:!1,recipe:null,children:[]});window.ingredientObjs.push(l),R(),"function"==typeof window.safeRenderTable&&("number"==typeof o.buy_price&&"number"==typeof o.sell_price?window.safeRenderTable(o.buy_price,o.sell_price):window.safeRenderTable()),"function"==typeof window.hideSkeleton&&window.hideSkeleton(n)}catch(e){"function"==typeof window.hideSkeleton&&window.hideSkeleton(n);const t="Error al agregar el ítem: "+(e?.message||e);window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(t,"error"):"function"==typeof alert&&alert(t),console.error("Error al agregar el ítem",e)}},window.comparativa.handleSaveComparativa=async function(){if(!window.ingredientObjs||0===window.ingredientObjs.length)return void window.StorageUtils?.showToast("Agrega al menos un ítem a la comparativa","error");const e={ids:window.ingredientObjs.map(e=>e.id),nombres:window.ingredientObjs.map(e=>e.name),timestamp:Date.now()};window.StorageUtils&&"function"==typeof window.StorageUtils.saveComparativa?(await window.StorageUtils.saveComparativa(e),window.StorageUtils.showToast("Comparativa guardada")):alert("StorageUtils no está disponible.")},window.comparativa.loadComparativaFromURL=function(){const e=new URLSearchParams(window.location.search).get("ids");if(!e)return;const t=e.split(",").map(e=>parseInt(e,10)).filter(e=>!isNaN(e));if(0===t.length)return;window.ingredientObjs=window.ingredientObjs||[],window.globalQty=window.globalQty||1;const n=()=>{window.comparativa&&"function"==typeof window.comparativa.agregarItemPorId?(async()=>{for(let e=0;e<t.length;e+=10){const n=t.slice(e,e+10);(await Promise.allSettled(n.map(e=>window.comparativa.agregarItemPorId(e)))).forEach((e,t)=>{"rejected"===e.status&&console.error("Error cargando ítem de la URL",n[t],e.reason)})}})():setTimeout(n,50)};n()}}function U(e,t){return!e||!t||isNaN(e)||isNaN(t)||0===t?"-":(e/t*100).toFixed(1)+"%"}"undefined"!=typeof window&&(window.setIngredientObjs=o,window.setGlobalQty=s,window.snapshotExpandState=d,window.restoreExpandState=c,window.recalcAll=f,window.getTotals=h,window.findIngredientByIdAndParent=p,window.findIngredientByPath=g,window.findIngredientByUid=y,window.findIngredientById=m,window.findIngredientsById=_,window.calcPercent=U);export{a as CraftIngredient,U as calcPercent,v as cancelItemRequests,j as createCraftIngredientFromRecipe,E as fetchItemData,I as fetchRecipeData,m as findIngredientById,p as findIngredientByIdAndParent,g as findIngredientByPath,y as findIngredientByUid,_ as findIngredientsById,h as getTotals,T as prepareIngredientTreeData,f as recalcAll,l as restoreCraftIngredientPrototypes,c as restoreExpandState,s as setGlobalQty,o as setIngredientObjs,d as snapshotExpandState};
//# sourceMappingURL=items-core.BW40sqiC.min.v1.0.0.js.map
