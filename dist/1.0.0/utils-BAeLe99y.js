const e=[];function t(){const t=Date.now()-6e4;for(;e.length&&e[0]<t;)e.shift()}function n(){t();const n=e.length;return n>5?"down":n>0?"slow":"ok"}let o;function r(){if("undefined"==typeof document)return;const e=n();o||(o=document.createElement("div"),o.id="api-status-indicator",o.style.position="fixed",o.style.bottom="10px",o.style.right="10px",o.style.padding="4px 8px",o.style.background="rgba(0,0,0,0.7)",o.style.color="#fff",o.style.borderRadius="4px",o.style.zIndex="10000",o.style.display="none",document.body.appendChild(o)),"ok"===e?o.style.display="none":(o.textContent="slow"===e?"API lenta":"API ca√≠da",o.style.display="block")}var s={recordFailure:function(){e.push(Date.now()),t(),r()},recordSuccess:function(){t(),r()},getState:n,getBackoff:function(){const e=n();return"down"===e?5e3:"slow"===e?1e3:0}};async function i(e,t={}){const{timeout:n=8e3,retries:o=3,backoff:r=300,signal:i,...a}=t;for(let t=0;t<=o;t++){const c=new AbortController,l=setTimeout(()=>c.abort(),n);i&&(i.aborted?c.abort():i.addEventListener("abort",()=>c.abort(),{once:!0}));try{const t=await fetch(e,{...a,signal:c.signal});return clearTimeout(l),s.recordSuccess(),t}catch(e){if(clearTimeout(l),s.recordFailure(),i?.aborted||t===o)throw e;const n=r*Math.pow(2,t);await new Promise(e=>setTimeout(e,n))}}}const a={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},c="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let l=null;function u(e){c&&c.postMessage({type:"delete",key:e})}const f=new Map;!function(e){l=e,c&&c.addEventListener("message",({data:e})=>{const{type:t,key:n,entry:o}=e||{};if("request-bundles"!==t)t&&n&&("set"===t&&o?l.set(n,o):"delete"===t&&l.delete(n));else{if(!l)return;l.forEach((e,t)=>{t.startsWith("bundle_")&&c.postMessage({type:"set",key:t,entry:e})})}})}(f),c&&c.postMessage({type:"request-bundles"});const d="undefined"!=typeof localStorage,g=new Map;function p(e){try{return JSON.parse(e)}catch{return null}}function h(e,t){if(d)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:n,lastModified:o}){return JSON.stringify({value:e,expiresAt:t,etag:n,lastModified:o})}(t))}catch{}}function y(e,t,n=void 0,o={}){if(void 0===n){const t=e.split("_")[0];n=a[t]}const r=null==n?null:Date.now()+n,{etag:s=null,lastModified:i=null}=o,l={value:t,expiresAt:r,updatedAt:(new Date).toISOString(),etag:s,lastModified:i};f.set(e,l),h(e,{value:t,expiresAt:r,etag:s,lastModified:i}),function(e,t){c&&c.postMessage({type:"set",key:e,entry:t})}(e,l)}function m(e,t=!1){let n=f.get(e);if(!n){const t=function(e){if(!d)return null;const t=localStorage.getItem(e);if(!t)return null;const n=p(t);return n||(localStorage.removeItem(e),null)}(e);if(t){const{value:o,expiresAt:r=null,etag:s=null,lastModified:i=null}=t;n={value:o,expiresAt:r,updatedAt:(new Date).toISOString(),etag:s,lastModified:i},f.set(e,n)}}return n?n.expiresAt&&Date.now()>n.expiresAt?(f.delete(e),d&&localStorage.removeItem(e),u(e),null):t?n:n.value:null}function w(e,t={}){const n=function(e,{method:t="GET",headers:n={}}={}){return`${e}|${t.toUpperCase()}|${JSON.stringify(n)}`}(e,t),o=g.get(n)||i(e,t).finally(()=>g.delete(n));return g.set(n,o),o.then(e=>e.clone())}!function(){if(!d)return;const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t),o=p(localStorage.getItem(n));if(!o)continue;const{expiresAt:r}=o;r&&Date.now()>r&&e.push(n)}e.forEach(e=>{localStorage.removeItem(e),u(e)})}();const S=new Map;function v(e,t={},n=null,o=null,r){const s=S.get(e);s&&s.controller?.abort(),n&&!o&&(o=m(n,!0));const a={...t.headers||{}};o?.etag&&(a["If-None-Match"]=o.etag),o?.lastModified&&(a["If-Modified-Since"]=o.lastModified);const c=r?null:new AbortController,l=r??t.signal??c?.signal;return function(e,t,n){return S.set(e,{promise:t,controller:n}),t.finally(()=>S.delete(e)),t}(e,i(e,{...t,headers:a,signal:l}).then(async e=>304===e.status&&o?new Response(JSON.stringify(o.value),{status:200,headers:{"X-Cache":"HIT",ETag:o.etag||"","Last-Modified":o.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),c).then(e=>e.clone())}const b="undefined"!=typeof process&&process.env?process.env:{},_=b.API_BASE_URL||"https://api.guildwars2.com/v2",M=b.LANG||"es";b.MARKET_CSV_URL,b.GW2_API_KEY;var E=_,I=M,A=b.PRICE_CACHE_STRATEGY||"sessionStorage";const x=new Map;function k(){return"sessionStorage"===A}function T(e){return`price_${e}`}function N(e){if(!k()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(T(e));if(!t)return null;try{const{value:n,expires:o}=JSON.parse(t);return o&&Date.now()>o?(sessionStorage.removeItem(T(e)),null):n}catch{return sessionStorage.removeItem(T(e)),null}}async function O(e=[]){const t=new Map,n=[];if(e.forEach(e=>{if(e=Number(e),x.has(e))return void t.set(e,x.get(e));const o=N(e);o?(x.set(e,o),t.set(e,o)):n.push(e)}),n.length)try{const e=await async function(e){if(!Array.isArray(e)||0===e.length)return new Map;if("redis"===A){const t=`/backend/api/itemBundle.php?ids=${e.join(",")}`,n=await fetch(t);if(!n.ok)throw new Error("Price fetch failed");const o=await n.json(),r=new Map;return o.forEach(e=>{const t=e.market||{};r.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),r}{const t=`https://api.datawars2.ie/gw2/v1/items/csv?fields=${["id","buy_price","sell_price"].join(",")}&ids=${e.join(",")}`,n=await fetch(t);if(!n.ok)throw new Error("Price fetch failed");const o=(await n.text()).trim().split("\n"),r=o[0].split(","),s=new Map;for(let e=1;e<o.length;e++){if(!o[e])continue;const t=o[e].split(","),n={};r.forEach((e,o)=>{const r=t[o];n[e]=void 0!==r?isNaN(r)?r:Number(r):null}),null!=n.id&&s.set(n.id,{buy_price:n.buy_price||0,sell_price:n.sell_price||0})}return s}}(n);e.forEach((e,n)=>{x.set(n,e),function(e,t){if(k()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(T(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(n,e),t.set(n,e)})}catch(e){console.error("Error preloading prices",e)}return e.forEach(e=>{e=Number(e),!t.has(e)&&x.has(e)&&t.set(e,x.get(e)),t.has(e)||t.set(e,{buy_price:0,sell_price:0})}),t}async function P(e){if(e=Number(e),x.has(e))return x.get(e);const t=N(e);if(t)return x.set(e,t),t;return(await O([e])).get(e)}function C(){if(x.clear(),k()&&"undefined"!=typeof sessionStorage)for(let e=sessionStorage.length-1;e>=0;e--){const t=sessionStorage.key(e);t&&t.startsWith("price_")&&sessionStorage.removeItem(t)}}var $=Object.freeze({__proto__:null,clearCache:C,getPrice:P,preloadPrices:O});function j(e=[],t,n=6e4){if(!Array.isArray(e)||0===e.length)return()=>{};let o=!1;return async function r(){if(o)return;const i=s.getBackoff();i&&await new Promise(e=>setTimeout(e,i));try{const n=await O(e);"function"==typeof t&&t(n)}catch(e){s.recordFailure()}o||setTimeout(r,n)}(),()=>{o=!0}}const D=`${E}/items?ids=`,B=`&lang=${I}`,L=new Set,R=new Map;let z=null,F=null;function J(e){if(1!==e.length)return{};const t=m(`item_${e[0]}`,!0);if(!t)return{};const n={};return t.etag&&(n["If-None-Match"]=t.etag),t.lastModified&&(n["If-Modified-Since"]=t.lastModified),n}function W(){z||(z=setTimeout(G,50)),L.size>=200&&(clearTimeout(z),G())}async function G(){if(0===L.size)return void(z=null);z=null;const e=Array.from(L).slice(0,200);e.forEach(e=>L.delete(e));try{const t=s.getBackoff();t&&await new Promise(e=>setTimeout(e,t)),F=new AbortController;const n=await i(D+e.join(",")+B,{headers:J(e),signal:F.signal,backoff:300+t});if(304===n.status)return void e.forEach(e=>{const t=R.get(e),n=m(`item_${e}`);t&&t.resolve(n),R.delete(e)});const o=n.headers.get("ETag"),r=n.headers.get("Last-Modified"),a=await n.json(),c=new Map(a.map(e=>[e.id,e]));e.forEach(e=>{const t=R.get(e),n=c.get(e);n?(y(`item_${e}`,n,void 0,{etag:o,lastModified:r}),t.resolve(n)):t.resolve(null),R.delete(e)})}catch(t){e.forEach(e=>{const n=R.get(e);n&&(t instanceof DOMException&&t.name,n.reject(t)),R.delete(e)})}L.size>0&&W()}function q(e=[],t){F&&(F.abort(),F=null);const n=e.map(e=>{const t=m(`item_${e}`);if(t)return Promise.resolve(t);if(R.has(e))return R.get(e).promise;const n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),R.set(e,n),L.add(e),W(),n.promise});return Promise.all(n)}!function(){if("undefined"!=typeof localStorage)for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t.startsWith("item_")&&m(t)}}();const U=new Map,H=new WeakMap,K=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target;if(H.set(t,e.isIntersecting),e.isIntersecting){const e=t.dataset.stateId||t.dataset.path;if(!e)return;const n=U.get(e);if(!n)return;const o=n.find(e=>e.el===t),r=t._pendingState;o&&r&&(o.renderFn(r),t._pendingState=null)}})});function Y(e,t,n){const o=String(e);t.dataset.stateId=o;let r=U.get(o);r||(r=[],U.set(o,r)),r.push({el:t,renderFn:n}),K.observe(t)}function V(e,t){const n=U.get(String(e));n&&n.forEach(({el:e,renderFn:n})=>{H.get(e)?n&&n(t):e._pendingState=t})}function X(){const e=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){const n=t.target;n.src=n.dataset.src,e.unobserve(n)}})});document.querySelectorAll("img[data-src]").forEach(t=>e.observe(t))}function Q(e,t){if(!e)return;const n=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(t(),n.unobserve(e.target))})});n.observe(e)}var Z=Object.freeze({__proto__:null,register:Y,update:V});export{m as a,w as b,C as c,j as d,v as e,i as f,P as g,Y as h,X as i,$ as j,Z as k,Q as o,O as p,q as r,y as s,V as u};
//# sourceMappingURL=utils-BAeLe99y.v1.0.0.js.map
