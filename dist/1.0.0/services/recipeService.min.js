import{getCached,setCached}from"../utils/cache.min.js";import{fetchWithCache}from"../utils/requestCache.min.js";import fetchWithRetry from"../utils/fetchWithRetry.min.js";import{getPrice,preloadPrices}from"../utils/priceHelper.min.js";import config from"../config.js";const API_BASE_URL=config.API_BASE_URL;export async function getItemBundles(e=[]){if(!Array.isArray(e)||0===e.length)return[];const t=new Map,r=[];if(e.forEach(e=>{const i=getCached(`bundle_${e}`);i?t.set(e,i):r.push(e)}),r.length>0){const e=r.map(e=>`ids[]=${e}`).join("&");fetchWithRetry(`/backend/api/dataBundle.php?${e}`).then(e=>e.ok?e.json():null).then(e=>{e&&e.forEach(e=>{setCached(`bundle_${e.id}`,e),window.dispatchEvent(new CustomEvent("bundleItemRefreshed",{detail:e}))})}).catch(e=>console.error("Error en getItemBundles:",e))}return e.map(e=>t.get(e)||null)}export async function getRecipesForItem(e){const t=Array.isArray(e)?e:[e],r=await getItemBundles(t);if(Array.isArray(e))return r.map(e=>e?.recipe?[e.recipe]:[]);const i=r[0]?.recipe;return i?[i]:[]}export async function getRecipeDetails(e){const t=`recipe_${e}`,r=getCached(t,!0);try{const i=await fetchWithCache(`${API_BASE_URL}/recipes/${e}`,{},t,r);if(!i.ok)return null;const n=await i.json();if(!n)return null;n.lastUpdated=(new Date).toISOString();const s=i.headers.get("ETag"),c=i.headers.get("Last-Modified");return setCached(t,n,void 0,{etag:s,lastModified:c}),n}catch(e){return console.error("Error en getRecipeDetails:",e),null}}export async function getItemDetails(e){if(Array.isArray(e)){return(await getItemBundles(e)).map(e=>e?.item||null)}const t=await getItemBundles([e]);return t[0]?.item||null}export async function getItemPrices(e){if(Array.isArray(e)){const t=await preloadPrices(e);return e.map(e=>{const r=t.get(e)||{};return{buys:{unit_price:r.buy_price||0},sells:{unit_price:r.sell_price||0}}})}const t=await getPrice(e);return{buys:{unit_price:t?.buy_price||0},sells:{unit_price:t?.sell_price||0}}}"undefined"!=typeof window&&(window.getRecipesForItem=getRecipesForItem,window.getRecipeDetails=getRecipeDetails,window.getItemDetails=getItemDetails,window.getItemPrices=getItemPrices,window.getItemBundles=getItemBundles);