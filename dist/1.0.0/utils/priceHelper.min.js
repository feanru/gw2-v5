import config from"../config.js";const memoryCache=new Map,CACHE_TTL=3e5;function isSessionStrategy(){return"sessionStorage"===(config?.priceCacheStrategy||"sessionStorage")}function storageKey(e){return`price_${e}`}function loadFromSession(e){if(!isSessionStrategy()||"undefined"==typeof sessionStorage)return null;const r=sessionStorage.getItem(storageKey(e));if(!r)return null;try{const{value:t,expires:s}=JSON.parse(r);return s&&Date.now()>s?(sessionStorage.removeItem(storageKey(e)),null):t}catch{return sessionStorage.removeItem(storageKey(e)),null}}function saveToSession(e,r){if(isSessionStrategy()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(storageKey(e),JSON.stringify({value:r,expires:Date.now()+3e5}))}catch{}}async function fetchPrices(e){if(!Array.isArray(e)||0===e.length)return new Map;if("redis"===(config?.priceCacheStrategy||"sessionStorage")){const r=`/backend/api/itemBundle.php?ids=${e.join(",")}`,t=await fetch(r);if(!t.ok)throw new Error("Price fetch failed");const s=await t.json(),o=new Map;return s.forEach(e=>{const r=e.market||{};o.set(e.id,{buy_price:r.buy_price||0,sell_price:r.sell_price||0})}),o}{const r=`https://api.datawars2.ie/gw2/v1/items/csv?fields=${["id","buy_price","sell_price"].join(",")}&ids=${e.join(",")}`,t=await fetch(r);if(!t.ok)throw new Error("Price fetch failed");const s=(await t.text()).trim().split("\n"),o=s[0].split(","),i=new Map;for(let e=1;e<s.length;e++){if(!s[e])continue;const r=s[e].split(","),t={};o.forEach((e,s)=>{const o=r[s];t[e]=void 0!==o?isNaN(o)?o:Number(o):null}),null!=t.id&&i.set(t.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}return i}}export async function preloadPrices(e=[]){const r=new Map,t=[];if(e.forEach(e=>{if(e=Number(e),memoryCache.has(e))return void r.set(e,memoryCache.get(e));const s=loadFromSession(e);s?(memoryCache.set(e,s),r.set(e,s)):t.push(e)}),t.length)try{(await fetchPrices(t)).forEach((e,t)=>{memoryCache.set(t,e),saveToSession(t,e),r.set(t,e)})}catch(e){console.error("Error preloading prices",e)}return e.forEach(e=>{e=Number(e),!r.has(e)&&memoryCache.has(e)&&r.set(e,memoryCache.get(e)),r.has(e)||r.set(e,{buy_price:0,sell_price:0})}),r}export async function getPrice(e){if(e=Number(e),memoryCache.has(e))return memoryCache.get(e);const r=loadFromSession(e);if(r)return memoryCache.set(e,r),r;return(await preloadPrices([e])).get(e)}export function clearCache(){if(memoryCache.clear(),isSessionStrategy()&&"undefined"!=typeof sessionStorage)for(let e=sessionStorage.length-1;e>=0;e--){const r=sessionStorage.key(e);r&&r.startsWith("price_")&&sessionStorage.removeItem(r)}}