import{c as e}from"./services-BpgNmOWZ.js";const t=[];function n(){const e=Date.now()-6e4;for(;t.length&&t[0]<e;)t.shift()}function r(){n();const e=t.length;return e>5?"down":e>0?"slow":"ok"}let o;function s(){if("undefined"==typeof document)return;const e=r();o||(o=document.createElement("div"),o.id="api-status-indicator",o.style.position="fixed",o.style.bottom="10px",o.style.right="10px",o.style.padding="4px 8px",o.style.background="rgba(0,0,0,0.7)",o.style.color="#fff",o.style.borderRadius="4px",o.style.zIndex="10000",o.style.display="none",document.body.appendChild(o)),"ok"===e?o.style.display="none":(o.textContent="slow"===e?"API lenta":"API ca√≠da",o.style.display="block")}var i={recordFailure:function(){t.push(Date.now()),n(),s()},recordSuccess:function(){n(),s()},getState:r,getBackoff:function(){const e=r();return"down"===e?5e3:"slow"===e?1e3:0}};async function a(e,t={}){const{timeout:n=8e3,retries:r=3,backoff:o=300,signal:s,...a}=t;for(let t=0;t<=r;t++){const c=new AbortController,l=setTimeout(()=>c.abort(),n);s&&(s.aborted?c.abort():s.addEventListener("abort",()=>c.abort(),{once:!0}));try{const t=await fetch(e,{...a,signal:c.signal});return clearTimeout(l),i.recordSuccess(),t}catch(e){if(clearTimeout(l),i.recordFailure(),s?.aborted||t===r)throw e;const n=o*Math.pow(2,t);await new Promise(e=>setTimeout(e,n))}}}const c={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},l="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let u=null;function f(e){l&&l.postMessage({type:"delete",key:e})}const d=new Map;!function(e){u=e,l&&l.addEventListener("message",({data:e})=>{const{type:t,key:n,entry:r}=e||{};if("request-bundles"!==t)t&&n&&("set"===t&&r?u.set(n,r):"delete"===t&&u.delete(n));else{if(!u)return;u.forEach((e,t)=>{t.startsWith("bundle_")&&l.postMessage({type:"set",key:t,entry:e})})}})}(d),l&&l.postMessage({type:"request-bundles"});const g="undefined"!=typeof localStorage,p=new Map;function h(e){try{return JSON.parse(e)}catch{return null}}function y(e,t){if(g)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:n,lastModified:r}){return JSON.stringify({value:e,expiresAt:t,etag:n,lastModified:r})}(t))}catch{}}function m(e,t,n=void 0,r={}){if(void 0===n){const t=e.split("_")[0];n=c[t]}const o=null==n?null:Date.now()+n,{etag:s=null,lastModified:i=null}=r,a={value:t,expiresAt:o,updatedAt:(new Date).toISOString(),etag:s,lastModified:i};d.set(e,a),y(e,{value:t,expiresAt:o,etag:s,lastModified:i}),function(e,t){l&&l.postMessage({type:"set",key:e,entry:t})}(e,a)}function w(e,t=!1){let n=d.get(e);if(!n){const t=function(e){if(!g)return null;const t=localStorage.getItem(e);if(!t)return null;const n=h(t);return n||(localStorage.removeItem(e),null)}(e);if(t){const{value:r,expiresAt:o=null,etag:s=null,lastModified:i=null}=t;n={value:r,expiresAt:o,updatedAt:(new Date).toISOString(),etag:s,lastModified:i},d.set(e,n)}}return n?n.expiresAt&&Date.now()>n.expiresAt?(d.delete(e),g&&localStorage.removeItem(e),f(e),null):t?n:n.value:null}function S(e,t={}){const n=function(e,{method:t="GET",headers:n={}}={}){return`${e}|${t.toUpperCase()}|${JSON.stringify(n)}`}(e,t),r=p.get(n)||a(e,t).finally(()=>p.delete(n));return p.set(n,r),r.then(e=>e.clone())}!function(){if(!g)return;const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t),r=h(localStorage.getItem(n));if(!r)continue;const{expiresAt:o}=r;o&&Date.now()>o&&e.push(n)}e.forEach(e=>{localStorage.removeItem(e),f(e)})}();const b=new Map;function v(){return"sessionStorage"===e?.priceCacheStrategy}function M(e){return`price_${e}`}function _(e){if(!v()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(M(e));if(!t)return null;try{const{value:n,expires:r}=JSON.parse(t);return r&&Date.now()>r?(sessionStorage.removeItem(M(e)),null):n}catch{return sessionStorage.removeItem(M(e)),null}}async function I(t=[]){const n=new Map,r=[];if(t.forEach(e=>{if(e=Number(e),b.has(e))return void n.set(e,b.get(e));const t=_(e);t?(b.set(e,t),n.set(e,t)):r.push(e)}),r.length)try{const t=await async function(t){if(!Array.isArray(t)||0===t.length)return new Map;if("redis"===e?.priceCacheStrategy){const e=`/backend/api/itemBundle.php?ids=${t.join(",")}`,n=await fetch(e);if(!n.ok)throw new Error("Price fetch failed");const r=await n.json(),o=new Map;return r.forEach(e=>{const t=e.market||{};o.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),o}{const e=`https://api.datawars2.ie/gw2/v1/items/csv?fields=${["id","buy_price","sell_price"].join(",")}&ids=${t.join(",")}`,n=await fetch(e);if(!n.ok)throw new Error("Price fetch failed");const r=(await n.text()).trim().split("\n"),o=r[0].split(","),s=new Map;for(let e=1;e<r.length;e++){if(!r[e])continue;const t=r[e].split(","),n={};o.forEach((e,r)=>{const o=t[r];n[e]=void 0!==o?isNaN(o)?o:Number(o):null}),null!=n.id&&s.set(n.id,{buy_price:n.buy_price||0,sell_price:n.sell_price||0})}return s}}(r);t.forEach((e,t)=>{b.set(t,e),function(e,t){if(v()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(M(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(t,e),n.set(t,e)})}catch(e){console.error("Error preloading prices",e)}return t.forEach(e=>{e=Number(e),!n.has(e)&&b.has(e)&&n.set(e,b.get(e)),n.has(e)||n.set(e,{buy_price:0,sell_price:0})}),n}async function E(e){if(e=Number(e),b.has(e))return b.get(e);const t=_(e);if(t)return b.set(e,t),t;return(await I([e])).get(e)}function A(){if(b.clear(),v()&&"undefined"!=typeof sessionStorage)for(let e=sessionStorage.length-1;e>=0;e--){const t=sessionStorage.key(e);t&&t.startsWith("price_")&&sessionStorage.removeItem(t)}}var x=Object.freeze({__proto__:null,clearCache:A,getPrice:E,preloadPrices:I});function k(e=[],t,n=6e4){if(!Array.isArray(e)||0===e.length)return()=>{};let r=!1;return async function o(){if(r)return;const s=i.getBackoff();s&&await new Promise(e=>setTimeout(e,s));try{const n=await I(e);"function"==typeof t&&t(n)}catch(e){i.recordFailure()}r||setTimeout(o,n)}(),()=>{r=!0}}const N=new Map;function O(e,t={},n=null,r=null,o){const s=N.get(e);s&&s.controller?.abort(),n&&!r&&(r=w(n,!0));const i={...t.headers||{}};r?.etag&&(i["If-None-Match"]=r.etag),r?.lastModified&&(i["If-Modified-Since"]=r.lastModified);const c=o?null:new AbortController,l=o??t.signal??c?.signal;return function(e,t,n){return N.set(e,{promise:t,controller:n}),t.finally(()=>N.delete(e)),t}(e,a(e,{...t,headers:i,signal:l}).then(async e=>304===e.status&&r?new Response(JSON.stringify(r.value),{status:200,headers:{"X-Cache":"HIT",ETag:r.etag||"","Last-Modified":r.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),c).then(e=>e.clone())}const P=`${e.API_BASE_URL}/items?ids=`,T=`&lang=${e.LANG}`,$=new Set,j=new Map;let C=null,D=null;function B(e){if(1!==e.length)return{};const t=w(`item_${e[0]}`,!0);if(!t)return{};const n={};return t.etag&&(n["If-None-Match"]=t.etag),t.lastModified&&(n["If-Modified-Since"]=t.lastModified),n}function z(){C||(C=setTimeout(F,50)),$.size>=200&&(clearTimeout(C),F())}async function F(){if(0===$.size)return void(C=null);C=null;const e=Array.from($).slice(0,200);e.forEach(e=>$.delete(e));try{const t=i.getBackoff();t&&await new Promise(e=>setTimeout(e,t)),D=new AbortController;const n=await a(P+e.join(",")+T,{headers:B(e),signal:D.signal,backoff:300+t});if(304===n.status)return void e.forEach(e=>{const t=j.get(e),n=w(`item_${e}`);t&&t.resolve(n),j.delete(e)});const r=n.headers.get("ETag"),o=n.headers.get("Last-Modified"),s=await n.json(),c=new Map(s.map(e=>[e.id,e]));e.forEach(e=>{const t=j.get(e),n=c.get(e);n?(m(`item_${e}`,n,void 0,{etag:r,lastModified:o}),t.resolve(n)):t.resolve(null),j.delete(e)})}catch(t){e.forEach(e=>{const n=j.get(e);n&&(t instanceof DOMException&&t.name,n.reject(t)),j.delete(e)})}$.size>0&&z()}function J(e=[],t){D&&(D.abort(),D=null);const n=e.map(e=>{const t=w(`item_${e}`);if(t)return Promise.resolve(t);if(j.has(e))return j.get(e).promise;const n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),j.set(e,n),$.add(e),z(),n.promise});return Promise.all(n)}!function(){if("undefined"!=typeof localStorage)for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t.startsWith("item_")&&w(t)}}();const L=new Map,W=new WeakMap,q=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target;if(W.set(t,e.isIntersecting),e.isIntersecting){const e=t.dataset.stateId||t.dataset.path;if(!e)return;const n=L.get(e);if(!n)return;const r=n.find(e=>e.el===t),o=t._pendingState;r&&o&&(r.renderFn(o),t._pendingState=null)}})});function R(e,t,n){const r=String(e);t.dataset.stateId=r;let o=L.get(r);o||(o=[],L.set(r,o)),o.push({el:t,renderFn:n}),q.observe(t)}function G(e,t){const n=L.get(String(e));n&&n.forEach(({el:e,renderFn:n})=>{W.get(e)?n&&n(t):e._pendingState=t})}var U=Object.freeze({__proto__:null,register:R,update:G});function H(){const e=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){const n=t.target;n.src=n.dataset.src,e.unobserve(n)}})});document.querySelectorAll("img[data-src]").forEach(t=>e.observe(t))}function X(e,t){if(!e)return;const n=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(t(),n.unobserve(e.target))})});n.observe(e)}export{O as a,E as b,A as c,S as d,k as e,a as f,w as g,R as h,H as i,x as j,U as k,X as o,I as p,J as r,m as s,G as u};
//# sourceMappingURL=utils-oHRiiC_T.v1.0.0.js.map
