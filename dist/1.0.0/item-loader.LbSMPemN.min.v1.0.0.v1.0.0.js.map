{"version":3,"file":"item-loader.LbSMPemN.min.js","sources":["../../src/js/item-loader.js"],"sourcesContent":["import fetchWithRetry from './utils/fetchWithRetry.min.js';\nimport { startPriceUpdater } from './utils/priceUpdater.min.js';\n\nlet prepareIngredientTreeData,\n  CraftIngredient,\n  setIngredientObjs,\n  findIngredientsById,\n  cancelItemRequests,\n  recalcAll,\n  getItemBundles,\n  updateState,\n  preloadPrices;\n\nlet depsPromise;\nasync function ensureDeps() {\n  if (!depsPromise) {\n    depsPromise = Promise.all([\n      import('./items-core.js'),\n      import('./utils/priceHelper.min.js'),\n      import('./services/recipeService.min.js'),\n      import('./utils/stateManager.min.js')\n    ]).then(([core, price, recipe, state]) => {\n      ({\n        prepareIngredientTreeData,\n        CraftIngredient,\n        setIngredientObjs,\n        findIngredientsById,\n        cancelItemRequests,\n        recalcAll\n      } = core);\n      ({ preloadPrices } = price);\n      ({ getItemBundles } = recipe);\n      ({ update: updateState } = state);\n    });\n  }\n  return depsPromise;\n}\n\nlet loadToken = 0;\nlet stopPriceUpdater = null;\nlet itemDetailsController = null;\n\nexport async function loadItems(ids) {\n  if (!Array.isArray(ids) || ids.length === 0) return [];\n  await ensureDeps();\n  try {\n    const bundles = await getItemBundles(ids);\n    return bundles;\n  } catch (e) {\n    console.error('Error cargando ítems', e);\n    return [];\n  }\n}\n\nexport async function loadItem(itemId) {\n  await ensureDeps();\n  const currentToken = ++loadToken;\n  if (itemDetailsController) {\n    itemDetailsController.abort();\n    itemDetailsController = null;\n  }\n  cancelItemRequests();\n\n  if (!itemId) {\n    window.hideSkeleton?.(document.getElementById('item-skeleton'));\n    window.showError?.('ID de ítem no válido');\n    return;\n  }\n\n  let rootIngredient = null;\n  let marketData = null;\n  const skeleton = document.getElementById('item-skeleton');\n\n  try {\n    window.showSkeleton?.(skeleton);\n    itemDetailsController = new AbortController();\n    const response = await fetchWithRetry(`/backend/api/itemDetails.php?itemId=${itemId}`, {\n      signal: itemDetailsController.signal\n    });\n    if (response.status === 404) {\n      window.showError?.('El ítem no existe');\n      window.hideSkeleton?.(skeleton);\n      return;\n    }\n    if (!response.ok) throw new Error(`Error ${response.status} obteniendo detalles del ítem`);\n    const contentType = response.headers.get('content-type') || '';\n    if (!contentType.includes('application/json')) {\n      throw new Error(`Respuesta no válida: ${contentType}`);\n    }\n    const { item, recipe, market, nested_recipe } = await response.json();\n    if (!item) {\n      window.showError?.('El ítem no existe');\n      window.hideSkeleton?.(skeleton);\n      return;\n    }\n    if (currentToken !== loadToken) return;\n\n    // El skeleton se ocultará tras renderizar la UI\n    marketData = market || {};\n    window._mainBuyPrice = marketData.buy_price || 0;\n    window._mainSellPrice = marketData.sell_price || 0;\n\n    if (!recipe) {\n      setIngredientObjs([]);\n      window.initItemUI(item, marketData);\n      return;\n    }\n\n    if (nested_recipe) {\n      recipe.nested_recipe = nested_recipe;\n    }\n    window._mainRecipeOutputCount = recipe.output_item_count || 1;\n\n    setTimeout(async () => {\n      if (currentToken !== loadToken) return;\n      let children;\n      try {\n        children = await prepareIngredientTreeData(itemId, recipe);\n      } catch (err) {\n        console.error('Error preparando ingredientes', err);\n        window.showError?.('Error al preparar los ingredientes');\n        setIngredientObjs([]);\n        window.initItemUI(item, marketData);\n        return;\n      }\n      if (!Array.isArray(children)) children = [];\n      rootIngredient = new CraftIngredient({\n        id: item.id,\n        name: item.name,\n        icon: item.icon,\n        rarity: item.rarity,\n        count: 1,\n        buy_price: marketData?.buy_price || 0,\n        sell_price: marketData?.sell_price || 0,\n        is_craftable: true,\n        recipe,\n        children\n      });\n      rootIngredient.recalc(window.globalQty || 1, null);\n      setIngredientObjs([rootIngredient]);\n      await window.initItemUI(item, marketData);\n      await window.safeRenderTable?.();\n\n      function collectIds(node, acc) {\n        acc.add(node.id);\n        if (node.children) node.children.forEach(child => collectIds(child, acc));\n      }\n      const allIds = new Set();\n      collectIds(rootIngredient, allIds);\n\n        if (stopPriceUpdater) stopPriceUpdater();\n        const idsArray = Array.from(allIds);\n        const applyPrices = async (priceMap) => {\n          if (!document.getElementById('seccion-crafting')) {\n            requestAnimationFrame(() => applyPrices(priceMap));\n            return;\n          }\n          const updatedNodes = [];\n          priceMap.forEach((data, id) => {\n            const ings = findIngredientsById(window.ingredientObjs, Number(id));\n            if (!ings.length) return;\n            ings.forEach(ing => {\n              ing.buy_price = data.buy_price || 0;\n              ing.sell_price = data.sell_price || 0;\n              if (ing === window.ingredientObjs[0]) {\n                window._mainBuyPrice = ing.buy_price;\n                window._mainSellPrice = ing.sell_price;\n              }\n              updatedNodes.push(ing);\n            });\n          });\n          await window.safeRenderTable?.();\n          const totals = window.getTotals?.();\n          if (totals) {\n            updateState('totales-crafting-global', totals);\n            updateState('totales-crafting-unit', totals);\n          }\n          updatedNodes.forEach(ing => updateState(ing._uid, ing));\n        };\n        stopPriceUpdater = startPriceUpdater(idsArray, applyPrices);\n      }, 0);\n    } catch (err) {\n    if (err.name === 'AbortError') return;\n    console.error('Error cargando ítem', err);\n    window.showError?.('Error al cargar los datos del ítem');\n    window.hideSkeleton?.(skeleton);\n  } finally {\n    itemDetailsController = null;\n  }\n}\n\n// Cargar datos y preparar la UI al iniciar la página\ndocument.addEventListener('DOMContentLoaded', () => {\n  const start = () => {\n    const params = new URLSearchParams(window.location.search);\n    const itemId = parseInt(params.get('id'), 10);\n    if (itemId) {\n      loadItem(itemId);\n    } else {\n      window.showError?.('ID de ítem no válido');\n    }\n  };\n  if ('requestIdleCallback' in window) {\n    requestIdleCallback(start);\n  } else {\n    setTimeout(start, 0);\n  }\n});\n"],"names":["prepareIngredientTreeData","CraftIngredient","setIngredientObjs","findIngredientsById","cancelItemRequests","recalcAll","getItemBundles","updateState","preloadPrices","depsPromise","async","ensureDeps","Promise","all","import","then","n","j","k","core","price","recipe","state","update","loadToken","stopPriceUpdater","itemDetailsController","loadItems","ids","Array","isArray","length","e","console","error","loadItem","itemId","currentToken","abort","window","hideSkeleton","document","getElementById","showError","rootIngredient","marketData","skeleton","showSkeleton","AbortController","response","fetchWithRetry","signal","status","ok","Error","contentType","headers","get","includes","item","market","nested_recipe","json","_mainBuyPrice","buy_price","_mainSellPrice","sell_price","initItemUI","_mainRecipeOutputCount","output_item_count","setTimeout","children","err","id","name","icon","rarity","count","is_craftable","recalc","globalQty","safeRenderTable","allIds","Set","collectIds","node","acc","add","forEach","child","idsArray","from","applyPrices","priceMap","requestAnimationFrame","updatedNodes","data","ings","ingredientObjs","Number","ing","push","totals","getTotals","_uid","startPriceUpdater","addEventListener","start","params","URLSearchParams","location","search","parseInt","requestIdleCallback"],"mappings":"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"}