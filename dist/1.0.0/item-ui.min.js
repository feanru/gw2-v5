import{showSkeleton,hideSkeleton,showError,hideError,setQtyInputValue,getQtyInputValue}from"/dist/1.0.0/ui-helpers.min.js";import{register,update as updateState}from"/dist/1.0.0/utils/stateManager.min.js";import{initLazyImages,observeSection}from"/dist/1.0.0/utils/lazyLoader.min.js";function renderWiki(name){if(!name)return;const nombre=encodeURIComponent(name.replaceAll(" ","_"));const wikiES=`https://wiki.guildwars2.com/wiki/es:${nombre}`;const wikiEN=`https://wiki.guildwars2.com/wiki/${nombre}`;const wikiLinksEl=document.getElementById("wiki-links");if(!wikiLinksEl)return;wikiLinksEl.innerHTML=`\n    <div class="wiki-links">\n      <a href="${wikiES}" target="_blank">Wiki en Espa√±ol</a>\n      <a href="${wikiEN}" target="_blank">Wiki en Ingl√©s</a>\n    </div>\n  `}export function renderRows(ings,nivel=1,parentId=null,rowGroupIndex=0,parentExpanded=true,path=[]){return ings.map((ing,idx)=>{const groupIdx=nivel===0?idx:rowGroupIndex;const rowBgClass=groupIdx%2===0?"row-bg-a":"row-bg-b";const indent=nivel>0?`style="padding-left:${nivel*30}px"`:"";const childClass=`child-of-${ing.id}`;const currentPath=[...path,ing._uid].join("-");const expandButton=ing.is_craftable&&ing.children&&ing.children.length?`<button class="btn-expand-path" data-path="${currentPath}">${ing.expanded?"-":"+"}</button>`:"";const isChild=nivel>0;const extraClass=isChild?`child-of-${parentId}`:"";const extraStyle=isChild&&!parentExpanded?'style="display:none"':"";const noMarketPrice=!ing.buy_price&&!ing.sell_price;const hasChildren=ing.is_craftable&&ing.children&&ing.children.length>0;const isLeaf=!hasChildren;const showCrafted=nivel===0||hasChildren&&(noMarketPrice||ing.total_crafted!=null)||!hasChildren&&ing.total_crafted!=null;const rarityClass=typeof getRarityClass==="function"?getRarityClass(ing.rarity):"";return`\n      <tr data-state-id="${ing._uid}" data-path="${currentPath}" class="${isChild?`subrow subrow-${nivel} ${extraClass}`:""} ${rowBgClass}" ${extraStyle}>\n        <td class="th-border-left-items" ${indent}><img data-src="${ing.icon}" width="32" class="lazy-img" alt=""></td>\n        <td><a href="/item?id=${ing.id}" class="item-link ${rarityClass}" target="_blank">${ing.name}</a></td>\n        <td>${ing.countTotal!=null?ing.countTotal:ing.count}</td>\n        <td class="item-solo-buy">\n          <div>${formatGoldColored(ing.total_buy)}</div>\n          <div class="item-solo-precio">${formatGoldColored(ing.buy_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${isChild?`<input type="radio" name="mode-${ing._uid}" class="chk-mode-buy" data-uid="${ing._uid}" ${ing.modeForParentCrafted==="buy"?"checked":""} title="Usar precio de compra para el padre">`:""}\n        </td>\n        <td class="item-solo-sell">\n          <div>${formatGoldColored(ing.total_sell)}</div>\n          <div class="item-solo-precio">${formatGoldColored(ing.sell_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${isChild?`<input type="radio" name="mode-${ing._uid}" class="chk-mode-sell" data-uid="${ing._uid}" ${ing.modeForParentCrafted==="sell"?"checked":""} title="Usar precio de venta para el padre">`:""}\n        </td>\n        <td class="item-solo-crafted">\n          ${showCrafted?`<div>${formatGoldColored(ing.total_crafted||0)}</div>`+`<div class="item-solo-precio">${formatGoldColored(0)} <span style="color:#c99b5b">c/u</span></div>`+`${isChild?`<input type="radio" name="mode-${ing._uid}" class="chk-mode-crafted" data-uid="${ing._uid}" ${ing.modeForParentCrafted==="crafted"?"checked":""} title="Usar precio de crafteo para el padre">`:""}`:""}\n        </td>\n        <td class="th-border-right-items">${expandButton}</td>\n      </tr>\n      ${ing.is_craftable&&ing.children&&ing.children.length&&parentExpanded&&ing.expanded?renderRows(ing.children,nivel+1,ing.id,groupIdx,ing.expanded,[...path,ing._uid]):""}\n    `}).join("")}export function renderMainItemRow(mainNode){if(!mainNode)return"";let childTotals={totalBuy:0,totalSell:0};let craftedFallback=0;if(mainNode.children&&mainNode.children.length>0){const totalsFromChildren=getTotals();childTotals.totalBuy=totalsFromChildren.totalBuy;childTotals.totalSell=totalsFromChildren.totalSell;craftedFallback=totalsFromChildren.totalCrafted}const totals={totalBuy:childTotals.totalBuy,totalSell:childTotals.totalSell,totalCrafted:mainNode.total_crafted!=null?mainNode.total_crafted:craftedFallback};const buyPriceUnit=mainNode.buy_price||0;const sellPriceUnit=mainNode.sell_price||0;const rarityClass=typeof getRarityClass==="function"?getRarityClass(mainNode.rarity):"";const expandBtn=`<button class="btn-expand-path" data-path="${mainNode._uid}">${mainNode.expanded?"-":"+"}</button>`;return`\n    <tr data-state-id="${mainNode._uid}" data-path="${mainNode._uid}" data-item-id="${mainNode.id}" class="ingred-row ${mainNode.expanded?"expanded":""}">\n      \x3c!-- Col 1: √çcono (SIN colspan) --\x3e\n      <td class="th-border-left-items">\n        <img src="${mainNode.icon}" width="32">\n      </td>\n\n      \x3c!-- Col 2: Nombre --\x3e\n      <td>\n        <span class="item-link ${rarityClass}">${mainNode.name}</span>\n      </td>\n\n      \x3c!-- Col 3: Cantidad --\x3e\n      <td>${mainNode.countTotal!=null?mainNode.countTotal:mainNode.count}</td>\n\n      \x3c!-- Col 4: Total Compra --\x3e\n      <td class="item-solo-buy">\n        <div>${formatGoldColored(totals.totalBuy)}</div>\n        <div class="item-solo-precio">${formatGoldColored(buyPriceUnit)} <span style="color:#c99b5b">c/u</span></div>\n      </td>\n\n      \x3c!-- Col 5: Total Venta --\x3e\n      <td class="item-solo-sell">\n        <div>${formatGoldColored(totals.totalSell)}</div>\n        <div class="item-solo-precio">${formatGoldColored(sellPriceUnit)} <span style="color:#c99b5b">c/u</span></div>\n      </td>\n\n      \x3c!-- Col 6: Total Crafteo --\x3e\n      <td class="item-solo-crafted">\n        <div>${formatGoldColored(totals.totalCrafted)}</div>\n        <div class="item-solo-precio">${formatGoldColored(0)} <span style="color:#c99b5b">c/u</span></div>\n      </td>\n\n      \x3c!-- Col 7: Bot√≥n (alineado con hijos) --\x3e\n      <td class="th-border-right-items">${expandBtn}</td>\n    </tr>\n  `}function renderCraftingSectionUI(){const ingList=window.ingredientObjs||[];let outputCount=1;const mainRoot=ingList.length>0?ingList[0]:null;if(mainRoot&&mainRoot.recipe&&mainRoot.recipe.output_item_count&&!isNaN(mainRoot.recipe.output_item_count)){outputCount=mainRoot.recipe.output_item_count}else if(window._mainRecipeOutputCount&&!isNaN(window._mainRecipeOutputCount)){outputCount=window._mainRecipeOutputCount}let totals={totalBuy:0,totalSell:0,totalCrafted:0};let childTotals=null;if(mainRoot&&mainRoot.children&&mainRoot.children.length>0){childTotals=getTotals();totals.totalBuy=childTotals.totalBuy;totals.totalSell=childTotals.totalSell}if(mainRoot){totals.totalCrafted=mainRoot.total_crafted!=null?mainRoot.total_crafted:childTotals?childTotals.totalCrafted:0}const qtyValue=typeof getQtyInputValue()!=="undefined"?getQtyInputValue():window.globalQty;const precioCompraTotal=mainRoot&&typeof mainRoot.buy_price==="number"?mainRoot.buy_price*qtyValue:0;const precioVentaTotal=mainRoot&&typeof mainRoot.sell_price==="number"?mainRoot.sell_price*qtyValue:0;const precioCraftTotal=totals.totalCrafted;const precioCraftingMinTotal=Math.min(totals.totalBuy,totals.totalSell,totals.totalCrafted);const precioCraftingMinUnidad=outputCount>0?precioCraftingMinTotal/outputCount:precioCraftingMinTotal;const precioCompraUnidad=outputCount>0?totals.totalBuy/outputCount:totals.totalBuy;const precioVentaUnidad=outputCount>0?totals.totalSell/outputCount:totals.totalSell;const precioCraftUnidad=outputCount>0?totals.totalCrafted/outputCount:totals.totalCrafted;const preciosFinales=[precioCompraTotal,precioVentaTotal,precioCraftingMinTotal];const precioMinimoFinal=Math.min(...preciosFinales.filter(x=>x>0));const preciosFinalesUnidad=[precioCompraUnidad,precioVentaUnidad,precioCraftingMinUnidad];const precioMinimoFinalUnidad=Math.min(...preciosFinalesUnidad.filter(x=>x>0));const minIdx=preciosFinales.indexOf(precioMinimoFinal);const minIdxUnidad=preciosFinalesUnidad.indexOf(precioMinimoFinalUnidad);let mensaje="";if(minIdx===0)mensaje="Mejor comprar (Buy)";else if(minIdx===1)mensaje="Mejor vender (Sell)";else mensaje="Mejor craftear (Crafteo)";let htmlTabla="";if(mainRoot){htmlTabla+=renderMainItemRow(mainRoot,0);htmlTabla+=renderRows(mainRoot.children,1,null,0,!!mainRoot.expanded,[mainRoot._uid])}let profitHtml="";let profitHtmlUnidad="";if(precioVentaTotal>0){const ventaTrasComisionTotal=precioVentaTotal-precioVentaTotal*.15;const ventaTrasComisionUnidad=outputCount>0?ventaTrasComisionTotal/outputCount:ventaTrasComisionTotal;const profitBuyUnidad=ventaTrasComisionUnidad-totals.totalBuy/outputCount;const profitSellUnidad=ventaTrasComisionUnidad-totals.totalSell/outputCount;const profitCraftedUnidad=ventaTrasComisionUnidad-totals.totalCrafted/outputCount;const profitBuyTotal=ventaTrasComisionTotal-totals.totalBuy;const profitSellTotal=ventaTrasComisionTotal-totals.totalSell;const profitCraftedTotal=ventaTrasComisionTotal-totals.totalCrafted;if(outputCount===1){profitHtml=`<section id='profit-section'><br>\n        <div class="table-modern-totales">\n        <div class="titulo-con-ayuda">\n          <div class="ayuda-tooltip">?\n            <span class="tooltiptext-modern"> Esta secci√≥n muestra la ganancia estimada al vender el √≠tem despu√©s de craftearlo. Se calcula como: (Precio venta - 15% comisi√≥n) - costo total de crafteo. Tambi√©n muestra 3 posibles resultados dependiendo de la forma de craftear.</span>\n          </div>\n          <h3>Profit si se craftea y se vende (ganancia estimada)</h3>\n        </div>\n        <table class='table-totales totales-crafting-comparativa' style='margin-bottom: 8px;'>\n          <tr style='text-align:center;'>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(profitBuyTotal))} <br><span style='font-size:0.93em;'>Profit "Comprar"</span></div></td>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(profitSellTotal))} <br><span style='font-size:0.93em;'>Profit "Vender"</span></div></td>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(profitCraftedTotal))} <br><span style='font-size:0.93em;'>Profit "Craftear"</span></div></td>\n          </tr>\n          <tr><td colspan='3' style='text-align:center;font-size:0.98em;color:#a1a1aa;'>La ganancia se calcula como: (Precio venta - 15% comisi√≥n) - costo total</td></tr>\n        </table>\n      </div>\n      </section>`}if(outputCount>1){const precioVentaUnidadMercado=_mainSellPrice!=null?_mainSellPrice:0;const ventaTrasComisionUnidadMercado=precioVentaUnidadMercado-precioVentaUnidadMercado*.15;const profitBuyUnidadMercado=ventaTrasComisionUnidadMercado-totals.totalBuy/outputCount;const profitSellUnidadMercado=ventaTrasComisionUnidadMercado-totals.totalSell/outputCount;const profitCraftedUnidadMercado=ventaTrasComisionUnidadMercado-totals.totalCrafted/outputCount;profitHtmlUnidad=`<section id='profit-section-unidad'><br>\n        <div class="table-modern-totales">          \n        <h3>Profit si se craftea y se vende por UNIDAD (ganancia estimada)</h3>\n        <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${outputCount}</b> unidades por crafteo. Los siguientes c√°lculos son por unidad.</div>\n        <table class='table-totales totales-crafting-comparativa' style='margin-bottom: 8px;'>\n          <tr style='text-align:center;'>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(profitBuyUnidadMercado))} <br><span style='font-size:0.93em;'>Profit "Comprar"</span></div></td>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(profitSellUnidadMercado))} <br><span style='font-size:0.93em;'>Profit "Vender"</span></div></td>\n            <td><div class='base-comparativa'>${formatGoldColored(Math.round(profitCraftedUnidadMercado))} <br><span style='font-size:0.93em;'>Profit "Craftear"</span></div></td>\n          </tr>\n          <tr><td colspan='3' style='text-align:center;font-size:0.98em;color:#a1a1aa;'>La ganancia por unidad se calcula como: (Precio venta unitario - 15% comisi√≥n) - costo unitario</td></tr>\n        </table>\n      </div>\n      </section>`}}let tablaIngredientes=`<table class="table-crafting" id="tabla-crafting">\n    <thead class="header-items">\n      <tr>\n        <th class="th-border-left-items"></th>\n        <th>Nombre</th>\n        <th>Cantidad</th>\n        <th>Total Compra</th>\n        <th>Total Venta</th>\n        <th>Total Crafteo</th>\n        <th class="th-border-right-items"></th>\n      </tr>\n    </thead>\n    <tbody>\n      ${htmlTabla}\n    </tbody>\n  </table>`;let inputQtyHtml=`<div id="qty-global-container" style="margin:18px 0 18px 0;display:flex;align-items:center;gap:12px;">\n    <label for="qty-global" style="font-weight:500;">Cantidad global:</label>\n    <input id="qty-global" type="number" min="1" value="${qtyValue}" style="width:60px;height:36px;" autocomplete="off">\n  </div>`;let tablaTotales=`<div class="table-modern-totales">\n    <div class="titulo-con-ayuda">\n      <div class="ayuda-tooltip">?\n        <span class="tooltiptext-modern">Esta secci√≥n muestra el costo total de los materiales necesarios para craftear el √≠tem. Con costo de materiales en venta directa, pedido y crafteo de sus propio materiales.</span>\n      </div>\n      <h3>Precio total materiales - Crafting</h3>\n    </div>\n    <div id="totales-crafting">      \n      <table class="table-totales" style="margin-top:12px;">\n        <tr>\n          <th><div class="tooltip-modern">Total Compra\n            <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-buy">${formatGoldColored(totals.totalBuy)} </td>\n          <th><div class="tooltip-modern">Total Venta\n            <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-sell">${formatGoldColored(totals.totalSell)}</td>\n          <th><div class="tooltip-modern">Total Crafteo\n            <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n          </div></th>\n          <td class="item-solo-crafted">${formatGoldColored(totals.totalCrafted)}</td>\n        </tr>\n      </table>\n    </div>\n    </div>`;let tablaTotalesUnidad="";if(outputCount>1){tablaTotalesUnidad=`<div class="table-modern-totales">\n    <div class="titulo-con-ayuda">\n      <div class="ayuda-tooltip">?\n        <span class="tooltiptext-modern">Muestra el costo por unidad ya que esta receta produce m√∫ltiples √≠tems</span>\n      </div>\n      <h3>Costos por unidad (${outputCount} unidades por crafteo)</h3>\n    </div>\n    <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${outputCount}</b> unidades por crafteo.</div>\n      <div id="totales-crafting">\n        <table class="table-totales" style="margin-top:12px;">\n          <tr>\n            <th><div class="tooltip-modern">Total Compra\n              <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-buy">${formatGoldColored(totals.totalBuy/outputCount)}</td>\n            <th><div class="tooltip-modern">Total Venta\n              <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-sell">${formatGoldColored(totals.totalSell/outputCount)}</td>\n            <th><div class="tooltip-modern">Total Crafteo\n              <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n            </div></th>\n            <td class="item-solo-crafted">${formatGoldColored(totals.totalCrafted/outputCount)}</td>\n          </tr>\n        </table>\n      </div>\n    </div>`}let tablaComparativa="";let tablaComparativaUnidad="";if(outputCount===1){tablaComparativa=`<section id='comparativa-section'>\n      <div class="table-modern-totales">\n        <div class="titulo-con-ayuda">\n          <div class="ayuda-tooltip">?\n            <span class="tooltiptext-modern"> Esta secci√≥n compara el precio de compra directa y pedido en el mercado con el costo de crafteo m√°s bajo.</span>\n          </div>\n          <h3>Comparativa de precios de Bazar vs Crafting</h3>\n        </div>\n        <br>\n        <table class='table-totales totales-crafting-comparativa'>\n          <tr style='text-align:center;'>\n            <td><div class='base-comparativa' style='${minIdx===0?"background:#e84d4d33;":""}'>${formatGoldColored(precioCompraTotal)} <br><span style='font-size:0.93em;'>Precio compra</span></div></td>\n            <td><div class='base-comparativa' style='${minIdx===1?"background:#4db1e833;":""}'>${formatGoldColored(precioVentaTotal)} <br><span style='font-size:0.93em;'>Precio venta</span></div></td>\n            <td><div class='base-comparativa' style='${minIdx===2?"background:#4fc17833;":""}'>${formatGoldColored(precioCraftingMinTotal)} <br><span style='font-size:0.93em;'>Precio crafting m√°s bajo</span></div></td>\n          </tr>\n          <tr><td colspan='3' style='text-align:center;font-size:1.07em;'>${mensaje}</td></tr>\n        </table>\n      </div>\n      </section>`}if(outputCount>1){const globalQty=window.globalQty||1;const precioCompraUnidadMercado=_mainBuyPrice!=null?_mainBuyPrice*globalQty:0;const precioVentaUnidadMercado=_mainSellPrice!=null?_mainSellPrice*globalQty:0;const precioCraftingMinUnidadReal=outputCount>0?precioCraftingMinTotal/outputCount:precioCraftingMinTotal;const preciosUnidadCorr=[precioCompraUnidadMercado,precioVentaUnidadMercado,precioCraftingMinUnidadReal];const precioMinimoUnidadReal=Math.min(...preciosUnidadCorr.filter(x=>x>0));const minIdxUnidad=preciosUnidadCorr.indexOf(precioMinimoUnidadReal);tablaComparativaUnidad=`<section id='comparativa-section-unidad'>\n      <div class="table-modern-totales"><br>\n        <h3>Comparativa de precios de Bazar vs Crafting por UNIDAD</h3>\n        <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${outputCount}</b> unidades por crafteo. Los siguientes precios son por unidad.</div>\n        <table class='table-totales totales-crafting-comparativa'>\n          <tr style='text-align:center;'>\n            <td><div style='${minIdxUnidad===0?"background:#e84d4d33;font-weight:bold;border-radius:6px;padding:10px;":""}'>${formatGoldColored(precioCompraUnidadMercado)} <br><span style='font-size:0.93em;'>Precio compra</span></div></td>\n            <td><div style='${minIdxUnidad===1?"background:#4db1e833;font-weight:bold;border-radius:6px;padding:10px;":""}'>${formatGoldColored(precioVentaUnidadMercado)} <br><span style='font-size:0.93em;'>Precio venta</span></div></td>\n            <td><div style='${minIdxUnidad===2?"background:#4fc17833;font-weight:bold;border-radius:6px;padding:10px;":""}'>${formatGoldColored(precioCraftingMinUnidadReal)} <br><span style='font-size:0.93em;'>Precio crafting m√°s bajo</span></div></td>\n          </tr>\n          <tr><td colspan='3' style='text-align:center;font-size:1.07em;'>${mensaje}</td></tr>\n        </table>\n      </div>\n      </section>`}let htmlFinal=`\n    ${inputQtyHtml}\n    <table class="table-modern tabla-tarjetas">\n      <thead class="header-items">\n        <tr>\n          <th class="th-border-left">√çcono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n          <th>Total Crafteo</th>\n          <th class="th-border-right"></th>\n        </tr>\n      </thead>\n      \x3c!-- üëá Aqu√≠ va la tabla correcta: root + hijos --\x3e\n      <tbody>${htmlTabla}</tbody>\n    </table>\n    ${tablaTotales}\n    ${outputCount>1?tablaTotalesUnidad:""}\n    ${tablaComparativa}\n    ${outputCount>1?tablaComparativaUnidad:""}\n    ${profitHtml}\n    ${outputCount>1?profitHtmlUnidad:""}\n  `;return htmlFinal}async function renderItemUI(itemData,marketData){const itemHeader=document.getElementById("item-header");let craftingInfo="";if(itemData.details?.disciplines?.length>0||itemData.details?.min_rating>0){const disciplineNames={Artificer:"Artesano",Armorsmith:"Armero",Chef:"Cocinero",Huntsman:"Cazador",Jeweler:"Joyero",Leatherworker:"Peletero",Tailor:"Sastre",Weaponsmith:"Armero de armas",Scribe:"Escriba"};const translatedDisciplines=(itemData.details.disciplines||[]).map(d=>disciplineNames[d]||d);craftingInfo=`\n      <div style="margin-top: 4px; color: #a1a1aa; font-size: 0.95rem;">\n        ${itemData.details.min_rating?`<span style="color: #16c198; font-weight: 500;">Nivel:</span> ${itemData.details.min_rating} `:""}\n        ${translatedDisciplines.length>0?`<span style="color: #16c198; font-weight: 500;">${itemData.details.min_rating?"‚Ä¢ ":""}Disciplinas:</span> ${translatedDisciplines.join(", ")}`:""}\n      </div>\n    `}const rarityClass=typeof getRarityClass==="function"?getRarityClass(itemData.rarity):"";itemHeader.innerHTML=`\n    <img src="${itemData.icon}" alt=""/>\n    <div>\n      <h2 class="${rarityClass}">${itemData.name}</h2>\n      <div style="color:#a1a1aa;font-size:1.05rem;">\n        ID: ${itemData.id} &nbsp;|&nbsp; ${itemData.type} ${itemData.rarity?" - "+itemData.rarity:""}\n      </div>\n      ${craftingInfo}\n    </div>\n  `;const precios=`\n    <table class="table-modern">\n      <tr>\n        <th><div class="dato-item tooltip-modern">Precio de compra\n          <span class="tooltiptext-modern">Precio al que los compradores est√°n dispuestos a adquirir el √≠tem (mejor oferta de compra).</span>\n        </div></th>\n        <td><div class="dato-item-info">${formatGoldColored(marketData.buy_price)}</div></td>\n      </tr>\n      <tr>\n        <th><div class="dato-item tooltip-modern">Precio de venta\n          <span class="tooltiptext-modern">Precio al que los vendedores ofrecen el √≠tem (mejor oferta de venta).</span>\n        </div></th>\n        <td><div class="dato-item-info">${formatGoldColored(marketData.sell_price)}</div></td>\n      </tr>\n      <tr>\n        <th><div class="dato-item tooltip-modern">Disponibles para vender\n          <span class="tooltiptext-modern">Cantidad total de √≠tems listados actualmente para vender en el mercado.</span>\n        </div></th>\n        <td><div class="dato-item-info">${marketData.sell_quantity??"-"}</div></td>\n      </tr>\n      <tr>\n        <th><div class="dato-item tooltip-modern">Disponibles para comprar\n          <span class="tooltiptext-modern">Cantidad total de √≠tems que los compradores buscan adquirir en el mercado.</span>\n        </div></th>\n        <td><div class="dato-item-info">${marketData.buy_quantity??"-"}</div></td>\n      </tr>\n    </table>\n  `;const resumenMercadoDiv=document.getElementById("resumen-mercado");if(resumenMercadoDiv){const skeletonMarket=document.createElement("div");skeletonMarket.classList.add("skeleton","skeleton-market-summary");resumenMercadoDiv.appendChild(skeletonMarket);observeSection(resumenMercadoDiv,()=>{hideSkeleton(skeletonMarket);resumenMercadoDiv.insertAdjacentHTML("beforeend",renderResumenMercado(marketData))})}const infoItemDiv=document.getElementById("info-item");if(infoItemDiv){if(window.ingredientObjs&&window.ingredientObjs.length>0){await recalcAll(window.ingredientObjs,window.globalQty)}infoItemDiv.innerHTML=`\n      <div id="seccion-totales"></div>\n      <div id="seccion-comparativa"></div>\n      <div id="seccion-crafting"></div>\n    `;document.getElementById("seccion-totales").innerHTML="";document.getElementById("seccion-comparativa").innerHTML="";document.getElementById("seccion-crafting").innerHTML=renderCraftingSectionUI();document.querySelectorAll("#seccion-crafting tr[data-state-id]").forEach(row=>{const id=row.getAttribute("data-state-id");register(id,row,ing=>{const buyCell=row.querySelector(".item-solo-buy");if(buyCell)buyCell.innerHTML=`<div>${formatGoldColored(ing.total_buy)}</div><div class="item-solo-precio">${formatGoldColored(ing.buy_price)} <span style="color: #c99b5b">c/u</span></div>`;const sellCell=row.querySelector(".item-solo-sell");if(sellCell)sellCell.innerHTML=`<div>${formatGoldColored(ing.total_sell)}</div><div class="item-solo-precio">${formatGoldColored(ing.sell_price)} <span style="color: #c99b5b">c/u</span></div>`;const craftedCell=row.querySelector(".item-solo-crafted");if(craftedCell)craftedCell.innerHTML=`<div>${formatGoldColored(ing.total_crafted||0)}</div>`+`<div class="item-solo-precio">${formatGoldColored(0)} <span style="color:#c99b5b">c/u</span></div>`})});requestAnimationFrame(()=>{initLazyImages();setTimeout(initLazyImages,0)})}renderWiki(itemData.name);installUIEvents()}function installUIEvents(){if(window._uiEventsInstalled)return;window._uiEventsInstalled=true;if(!window._qtyGlobalHandlerInstalled){window._qtyGlobalHandlerInstalled=true;document.addEventListener("input",function(e){if(e.target&&e.target.id==="qty-global"){window._qtyInputValue=e.target.value}});document.addEventListener("blur",function(e){if(e.target&&e.target.id==="qty-global"){const input=e.target;let val=parseInt(input.value,10);if(isNaN(val)||val<1){setGlobalQty(1);window._qtyInputValue="1"}else{setGlobalQty(val);window._qtyInputValue=input.value}if(typeof window._qtyInputValue!=="undefined"&&String(window._qtyInputValue)===String(window.globalQty)){delete window._qtyInputValue}safeRenderTable()}},true);document.addEventListener("keydown",function(e){if(e.target&&e.target.id==="qty-global"&&e.key==="Enter"){e.preventDefault();const input=e.target;let val=parseInt(input.value,10);if(isNaN(val)||val<1){setGlobalQty(1);window._qtyInputValue="1"}else{setGlobalQty(val);window._qtyInputValue=input.value}if(typeof window._qtyInputValue!=="undefined"&&String(window._qtyInputValue)===String(window.globalQty)){delete window._qtyInputValue}safeRenderTable()}})}document.addEventListener("change",async function(e){const input=e.target;if(!input.matches(".chk-mode-buy, .chk-mode-sell, .chk-mode-crafted"))return;const uid=input.dataset.uid;if(!uid)return;const ing=findIngredientByUid(window.ingredientObjs||[],uid);if(!ing)return;if(input.classList.contains("chk-mode-buy")){ing.modeForParentCrafted="buy"}else if(input.classList.contains("chk-mode-sell")){ing.modeForParentCrafted="sell"}else if(input.classList.contains("chk-mode-crafted")){ing.modeForParentCrafted="crafted"}await safeRenderTable()});document.addEventListener("click",function(e){const btn=e.target.closest(".btn-expand-path");if(!btn)return;const pathStr=btn.getAttribute("data-path");if(!pathStr)return;const path=pathStr.split("-").map(x=>x.trim());const ing=findIngredientByPath(window.ingredientObjs||[],path);if(ing){ing.expanded=!ing.expanded;if(typeof safeRenderTable==="function")safeRenderTable()}})}async function safeRenderTable(){await recalcAll(window.ingredientObjs||[],window.globalQty);const seccion=document.getElementById("seccion-crafting");if(seccion){const qtyInput=document.getElementById("qty-global");const currentQty=qtyInput?qtyInput.value:window.globalQty;const expandedStates=snapshotExpandState(window.ingredientObjs||[]);seccion.innerHTML=renderCraftingSectionUI();document.querySelectorAll("#seccion-crafting tr[data-state-id]").forEach(row=>{const id=row.getAttribute("data-state-id");register(id,row,ing=>{const buyCell=row.querySelector(".item-solo-buy");if(buyCell){const buyTotal=buyCell.querySelector("div:first-child");const buyUnit=buyCell.querySelector(".item-solo-precio");if(buyTotal)buyTotal.innerHTML=formatGoldColored(ing.total_buy);if(buyUnit)buyUnit.innerHTML=`${formatGoldColored(ing.buy_price)} <span style="color: #c99b5b">c/u</span>`}const sellCell=row.querySelector(".item-solo-sell");if(sellCell){const sellTotal=sellCell.querySelector("div:first-child");const sellUnit=sellCell.querySelector(".item-solo-precio");if(sellTotal)sellTotal.innerHTML=formatGoldColored(ing.total_sell);if(sellUnit)sellUnit.innerHTML=`${formatGoldColored(ing.sell_price)} <span style="color: #c99b5b">c/u</span>`}const craftedCell=row.querySelector(".item-solo-crafted");if(craftedCell){const craftedTotal=craftedCell.querySelector("div:first-child");const craftedUnit=craftedCell.querySelector(".item-solo-precio");if(craftedTotal)craftedTotal.innerHTML=formatGoldColored(ing.total_crafted||0);if(craftedUnit)craftedUnit.innerHTML=`${formatGoldColored(0)} <span style="color:#c99b5b">c/u</span>`}})});document.querySelectorAll("#totales-crafting").forEach(totEl=>{const isUnit=totEl.closest(".table-modern-totales")?.querySelector("h3")?.textContent?.includes("unidad");const stateId=isUnit?"totales-crafting-unit":"totales-crafting-global";register(stateId,totEl,totals=>{const divisor=isUnit?window._mainRecipeOutputCount&&!isNaN(window._mainRecipeOutputCount)?window._mainRecipeOutputCount:1:1;const buyCell=totEl.querySelector(".item-solo-buy");if(buyCell)buyCell.innerHTML=formatGoldColored(totals.totalBuy/divisor);const sellCell=totEl.querySelector(".item-solo-sell");if(sellCell)sellCell.innerHTML=formatGoldColored(totals.totalSell/divisor);const craftedCell=totEl.querySelector(".item-solo-crafted");if(craftedCell)craftedCell.innerHTML=formatGoldColored(totals.totalCrafted/divisor)})});const totals=getTotals();updateState("totales-crafting-global",totals);updateState("totales-crafting-unit",totals);const newQtyInput=document.getElementById("qty-global");if(newQtyInput){newQtyInput.value=currentQty}restoreExpandState(window.ingredientObjs||[],expandedStates);requestAnimationFrame(()=>{initLazyImages();setTimeout(initLazyImages,0)})}}window.safeRenderTable=safeRenderTable;setTimeout(()=>{setQtyInputValue(window.globalQty);const input=document.getElementById("qty-global");if(input){}},0);setTimeout(()=>{if(typeof installUIEvents==="function"){installUIEvents()}else{console.warn("[ADVERTENCIA] installUIEvents no est√° definido")}},0);async function initItemUI(itemData,marketData){window._lastItemData=itemData;window._lastMarketData=marketData;const skeleton=document.getElementById("item-skeleton");hideError();try{await renderItemUI(itemData,marketData)}finally{hideSkeleton(skeleton)}}window.showSkeleton=showSkeleton;window.hideSkeleton=hideSkeleton;window.showError=showError;window.hideError=hideError;window.renderItemUI=renderItemUI;window.installUIEvents=installUIEvents;window.initItemUI=initItemUI;function renderResumenMercado(marketData){return`\n      <table class="table-modern">\n        <tr>\n          <th><div class="dato-item tooltip-modern">Precio de compra\n            <span class="tooltiptext-modern">Precio al que los compradores est√°n dispuestos a adquirir el √≠tem (mejor oferta de compra).</span>\n          </div></th>\n          <td><div class="dato-item-info">${formatGoldColored(marketData.buy_price)}</div></td>\n        </tr>\n        <tr>\n          <th><div class="dato-item tooltip-modern">Precio de venta\n            <span class="tooltiptext-modern">Precio al que los vendedores ofrecen el √≠tem (mejor oferta de venta).</span>\n          </div></th>\n          <td><div class="dato-item-info">${formatGoldColored(marketData.sell_price)}</div></td>\n        </tr>\n        <tr>\n          <th><div class="dato-item tooltip-modern">Disponibles para vender\n            <span class="tooltiptext-modern">Cantidad total de √≠tems listados actualmente para vender en el mercado.</span>\n          </div></th>\n          <td><div class="dato-item-info">${marketData.sell_quantity??"-"}</div></td>\n        </tr>\n        <tr>\n          <th><div class="dato-item tooltip-modern">Disponibles para comprar\n            <span class="tooltiptext-modern">Cantidad total de √≠tems que los compradores buscan adquirir en el mercado.</span>\n          </div></th>\n          <td><div class="dato-item-info">${marketData.buy_quantity??"-"}</div></td>\n        </tr>\n      </table>\n      <section id="ventas-compras" class="bloque-section">\n        <h3>Ventas y Compras Recientes</h3>\n        <table class="table-modern">\n          <tr><th></th><th style="text-align:center;">1 d√≠a</th><th style="text-align:center;">2 d√≠as</th><th style="text-align:center;">7 d√≠as</th><th style="text-align:center;">1 mes</th></tr>\n          <tr>\n            <th><div class="dato-item tooltip-modern">Ventas\n                <span class="tooltiptext-modern">Cantidad de √≠tems comprados directamente en el periodo (actividad de salida del mercado).</span>\n                </div>\n            </th>\n            <td><div class="dato-item-info">${marketData["1d_sell_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${marketData["2d_sell_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${marketData["7d_sell_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${marketData["1m_sell_sold"]??"-"}</div></td>\n          </tr>\n          <tr>\n            <th><div class="dato-item tooltip-modern">Compras\n                <span class="tooltiptext-modern">Cantidad de √≠tems vendidos directamente en el periodo (actividad de entrada al mercado).</span>\n                </div></th>\n            <td><div class="dato-item-info">${marketData["1d_buy_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${marketData["2d_buy_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${marketData["7d_buy_sold"]??"-"}</div></td>\n            <td><div class="dato-item-info">${marketData["1m_buy_sold"]??"-"}</div></td>\n          </tr>\n          <tr><td colspan="5" style="color:#888;font-size:0.95em;">* Basado en actividad reciente.</td></tr>\n        </table>\n      </section>\n      <section id="porcentajes-rotacion" class="bloque-section">\n        <h3>Porcentajes de Rotaci√≥n</h3>\n        <table class="table-modern">\n          <tr><th></th><th style="text-align:center;">1 d√≠a</th><th style="text-align:center;">2 d√≠as</th><th style="text-align:center;">7 d√≠as</th><th style="text-align:center;">1 mes</th></tr>\n          <tr>\n            <th><div class="dato-item tooltip-modern">Ventas/Supply\n                <span class="tooltiptext-modern">Porcentaje de √≠tems comprados directamente respecto al total disponible (rotaci√≥n de inventario en el mercado).</span>\n                </div></th>\n            <td><div class="dato-item-info">${calcPercent(marketData["1d_sell_sold"],marketData.sell_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(marketData["2d_sell_sold"],marketData.sell_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(marketData["7d_sell_sold"],marketData.sell_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(marketData["1m_sell_sold"],marketData.sell_quantity)}</div></td>\n          </tr>\n          <tr>\n            <th><div class="dato-item tooltip-modern">Compras/Demand\n                <span class="tooltiptext-modern">Porcentaje de √≠tems vendidos directamente respecto a la demanda total (flujo de entrada al mercado).</span>\n                </div></th>\n            <td><div class="dato-item-info">${calcPercent(marketData["1d_buy_sold"],marketData.buy_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(marketData["2d_buy_sold"],marketData.buy_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(marketData["7d_buy_sold"],marketData.buy_quantity)}</div></td>\n            <td><div class="dato-item-info">${calcPercent(marketData["1m_buy_sold"],marketData.buy_quantity)}</div></td>\n          </tr>\n          <tr><td colspan="5" style="color:#888;font-size:0.95em;">* Basado en actividad reciente comparada con la cantidad disponible.</td></tr>\n        </table>\n      </section>\n  `}